<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 102107 -->
<!-- Generated: 2025-08-24T21-13-57-640Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation for Chat SDK room lifecycle error with comprehensive recovery guidance and clear state management explanation -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 102107: Room invalid state

## What Happened

The Chat SDK cannot perform the requested operation because the chat room is not in the correct state for that operation.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 102107 | 400/500 | Client Error (Chat SDK) | No - requires fixing room state |

## Quick Fix

- Ensure the room is attached before performing presence operations
- Wait for room to reach ATTACHED state before operations
- Check room.status before attempting any presence operations

## Error Messages

You may see one of these messages:
- "Can't perform operation; the room '{roomName}' is in an invalid state: {roomStatus}"
- "The room operation failed because the room was in an invalid state."
- "To perform this {feature} operation, you must first attach the room."

The `{roomName}` shows the specific room identifier, `{roomStatus}` shows the current room state (e.g., INITIALIZED, SUSPENDED, FAILED), and `{feature}` indicates the operation type (typically "presence").

## Common Causes

1. **Room not attached** (80% of cases)
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 89-93 -->
   - Attempting presence operations before calling room.attach()
   - Room is in INITIALIZED state (never attached)
   - Forgot to attach room after getting it from rooms collection

2. **Room state transition failure** (15% of cases)
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 29-35 -->
   - Room was ATTACHING but transitioned to non-ATTACHED state
   - Network interruption during attachment process
   - Authentication failure during room attachment

3. **Room in terminal state** (5% of cases)
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 48-51 -->
   - Room is in FAILED state from previous error
   - Room is SUSPENDED after prolonged disconnection
   - Room requires reinitialization to recover

## Resolution Steps

1. **Attach the room before any operations**
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 112-113 -->
   ```kotlin
   // Kotlin/Android
   val room = chatClient.rooms.get(roomId)
   
   // Attach room first
   room.attach()
   
   // Now safe to perform presence operations
   room.presence.enter()
   ```
   
   ```swift
   // Swift/iOS
   let room = chatClient.rooms.get(roomID: roomId)
   
   // Attach room first
   try await room.attach()
   
   // Now safe to perform presence operations
   try await room.presence.enter()
   ```

2. **Check room status before operations**
   <!-- Source: Code pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-knowledge.md lines 179-184 -->
   ```kotlin
   // Kotlin/Android
   if (room.status == RoomStatus.ATTACHED) {
       // Safe to perform operations
       room.presence.update(userData)
   } else {
       // Attach first
       room.attach()
       // Then perform operation
       room.presence.update(userData)
   }
   ```
   
   ```swift
   // Swift/iOS
   if room.status == .attached {
       // Safe to perform operations
       try await room.presence.update(userData)
   } else {
       // Attach first
       try await room.attach()
       // Then perform operation
       try await room.presence.update(userData)
   }
   ```

3. **Handle state transition failures gracefully**
   <!-- Source: Recovery strategy from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 114-116 -->
   ```swift
   // Swift/iOS
   do {
       try await room.presence.enter()
   } catch {
       if let ablyError = error as? ARTErrorInfo,
          ablyError.code == 102107 {
           // Room not attached - attach and retry
           try await room.attach()
           try await room.presence.enter()
       }
   }
   ```
   
   ```kotlin
   // Kotlin/Android
   try {
       room.presence.enter()
   } catch (e: AblyException) {
       if (e.errorInfo.code == 102107) {
           // Room not attached - attach and retry
           room.attach()
           room.presence.enter()
       }
   }
   ```

4. **Monitor room status changes**
   <!-- Source: Analysis recommendation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md line 116 -->
   Subscribe to room status changes to track state transitions and ensure operations only occur when the room is properly attached. This proactive approach prevents the error from occurring.

## Automatic Handling

The Chat SDK does not automatically retry this error. Room attachment is an explicit operation that must be initiated by your application. Once attached, the room will maintain its state unless explicitly detached or a terminal error occurs.

## Code Examples

### Complete Room Initialization Pattern
<!-- Code source: Derived from SDK patterns in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md, included because essential for demonstrating proper room lifecycle management -->
```kotlin
// Kotlin/Android - Proper room initialization
class ChatRoomManager {
    suspend fun joinRoom(roomId: String, userData: Map<String, Any>) {
        val room = chatClient.rooms.get(roomId)
        
        // Always attach before operations
        room.attach()
        
        // Now safe to enter presence
        room.presence.enter(userData)
        
        // Subscribe to messages
        room.messages.subscribe { message ->
            handleMessage(message)
        }
    }
}
```

```swift
// Swift/iOS - Proper room initialization
class ChatRoomManager {
    func joinRoom(roomID: String, userData: [String: Any]) async throws {
        let room = chatClient.rooms.get(roomID: roomID)
        
        // Always attach before operations
        try await room.attach()
        
        // Now safe to enter presence
        try await room.presence.enter(userData: userData)
        
        // Subscribe to messages
        room.messages.subscribe { message in
            self.handleMessage(message)
        }
    }
}
```

## Prevention

- **Always attach rooms explicitly**: Call `room.attach()` immediately after getting a room reference
- **Implement status monitoring**: Subscribe to room status changes to track state transitions
- **Use try-catch blocks**: Wrap all presence operations in proper error handling
- **Check room state**: Verify room.status == ATTACHED before presence operations
- **Handle reconnection**: Re-attach rooms after connection recovery if needed

## Performance Impact

This error indicates a logic issue rather than a performance problem. However, repeatedly encountering this error suggests inefficient room lifecycle management that could impact:
- User experience with failed presence updates
- Increased latency from retry attempts
- Unnecessary network requests from improper sequencing

## Related Resources

- [Ably Chat Rooms documentation](https://ably.com/docs/chat/rooms)
- [Chat Presence documentation](https://ably.com/docs/chat/rooms/presence)
- [Chat SDK Getting Started - Kotlin](https://ably.com/docs/chat/getting-started/kotlin)
- [Chat SDK Getting Started - JavaScript](https://ably.com/docs/chat/getting-started/javascript)

## Related Errors

• **[80000 - Connection Failed](https://help.ably.io/error/80000)**  
  Underlying connection failure that can prevent room attachment

• **[90000 - Channel Operation Failed](https://help.ably.io/error/90000)**  
  General channel operation failure that may affect room state

• **[91001 - Unable to Enter Presence](https://help.ably.io/error/91001)**  
  Related presence operation failure when client ID is not configured

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 102107
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED:
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 102107)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/102107-room-invalid-state.mdx (enhanced from existing)
-->

<!-- URL Validation Completed: 2025-08-24T21-13-57-640Z -->
<!-- External URLs verified: 5 | Corrected: 0 | Exempted internal: 2 -->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: No existing FAQ content found (redirected to unknown error page per knowledge file)
- Content Excluded: None - all relevant information included
- Recommendations Source: 
  - Room attachment requirement: Based on analysis file lines 89-93, 112-113
  - State checking: Based on knowledge file pattern lines 179-184  
  - Error handling: Based on knowledge file code examples lines 186-209
  - Status monitoring: Based on analysis file line 116
- Code Examples Rationale: Included comprehensive examples because research shows specific code patterns are essential for proper room lifecycle management and error prevention
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Room not attached): Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 89-93 and test coverage lines 88-92
  - Cause 2 (State transition): From SDK implementation at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 29-35
  - Cause 3 (Terminal state): From analysis at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 48-51
- Resolution Steps: 
  - Step 1: Source from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 112-113 - explicit room attachment requirement
  - Step 2: Code pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-knowledge.md lines 179-184 - state checking before operations
  - Step 3: Error handling from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-knowledge.md lines 198-209 - Swift error recovery pattern
  - Step 4: Based on https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md line 116 - proactive status monitoring
- Prevention: Based on analysis recommendations in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/102107-analysis.md lines 112-116 and test patterns
- Code Examples: Derived from SDK implementation patterns and test cases documented in analysis file
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Comprehensive Chat SDK room lifecycle state diagram
- Missing: Detailed error recovery patterns for Chat SDK
- Impact: Developers may not understand valid state transitions and recovery strategies
- Recommendation: Create visual state diagrams and comprehensive error handling guide for Chat SDK
- Severity: Medium - Chat SDK is relatively new and developers need clear lifecycle guidance
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 102107
2. Regenerate: Run `./bin/ably-os errors document-error-codes 102107 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->