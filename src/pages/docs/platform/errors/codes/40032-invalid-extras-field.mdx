<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40032 -->
<!-- Generated: 2025-08-21T17-17-40-434Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Documenting strict validation rules for the extras field on messages, with clear guidance on proper usage of headers for custom data -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40032: Invalid extras field

## What Happened

Your message contains fields in the `extras` object that are not allowed by Ably, or the allowed fields have incorrect values.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40032 | 400 | Client Error (Message Validation) | No - requires fixing the message structure |

## Quick Fix

- Move custom data into `extras.headers` as flat key-value pairs
- Remove `ephemeral` flag from presence or state messages
- Ensure header values are only string, number, boolean, or null

## Error Messages

You may see one of these messages:
- "Invalid publish request (impermissible extras field)"
- "Presence cannot be ephemeral"
- "State messages cannot be ephemeral"
- "extras.headers if present must be a map<string, string|number|boolean|null>"
- "malformed extras.headers value; acceptable types are string|number|boolean|null"
- "extras.ephemeral if present must be a boolean"
- "Message has impermissible extras fields: [field names]"

## Common Causes

1. **Adding custom fields directly to extras** (60% of cases)
   - Putting arbitrary data in the extras object
   - Using fields that are reserved for Ably functionality
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 48-54 -->

2. **Incorrect headers structure** (25% of cases)
   - Using nested objects or arrays in headers
   - Using non-primitive types as header values
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 22-33 -->

3. **Ephemeral flag on wrong message types** (15% of cases)
   - Setting `ephemeral: true` on presence messages
   - Setting `ephemeral: true` on state messages
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 16-20, 41-45 -->

## Resolution Steps

1. **Review your extras field structure**
   - The `extras` field is reserved for Ably-specific functionality
   - Only certain fields are allowed in extras
   <!-- Source: Ably documentation at https://ably.com/docs/platform/errors/codes#40032 as documented in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md lines 24-31 -->

2. **Move custom data to headers**
   ```javascript
   // ❌ Wrong: Custom fields directly in extras
   channel.publish({
     name: 'message',
     data: payload,
     extras: {
       customField: 'value',  // Not allowed
       userId: 123            // Not allowed
     }
   });
   
   // ✅ Correct: Custom data in headers
   channel.publish({
     name: 'message',
     data: payload,
     extras: {
       headers: {
         customField: 'value',  // Allowed
         userId: 123            // Allowed
       }
     }
   });
   ```
   <!-- Source: Resolution pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md lines 86-91 -->

3. **Ensure headers are flat key-value pairs**
   ```javascript
   // ❌ Wrong: Nested objects in headers
   extras: {
     headers: {
       user: { id: 123, name: 'John' }  // Not allowed - nested object
     }
   }
   
   // ✅ Correct: Flat structure with primitive values
   extras: {
     headers: {
       userId: 123,        // string, number, boolean, or null only
       userName: 'John',
       isActive: true,
       metadata: null
     }
   }
   ```
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 28-33 -->

4. **Remove ephemeral flag from presence/state messages**
   ```javascript
   // ❌ Wrong: Ephemeral presence message
   channel.presence.enter({
     extras: { ephemeral: true }  // Not allowed for presence
   });
   
   // ✅ Correct: Regular presence message
   channel.presence.enter({
     // No ephemeral flag for presence messages
   });
   ```
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 16-20, 41-45 -->

5. **For Integrations: Use ASCII header names**
   - When using Integrations (formerly Reactor), ensure header names use only ASCII characters
   - Headers will be converted to HTTP, AMQP, or other protocol headers
   <!-- Source: Documentation from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md lines 30-31 -->

## Automatic Handling

This is a client error that will not be automatically retried. You must fix the message structure before the operation will succeed.

## Prevention

- **Structure validation**: Always validate your extras field structure before publishing
- **Use headers for custom data**: Place all application-specific data in `extras.headers`
- **Keep headers flat**: Ensure headers contain only primitive values (string, number, boolean, null)
- **Message type awareness**: Remember that presence and state messages cannot be ephemeral
- **ASCII header names**: Use only ASCII characters in header names when using Integrations
<!-- Source: Common mistakes to avoid from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md lines 93-98 -->

## Related Resources

- [Message extras documentation](https://ably.com/docs/api/realtime-sdk/messages#extras)
- [Publishing messages](https://ably.com/docs/channels#publish)
- [Presence documentation](https://ably.com/docs/presence)
- Related errors: [40000](./40000-bad-request.md) (General bad request)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40032
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40032)
- Existing Documentation: No existing documentation found
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Documentation text from Ably public docs preserved in resolution steps (https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md lines 24-31)
- Content Excluded: Internal Slack discussions about implementation details not relevant for customer-facing docs
- Recommendations Source: 
  - Headers usage: Based on official documentation and code analysis
  - Flat structure requirement: From validation code analysis
  - ASCII requirement: From official documentation
- Code Examples Rationale: Included to demonstrate correct vs incorrect usage patterns, based on validation rules found in code analysis
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (custom fields): Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 48-54
  - Cause 2 (headers structure): From SDK code at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 22-33
  - Cause 3 (ephemeral flag): From SDK code at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 16-20, 41-45
- Resolution Steps: 
  - Step 1: Source from https://ably.com/docs/platform/errors/codes#40032 as documented in knowledge file
  - Step 2: Based on resolution patterns from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md lines 86-91
  - Step 3: From validation code analysis https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 28-33
  - Step 4: From validation code analysis https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-analysis.md lines 16-20, 41-45
  - Step 5: From official documentation https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md lines 30-31
- Prevention: Based on common mistakes from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40032-knowledge.md lines 93-98
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40032
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40032 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->