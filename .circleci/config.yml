version: 2.1

orbs:
  node: circleci/node@5.0.0

parameters:
  content-update:
    type: boolean
    default: false

commands:
  restore-npm-cache:
    steps:
      - restore_cache:
          name: Restore NPM Package Cache
          keys:
            - npm-packages-v1-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - npm-packages-v1-{{ .Branch }}-
            - npm-packages-v1-

  save-npm-cache:
    steps:
      - save_cache:
          name: Save NPM Package Cache
          key: npm-packages-v1-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.cache/npm

  npm-install:
    steps:
      - run:
          name: Dependencies
          command: npm ci --prefer-offline --cache ~/.cache/npm

jobs:
  install-dependencies:
    executor:
      name: node/default
      tag: 16.1.0
    resource_class: medium+
    steps:
      - checkout
      - restore-npm-cache
      - npm-install
      - persist_to_workspace:
          root: .
          paths:
            - node_modules
      - save-npm-cache

  test:
    executor:
      name: node/default
      tag: 16.14.0
    resource_class: small
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Run linting
          command: npm run lint
      - run:
          name: Run tests
          command: npm test -- --json --outputFile=output.json
      - store_test_results:
          path: ./output.json

workflows:
  test_branch:
    unless: << pipeline.parameters.content-update >>
    jobs:
      - install-dependencies
      - test:
          requires:
            - install-dependencies
