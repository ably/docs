<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Swift Translation Review</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }

    .sticky-nav {
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .header {
      background: #1a1a2e;
      color: white;
      padding: 1rem 2rem;
    }

    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .header-meta {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .summary-bar {
      display: flex;
      gap: 2rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    .summary-stat {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .summary-stat .count {
      font-weight: 700;
      font-size: 1.25rem;
    }

    .summary-stat .label {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .stat-pass { color: #4ade80; }
    .stat-fail { color: #f87171; }
    .stat-pending { color: #fbbf24; }
    .stat-approved { color: #60a5fa; }

    .controls {
      background: white;
      padding: 1rem 2rem;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .filter-group label {
      font-size: 0.85rem;
      font-weight: 500;
      color: #666;
    }

    .filter-btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s;
    }

    .filter-btn:hover {
      border-color: #999;
    }

    .filter-btn.active {
      background: #1a1a2e;
      color: white;
      border-color: #1a1a2e;
    }

    .export-btn {
      margin-left: auto;
      padding: 0.5rem 1rem;
      background: #1a1a2e;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .export-btn:hover {
      background: #2a2a4e;
    }

    .main {
      padding: 2rem;
      max-width: 1600px;
      margin: 0 auto;
    }

    .file-section {
      margin-bottom: 2rem;
    }

    .file-header {
      font-size: 1rem;
      font-weight: 600;
      color: #1a1a2e;
      margin-bottom: 1rem;
      padding: 0.5rem 0;
      border-bottom: 2px solid #1a1a2e;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .file-header a {
      color: inherit;
      text-decoration: none;
    }

    .file-header a:hover {
      text-decoration: underline;
    }

    .example-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .example-card.review-approved {
      border-left: 4px solid #4ade80;
    }

    .example-card.review-flagged {
      border-left: 4px solid #f87171;
    }

    .example-card.collapsed .example-body {
      display: none;
    }

    .example-card.collapsed .example-header {
      border-bottom: none;
    }

    .example-header {
      padding: 1rem;
      background: #fafafa;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .example-header:hover {
      background: #f0f0f0;
    }

    .example-header .collapse-indicator {
      margin-right: 0.5rem;
      color: #999;
      transition: transform 0.2s;
    }

    .example-card.collapsed .collapse-indicator {
      transform: rotate(-90deg);
    }

    .example-location {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.85rem;
      color: #666;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .example-id {
      background: #e5e7eb;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
      font-size: 0.75rem;
      color: #374151;
    }

    .example-location a {
      color: #2563eb;
      text-decoration: none;
    }

    .example-location a:hover {
      text-decoration: underline;
    }

    .example-badges {
      display: flex;
      gap: 0.5rem;
    }

    .badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .badge-pass {
      background: #dcfce7;
      color: #166534;
    }

    .badge-fail {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-faithful {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-minor {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-deviation {
      background: #fee2e2;
      color: #991b1b;
    }

    .code-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    @media (max-width: 1000px) {
      .code-comparison {
        grid-template-columns: 1fr;
      }
    }

    .code-panel {
      border-right: 1px solid #eee;
      overflow: hidden;
    }

    .code-panel:last-child {
      border-right: none;
    }

    .code-panel-header {
      padding: 0.5rem 1rem;
      background: #f0f0f0;
      font-size: 0.8rem;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .copy-btn {
      padding: 0.25rem 0.5rem;
      background: white;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 0.7rem;
      cursor: pointer;
      opacity: 0.7;
    }

    .copy-btn:hover {
      opacity: 1;
    }

    .code-panel pre {
      margin: 0;
      padding: 1rem;
      overflow-x: auto;
      font-size: 0.85rem;
      line-height: 1.5;
      overflow-y: auto;
    }

    .code-comparison-wrapper {
      position: relative;
    }

    .code-comparison-wrapper .code-panel pre {
      height: 300px;
      max-height: none;
    }

    .resize-handle {
      height: 8px;
      background: #e0e0e0;
      cursor: ns-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .resize-handle:hover {
      background: #d0d0d0;
    }

    .resize-handle.dragging {
      background: #2563eb;
    }

    .resize-handle::after {
      content: '';
      width: 40px;
      height: 4px;
      background: #999;
      border-radius: 2px;
    }

    .resize-handle:hover::after {
      background: #666;
    }

    .resize-handle.dragging::after {
      background: white;
    }

    .code-panel code {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    }

    .details-section {
      border-top: 1px solid #eee;
    }

    .details-toggle {
      width: 100%;
      padding: 0.75rem 1rem;
      background: #fafafa;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: #666;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .details-toggle:hover {
      background: #f0f0f0;
    }

    .details-toggle .arrow {
      transition: transform 0.2s;
    }

    .details-toggle.open .arrow {
      transform: rotate(90deg);
    }

    .details-content {
      display: none;
      padding: 1rem;
      background: #fafafa;
    }

    .details-content.open {
      display: block;
    }

    .notes-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .notes-list li {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .note-decision {
      background: #dbeafe;
      border-left: 3px solid #2563eb;
    }

    .note-deviation {
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
    }

    .note-info {
      background: #f3f4f6;
      border-left: 3px solid #6b7280;
    }

    .note-warning {
      background: #fee2e2;
      border-left: 3px solid #ef4444;
    }

    .harness-code {
      background: #1e1e1e;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .harness-code pre {
      margin: 0;
      padding: 1rem;
      font-size: 0.8rem;
      overflow-x: auto;
    }

    .verification-details {
      font-size: 0.85rem;
      color: #666;
    }

    .verification-details p {
      margin: 0.5rem 0;
    }

    .error-message {
      background: #fee2e2;
      padding: 0.75rem;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.8rem;
      color: #991b1b;
      white-space: pre-wrap;
      margin-top: 0.5rem;
    }

    .review-actions {
      padding: 1rem;
      background: #fafafa;
      border-top: 1px solid #eee;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .review-btn {
      padding: 0.5rem 1rem;
      border: 2px solid;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.15s;
      background: white;
    }

    .review-btn-approve {
      border-color: #4ade80;
      color: #166534;
    }

    .review-btn-approve:hover, .review-btn-approve.active {
      background: #4ade80;
      color: white;
    }

    .review-btn-flag {
      border-color: #f87171;
      color: #991b1b;
    }

    .review-btn-flag:hover, .review-btn-flag.active {
      background: #f87171;
      color: white;
    }

    .review-btn-skip {
      border-color: #d1d5db;
      color: #6b7280;
    }

    .review-btn-skip:hover, .review-btn-skip.active {
      background: #d1d5db;
      color: #374151;
    }

    .review-comment {
      flex: 1;
      min-width: 200px;
    }

    .review-comment input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .review-comment input:focus {
      outline: none;
      border-color: #2563eb;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }

    .empty-state h2 {
      margin-bottom: 1rem;
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .modal-body {
      padding: 1rem;
    }

    .export-section {
      margin-bottom: 1rem;
    }

    .export-section h3 {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .export-textarea {
      width: 100%;
      height: 150px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.8rem;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }

    .progress-bar {
      width: 150px;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #4ade80;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="sticky-nav">
    <div class="header">
      <h1>Swift Translation Review</h1>
      <div class="header-meta" id="header-meta">Loading...</div>
      <div class="summary-bar" id="summary-bar"></div>
    </div>

    <div class="controls">
    <div class="filter-group">
      <label>Filter:</label>
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="pending">Pending</button>
      <button class="filter-btn" data-filter="approved">Approved</button>
      <button class="filter-btn" data-filter="flagged">Flagged</button>
    </div>
    <div class="filter-group">
      <label>Verification:</label>
      <button class="filter-btn" data-filter="compilation-fail">Compilation Failed</button>
      <button class="filter-btn" data-filter="deviation">Deviations</button>
    </div>
    <div class="filter-group">
      <label>Progress:</label>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <span id="progress-text" style="font-size: 0.85rem; color: #666;">0/0</span>
    </div>
    <button class="export-btn" id="export-btn">Export Summary</button>
    </div>
  </div>

  <div class="main" id="main">
    <div class="loading">Loading translation data...</div>
  </div>

  <div class="modal-overlay" id="export-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Export Review Summary</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-swift.min.js"></script>

  <!-- TRANSLATION_DATA_PLACEHOLDER -->

  <script>
    // State
    let data = null;
    let reviewState = {};
    let currentFilter = 'all';

    // Storage key - include a hash of the data to separate review states for different translation runs
    function getStorageKey() {
      if (!data) return 'swift-translation-review-state';
      // Use generatedAt as a simple unique identifier for this translation run
      return `swift-translation-review-${data.generatedAt}`;
    }

    // Load review state from localStorage
    function loadReviewState() {
      try {
        const saved = localStorage.getItem(getStorageKey());
        if (saved) {
          reviewState = JSON.parse(saved);
        }
      } catch (e) {
        console.error('Failed to load review state:', e);
      }
    }

    // Save review state to localStorage
    function saveReviewState() {
      try {
        localStorage.setItem(getStorageKey(), JSON.stringify(reviewState));
      } catch (e) {
        console.error('Failed to save review state:', e);
      }
    }

    // Get review status for an example
    function getReviewStatus(id) {
      return reviewState[id] || { status: 'pending', comment: '' };
    }

    // Set review status for an example
    function setReviewStatus(id, status, comment = '') {
      reviewState[id] = { status, comment };
      saveReviewState();
      updateUI();
    }

    // Load data - check for embedded data first, then try fetch
    async function loadData() {
      // Check for embedded data (injected by the skill)
      if (typeof TRANSLATION_DATA !== 'undefined') {
        data = TRANSLATION_DATA;
        loadReviewState();
        render();
        return;
      }

      // Fall back to fetching JSON file (for development/testing with a local server)
      try {
        const response = await fetch('translation-data.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        data = await response.json();
        loadReviewState();
        render();
      } catch (e) {
        document.getElementById('main').innerHTML = `
          <div class="empty-state">
            <h2>No translation data found</h2>
            <p>This review app expects data to be embedded by the translation skill.</p>
            <p>If you're testing locally, run a local server and provide <code>translation-data.json</code>.</p>
            <p style="color: #999; font-size: 0.85rem;">Error: ${e.message}</p>
          </div>
        `;
      }
    }

    // Render the UI
    function render() {
      if (!data) return;

      // Update header
      const date = new Date(data.generatedAt);
      document.getElementById('header-meta').textContent =
        `Generated ${date.toLocaleDateString()} at ${date.toLocaleTimeString()} · ${data.summary.filesProcessed} files · ${data.summary.examplesTranslated} examples`;

      // Update summary bar
      updateSummaryBar();

      // Render examples
      renderExamples();

      // Update progress
      updateProgress();
    }

    function updateSummaryBar() {
      const counts = getCounts();
      document.getElementById('summary-bar').innerHTML = `
        <div class="summary-stat">
          <span class="count stat-pass">${data.summary.compilationPassed}</span>
          <span class="label">Compiled</span>
        </div>
        <div class="summary-stat">
          <span class="count stat-fail">${data.summary.compilationFailed}</span>
          <span class="label">Failed</span>
        </div>
        <div class="summary-stat">
          <span class="count stat-approved">${counts.approved}</span>
          <span class="label">Approved</span>
        </div>
        <div class="summary-stat">
          <span class="count stat-fail">${counts.flagged}</span>
          <span class="label">Flagged</span>
        </div>
        <div class="summary-stat">
          <span class="count stat-pending">${counts.pending}</span>
          <span class="label">Pending</span>
        </div>
      `;
    }

    function getCounts() {
      let approved = 0, flagged = 0, pending = 0;
      for (const file of data.files) {
        for (const example of file.examples) {
          const status = getReviewStatus(example.id).status;
          if (status === 'approved') approved++;
          else if (status === 'flagged') flagged++;
          else pending++;
        }
      }
      return { approved, flagged, pending };
    }

    function updateProgress() {
      const counts = getCounts();
      const total = data.summary.examplesTranslated;
      const reviewed = counts.approved + counts.flagged;
      const percent = total > 0 ? (reviewed / total) * 100 : 0;

      document.getElementById('progress-fill').style.width = `${percent}%`;
      document.getElementById('progress-text').textContent = `${reviewed}/${total}`;
    }

    function shouldShowExample(example) {
      const review = getReviewStatus(example.id);

      switch (currentFilter) {
        case 'all':
          return true;
        case 'pending':
          return review.status === 'pending';
        case 'approved':
          return review.status === 'approved';
        case 'flagged':
          return review.status === 'flagged';
        case 'compilation-fail':
          return example.verification.compilation.status === 'fail';
        case 'deviation':
          return example.verification.faithfulness.rating === 'significant_deviation' ||
                 example.verification.faithfulness.rating === 'minor_differences';
        default:
          return true;
      }
    }

    function renderExamples() {
      const main = document.getElementById('main');
      let html = '';

      for (const file of data.files) {
        const visibleExamples = file.examples.filter(shouldShowExample);
        if (visibleExamples.length === 0) continue;

        html += `
          <div class="file-section">
            <div class="file-header">
              <a href="vscode://file/${encodeURIComponent(file.path)}">${file.path}</a>
            </div>
        `;

        for (const example of visibleExamples) {
          html += renderExampleCard(example, file.path);
        }

        html += '</div>';
      }

      if (!html) {
        html = `
          <div class="empty-state">
            <h2>No examples match this filter</h2>
            <p>Try a different filter or check that translations exist.</p>
          </div>
        `;
      }

      main.innerHTML = html;

      // Apply syntax highlighting
      Prism.highlightAll();

      // Attach event listeners
      attachEventListeners();
    }

    function renderExampleCard(example, filePath) {
      const review = getReviewStatus(example.id);
      const cardClass = review.status !== 'pending' ? `review-${review.status}` : '';
      const collapsedClass = review.status !== 'pending' ? 'collapsed' : '';

      const compilationBadge = example.verification.compilation.status === 'pass'
        ? '<span class="badge badge-pass">Compiled</span>'
        : '<span class="badge badge-fail">Failed</span>';

      const faithfulnessMap = {
        'faithful': '<span class="badge badge-faithful">Faithful</span>',
        'minor_differences': '<span class="badge badge-minor">Minor Differences</span>',
        'significant_deviation': '<span class="badge badge-deviation">Deviation</span>',
        'not_assessed': ''
      };
      const faithfulnessBadge = faithfulnessMap[example.verification.faithfulness.rating] || '';

      const vsCodeUrl = `vscode://file/${encodeURIComponent(filePath)}:${example.lineNumber}`;

      const notesHtml = example.translationNotes && example.translationNotes.length > 0
        ? `
          <div class="details-section">
            <button class="details-toggle open" data-target="notes-${example.id}">
              <span class="arrow">▶</span> Translation Notes (${example.translationNotes.length})
            </button>
            <div class="details-content open" id="notes-${example.id}">
              <ul class="notes-list">
                ${example.translationNotes.map(note => `
                  <li class="note-${note.type}">${escapeHtml(note.message)}</li>
                `).join('')}
              </ul>
            </div>
          </div>
        `
        : '';

      const harnessHtml = `
        <div class="details-section">
          <button class="details-toggle" data-target="harness-${example.id}">
            <span class="arrow">▶</span> Test Harness Context
          </button>
          <div class="details-content" id="harness-${example.id}">
            <div><strong>Function signature:</strong></div>
            <div class="harness-code">
              <pre><code class="language-swift">${escapeHtml(example.harness.functionSignature)}</code></pre>
            </div>
            ${example.harness.stubTypes ? `
              <div style="margin-top: 0.5rem;"><strong>Stub types:</strong></div>
              <div class="harness-code">
                <pre><code class="language-swift">${escapeHtml(example.harness.stubTypes)}</code></pre>
              </div>
            ` : ''}
            ${example.harness.fullContext ? `
              <div style="margin-top: 0.5rem;"><strong>Full context:</strong></div>
              <div class="harness-code">
                <pre><code class="language-swift">${escapeHtml(example.harness.fullContext)}</code></pre>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      const verificationHtml = `
        <div class="details-section">
          <button class="details-toggle open" data-target="verification-${example.id}">
            <span class="arrow">▶</span> Verification Details
          </button>
          <div class="details-content open" id="verification-${example.id}">
            <div class="verification-details">
              <p><strong>Compilation:</strong> ${example.verification.compilation.status.toUpperCase()}</p>
              ${example.verification.compilation.errorMessage ? `
                <div class="error-message">${escapeHtml(example.verification.compilation.errorMessage)}</div>
              ` : ''}
              <p><strong>Faithfulness:</strong> ${example.verification.faithfulness.rating.replace('_', ' ').toUpperCase()}</p>
              ${example.verification.faithfulness.notes ? `
                <p>${escapeHtml(example.verification.faithfulness.notes)}</p>
              ` : ''}
            </div>
          </div>
        </div>
      `;

      return `
        <div class="example-card ${cardClass} ${collapsedClass}" data-id="${example.id}">
          <div class="example-header" data-id="${example.id}">
            <span class="example-location">
              <span class="collapse-indicator">▼</span>
              <span class="example-id">${escapeHtml(example.id)}</span>
              <a href="${vsCodeUrl}" onclick="event.stopPropagation()">Line ${example.lineNumber}</a>
            </span>
            <div class="example-badges">
              ${compilationBadge}
              ${faithfulnessBadge}
            </div>
          </div>

          <div class="example-body">
            <div class="code-comparison-wrapper" data-id="${example.id}">
              <div class="code-comparison">
                <div class="code-panel">
                  <div class="code-panel-header">
                    <span>JavaScript (Original)</span>
                    <button class="copy-btn" data-code="${encodeURIComponent(example.original.code)}">Copy</button>
                  </div>
                  <pre><code class="language-javascript">${escapeHtml(example.original.code)}</code></pre>
                </div>
                <div class="code-panel">
                  <div class="code-panel-header">
                    <span>Swift (Translation)</span>
                    <button class="copy-btn" data-code="${encodeURIComponent(example.translation.code)}">Copy</button>
                  </div>
                  <pre><code class="language-swift">${escapeHtml(example.translation.code)}</code></pre>
                </div>
              </div>
              <div class="resize-handle" data-id="${example.id}"></div>
            </div>

            ${harnessHtml}
            ${notesHtml}
            ${verificationHtml}

            <div class="review-actions">
              <button class="review-btn review-btn-approve ${review.status === 'approved' ? 'active' : ''}"
                      data-id="${example.id}" data-action="approved">
                ✓ Approve
              </button>
              <button class="review-btn review-btn-flag ${review.status === 'flagged' ? 'active' : ''}"
                      data-id="${example.id}" data-action="flagged">
                ✗ Flag
              </button>
              <button class="review-btn review-btn-skip ${review.status === 'pending' ? 'active' : ''}"
                      data-id="${example.id}" data-action="pending">
                Skip
              </button>
              <div class="review-comment">
                <input type="text" placeholder="Optional comment..."
                       data-id="${example.id}"
                       value="${escapeHtml(review.comment)}">
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function attachEventListeners() {
      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderExamples();
        });
      });

      // Details toggles
      document.querySelectorAll('.details-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.getElementById(btn.dataset.target);
          btn.classList.toggle('open');
          target.classList.toggle('open');
        });
      });

      // Copy buttons
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const code = decodeURIComponent(btn.dataset.code);
          await navigator.clipboard.writeText(code);
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = originalText, 1500);
        });
      });

      // Review buttons
      document.querySelectorAll('.review-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const comment = document.querySelector(`input[data-id="${id}"]`)?.value || '';
          setReviewStatus(id, action, comment);

          // Collapse the card after taking action
          const card = document.querySelector(`.example-card[data-id="${id}"]`);
          if (card) {
            card.classList.add('collapsed');
          }
        });
      });

      // Header click to toggle collapse
      document.querySelectorAll('.example-header').forEach(header => {
        header.addEventListener('click', () => {
          const card = header.closest('.example-card');
          card.classList.toggle('collapsed');
        });
      });

      // Comment inputs
      document.querySelectorAll('.review-comment input').forEach(input => {
        input.addEventListener('change', () => {
          const id = input.dataset.id;
          const current = getReviewStatus(id);
          setReviewStatus(id, current.status, input.value);
        });
      });

      // Resize handles
      document.querySelectorAll('.resize-handle').forEach(handle => {
        handle.addEventListener('mousedown', startResize);
      });
    }

    // Resize functionality
    let resizeState = null;

    function startResize(e) {
      const handle = e.target;
      const wrapper = handle.closest('.code-comparison-wrapper');
      const pres = wrapper.querySelectorAll('.code-panel pre');

      resizeState = {
        handle,
        wrapper,
        pres,
        startY: e.clientY,
        startHeight: pres[0].offsetHeight
      };

      handle.classList.add('dragging');
      document.body.style.cursor = 'ns-resize';
      document.body.style.userSelect = 'none';

      document.addEventListener('mousemove', doResize);
      document.addEventListener('mouseup', stopResize);
      e.preventDefault();
    }

    function doResize(e) {
      if (!resizeState) return;

      const delta = e.clientY - resizeState.startY;
      const newHeight = Math.max(100, Math.min(800, resizeState.startHeight + delta));

      resizeState.pres.forEach(pre => {
        pre.style.height = `${newHeight}px`;
      });
    }

    function stopResize() {
      if (resizeState) {
        resizeState.handle.classList.remove('dragging');
        resizeState = null;
      }
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      document.removeEventListener('mousemove', doResize);
      document.removeEventListener('mouseup', stopResize);
    }

    function updateUI() {
      updateSummaryBar();
      updateProgress();
      renderExamples();
    }

    // Export functionality
    document.getElementById('export-btn').addEventListener('click', () => {
      const modal = document.getElementById('export-modal');
      const body = document.getElementById('modal-body');

      const approved = [];
      const flagged = [];

      for (const file of data.files) {
        for (const example of file.examples) {
          const review = getReviewStatus(example.id);
          const item = {
            file: file.path,
            line: example.lineNumber,
            comment: review.comment
          };
          if (review.status === 'approved') approved.push(item);
          if (review.status === 'flagged') flagged.push(item);
        }
      }

      const counts = getCounts();

      const summaryText = `# Swift Translation Review Summary

Generated: ${new Date(data.generatedAt).toLocaleString()}
Files: ${data.summary.filesProcessed}
Examples: ${data.summary.examplesTranslated}

## Review Status
- Approved: ${counts.approved}
- Flagged: ${counts.flagged}
- Pending: ${counts.pending}

## Approved Translations
${approved.length === 0 ? 'None' : approved.map(a => `- ${a.file}:${a.line}${a.comment ? ` (${a.comment})` : ''}`).join('\n')}

## Flagged Items
${flagged.length === 0 ? 'None' : flagged.map(f => `- ${f.file}:${f.line}${f.comment ? ` - ${f.comment}` : ''}`).join('\n')}
`;

      body.innerHTML = `
        <div class="export-section">
          <h3>Review Summary (Markdown)</h3>
          <textarea class="export-textarea" readonly>${escapeHtml(summaryText)}</textarea>
        </div>
        <div class="export-section">
          <h3>Review State (JSON)</h3>
          <textarea class="export-textarea" readonly>${JSON.stringify(reviewState, null, 2)}</textarea>
        </div>
      `;

      modal.classList.add('open');
    });

    document.getElementById('modal-close').addEventListener('click', () => {
      document.getElementById('export-modal').classList.remove('open');
    });

    document.getElementById('export-modal').addEventListener('click', (e) => {
      if (e.target.id === 'export-modal') {
        document.getElementById('export-modal').classList.remove('open');
      }
    });

    // Initialize
    loadData();
  </script>
</body>
</html>
