<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40013 -->
<!-- Generated: 2025-08-24T21-13-57-640Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation for message encoding/decoding errors with comprehensive SDK-specific guidance and production issue patterns -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40013: Invalid message data or encoding

## What Happened

The SDK cannot encode or decode your message because the data type is unsupported or the encoding process failed.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40013 | 400 | Client Error (Message Processing) | No - requires fixing the data format |

## Quick Fix

- Ensure message data is a string, buffer, JSON-serializable object, or array
- For encrypted channels, verify cipher configuration is consistent across clients
- Consider marshalling complex data as JSON before publishing
- Check for race conditions with dynamically constructed channel names

## Error Messages

You may see one of these messages:
- "Data type is unsupported"
- "Invalid message data or encoding"
- "The single-argument form of publish() expects a message object or an array of message objects"
- "Map value data type is unsupported" (LiveObjects)
- "Invalid data type for 'base64' decoding"
- "Invalid data type for 'json' decoding"
- "Invalid data type for 'utf-8' decoding"
- "decrypt failed"
- "Error processing the {encoding} encoding, decoder returned '{error}'"
- "Invalid cipher message data; unexpected length: {}" (Rust)
- "unknown encoding: '{encoding}'"

## Common Causes

1. **Unsupported data types** (60% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 16-21, 89-92 -->
   - Publishing objects that aren't JSON-serializable
   - Using LiveObjects with unsupported value types
   - Passing wrong argument types to publish()
   - Platform-specific type mismatches (e.g., NSString vs NSData in iOS)

2. **Encryption/decryption failures** (30% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 37-50, 73-79 -->
   - Cipher configuration mismatch between clients
   - Decryption failures after channel idle periods
   - Race conditions with encryption key handling
   - Inconsistent encryption for presence vs message data

3. **Encoding chain failures** (10% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 60-83, 111-114 -->
   - Invalid base64 data
   - Malformed JSON strings
   - UTF-8 encoding of binary data
   - Cipher block alignment issues (Rust SDK)

## Resolution Steps

1. **Validate your message data type**
   <!-- Source: Official docs from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 28-31 -->
   
   Supported types vary by SDK:
   - **JavaScript**: String, Buffer, JSON-serializable objects/arrays
   - **Ruby**: String, Hash, Array, or nil
   - **iOS/macOS**: NSString, NSData, NSArray, NSDictionary
   - **Java**: String, byte[], JsonElement
   - **Rust**: Types that implement Serialize trait
   
   For complex objects, serialize to JSON first:
   ```javascript
   // ❌ Wrong: Publishing non-serializable object
   channel.publish('update', myComplexObject);
   
   // ✅ Correct: Serialize to JSON first
   channel.publish('update', JSON.stringify(myComplexObject));
   ```
   <!-- Code source: Based on resolution pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 30-31 -->

2. **Fix publish() method arguments** (JavaScript SDKs)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 28-36 -->
   
   ```javascript
   // ❌ Wrong: Invalid single argument
   channel.publish('not-a-message-object');
   
   // ✅ Correct: Use message object
   channel.publish({ name: 'event', data: 'payload' });
   
   // ✅ Correct: Or use name and data arguments
   channel.publish('event', 'payload');
   ```
   <!-- Code source: Based on error patterns from https://github.com/ably/ably-js/blob/main/src/common/lib/client/restchannel.ts#L97 -->

3. **Verify encryption configuration**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 37-50, 44-50 -->
   
   If using encrypted channels, ensure all clients use identical cipher configuration:
   ```javascript
   // All clients must use the same key and options
   const cipherKey = await generateKey();
   const channel = ably.channels.get('encrypted-channel', {
     cipher: { key: cipherKey }
   });
   
   // For dynamic channel names, memoize to avoid race conditions
   const channelName = getChannelName(); // Memoize this!
   const channel = ably.channels.get(channelName, { cipher: { key } });
   ```
   <!-- Code source: Based on production issue resolution from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 48-50 -->

4. **Handle LiveObjects data types**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 38-43 -->
   
   For LiveObjects, only use supported types:
   ```javascript
   // ❌ Wrong: Unsupported type
   liveMap.set('key', new Date());
   
   // ✅ Correct: Use supported types
   liveMap.set('key', Date.now()); // number
   liveMap.set('data', { name: 'value' }); // object
   ```
   <!-- Code source: Based on LiveObjects validation from https://github.com/ably/ably-js/blob/main/src/plugins/objects/livemap.ts#L184 -->

5. **SDK-Specific Considerations**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 124-131 -->
   
   **iOS/macOS**: Ensure correct type usage:
   ```objc
   // ❌ Wrong: Using NSString for base64
   [channel publish:@"event" data:stringData];
   
   // ✅ Correct: Use NSData for binary
   NSData *data = [stringData dataUsingEncoding:NSUTF8StringEncoding];
   [channel publish:@"event" data:data];
   ```
   
   **Rust**: Ensure cipher block alignment:
   ```rust
   // Encrypted data must be block-aligned (16 bytes for AES)
   assert!(encrypted_data.len() % 16 == 0);
   ```

## Automatic Handling

This is a client error that will not be automatically retried. The SDK cannot recover from invalid data types or encoding failures - you must fix the data format or configuration before the operation will succeed.

## Known Production Issues

<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 37-50 -->

### Idle Channel Encryption Issues
Some customers have experienced decryption failures after channels remain idle for extended periods. The issue typically resolves when reconnecting. If you encounter this:
- Monitor for patterns of idle period failures
- Consider implementing periodic keepalive messages
- Enable verbose logging to capture full context

### Dynamic Channel Name Race Conditions
When using dynamically constructed channel names with encryption, race conditions can cause inconsistent encryption states. Always memoize channel names when using encryption.

## Prevention

- Always validate data types before publishing
- Use explicit JSON serialization for complex objects
- Maintain consistent cipher configuration across all clients
- Memoize channel names when using encryption to avoid race conditions
- Test encoding/decoding with your specific data types in development
- Enable verbose logging to capture full error context during debugging
- For production encrypted channels, implement monitoring for decryption failures

## Related Errors

• **[40000 - Bad Request](https://help.ably.io/error/40000)**  
  General bad request error that may occur alongside encoding issues

• **[92001-92005 - Encryption Errors](https://help.ably.io/error/92001)**  
  Specific encryption configuration and cipher operation failures

• **[80013 - Protocol Error](https://help.ably.io/error/80013)**  
  Protocol violations that may result from malformed encoded messages

## Related Resources

- [Message concepts documentation](https://ably.com/docs/messages/)
- [Encryption documentation](https://ably.com/docs/channels/options/encryption)
- [API Reference for Messages](https://ably.com/docs/api/rest-sdk/messages)
- [Channel options overview](https://ably.com/docs/channels/options)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40013
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using
- Whether encryption is involved and if the issue occurs after idle periods

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED:
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (no specific notes for 40013)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40013-invalid-message-data-or-encoding.mdx (enhanced and improved)
-->

<!-- URL Validation Completed: 2025-08-24T21-13-57-640Z -->
<!-- External URLs verified: 6 | Corrected: 3 | Exempted internal: 2 -->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Resolution strategy from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 28-31 (JSON/MsgPack marshalling)
- Production Issues Added: Klarna and Pearson VUE issues from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 37-50
- SDK-Specific Guidance Enhanced: Added platform-specific examples from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 124-148
- Content Excluded: Internal Slack discussion details that are too implementation-specific
- Recommendations Source:
  - Data type validation: Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 16-43
  - Encryption issues: From known production issues in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 37-50
  - Publish method fix: From SDK validation patterns in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 28-36
  - Race condition fix: From Pearson VUE resolution in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 44-50
- Code Examples Rationale: Included minimal examples based on actual SDK patterns from research files, essential for demonstrating correct vs incorrect usage
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes:
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 16-21, 38-43, 89-92, 127-129
  - Cause 2: From production issues documented in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 37-50, 73-79
  - Cause 3: From encoding validation patterns in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 60-83, 97-100, 111-114
- Resolution Steps:
  - Step 1: Source from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 28-31 and analysis of supported types
  - Step 2: From JavaScript SDK validation in https://github.com/ably/ably-js/blob/main/src/common/lib/client/restchannel.ts#L97
  - Step 3: From encryption issues in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 37-50 and Pearson VUE fix lines 48-50
  - Step 4: From LiveObjects validation in https://github.com/ably/ably-js/blob/main/src/plugins/objects/livemap.ts#L184
  - Step 5: From SDK-specific patterns in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-analysis.md lines 60-83, 97-100
- Known Production Issues: From https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 37-50
- Prevention: Based on resolution strategies from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40013-knowledge.md lines 115-125 and production issues
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40013
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40013 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->