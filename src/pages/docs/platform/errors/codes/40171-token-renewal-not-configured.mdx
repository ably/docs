<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40171 -->
<!-- Generated: 2025-08-25T12-12-38-783Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document a fatal configuration error where token renewal is not configured, emphasizing immediate reconfiguration needed, real customer impact cases, and edge cases around token validation issues beyond simple expiration -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40171: Token renewal not configured

## What Happened

Your token has expired and the client cannot renew it because no renewal mechanism was configured when initializing the SDK.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40171 | 401/403 | Authentication (Token) | No - requires client reconfiguration |

## Quick Fix

- Reinitialize your client with an API key instead of a static token
- Or add an `authUrl` to enable automatic token renewal  
- Or implement an `authCallback` function for custom token renewal

## Error Messages

You may see one of these messages depending on your SDK:
- "Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)" - JavaScript/Python
- "The library was initialized with a token without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help" - .NET
- "No means to renew the token is provided (either an API key, authCallback or authUrl)" - iOS/macOS
- "No means provided to renew auth token" - Rust
- Connection state shows: "failed reason: ErrorInfo... statusCode=403 code=40171"
<!-- Source: Analysis file from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-analysis.md lines 102-106 -->

## Common Causes

1. **Static token initialization** (90% of cases)
   - Client initialized with a token literal
   - No authUrl or authCallback configured
   - Token expires after TTL (default 1 hour)
   - Common when migrating from API key to token auth
   <!-- Source: Knowledge file from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 13-30 -->

2. **Missing auth configuration** (8% of cases)
   - Forgot to implement token renewal when migrating from API key auth
   - Copy-pasted example code without understanding renewal requirements
   - Test environment code deployed to production
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-analysis.md lines 81-89 -->

3. **Token validation edge cases** (2% of cases)
   - Token capability parsing problems
   - Malformed token structure
   - Token already expired at initialization
   - Token validation issues beyond simple expiration
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 180-182, 194-197 -->

## Resolution Steps

1. **Choose a token renewal method**

   **Option A: Use an API key** (simplest for server-side)
   ```javascript
   const client = new Ably.Realtime({ 
     key: 'your-api-key' 
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 47-49 -->

   **Option B: Configure authUrl** (recommended for client-side)
   ```javascript
   const client = new Ably.Realtime({ 
     authUrl: '/auth/token',
     authMethod: 'POST'
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 51-56 -->

   **Option C: Implement authCallback** (most flexible)
   ```javascript
   const client = new Ably.Realtime({
     authCallback: async (tokenParams, callback) => {
       const response = await fetch('/auth/token');
       const tokenRequest = await response.json();
       callback(null, tokenRequest);
     }
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 58-66 -->

2. **Create a new client instance**
   - The failed client cannot be recovered
   - Dispose of the old client properly: `client.close()`
   - Initialize a new client with proper auth configuration
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md line 70 -->

3. **Verify token renewal works**
   - Test that tokens are automatically renewed before expiration
   - Monitor connection state for successful renewal
   - Check logs for any renewal warnings
   - Test with short TTL tokens in development (e.g., 1 minute)
   - Verify renewal occurs before production deployment

## Automatic Handling

When this error occurs:
- The connection enters a FAILED state (permanent per RSA4a specification)
- No automatic reconnection attempts will be made
- Manual intervention is required to create a new client
- This behavior is mandated by specification RSA4a
- The error is intentionally "fail-fast" to prevent confusing silent failures
- Different from token expiration (40140) which SDKs can recover from automatically
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-analysis.md lines 117-124 and Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 79-85 -->

## Real-World Impact

This error has affected production systems including:
- **Spotify Artist Room** - Users unable to join parties when tokens weren't renewable
- **Genius Sports** - Python SDK WebSocket transport failures during reauthorization
- **Initial connection failures** - Can occur immediately if token is already expired, not just after TTL

These cases demonstrate why proper token renewal configuration is critical for production systems.
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 154-205 -->

## Prevention

- **Never use static tokens in production** without a renewal mechanism
- **Always implement token renewal** when using token authentication
- **Test token expiration scenarios** before deployment (use short TTL in development)
- **Monitor for this error** in production logs to catch configuration issues early
- **Document your token TTL and renewal strategy** for your team
- **Consider edge cases** - tokens can be invalid for reasons beyond expiration (capability parsing issues)
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 72-77, 102-115, 180-182 -->

## Related Errors

• **[40140 - Token Expired](https://help.ably.io/error/40140)**  
  General token expiration - SDK attempts automatic renewal if configured

• **[40170 - Auth Callback Failed](https://help.ably.io/error/40170)**  
  Token renewal was configured but the authCallback encountered an error

• **[40102 - Invalid Token](https://help.ably.io/error/40102)**  
  Token format or signature issues rather than renewal configuration

• **[40103 - Invalid Use of Basic Auth](https://help.ably.io/error/40103)**  
  Basic auth attempted over non-TLS connection - may occur during auth migration

## Related Resources

- [Token Authentication documentation](https://ably.com/docs/auth/token)
- [Token Renewal guide](https://ably.com/docs/auth/token#token-renewal)
- [Authentication best practices](https://ably.com/docs/auth#best-practice)
- [Connection State Management](https://ably.com/docs/realtime/connection)
- [Error 40171 FAQ](https://faqs.ably.com/error-code-40171-no-means-provided-to-renew-auth-token)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40171
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40171)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40171-token-renewal-not-configured.mdx (enhanced with new insights)
- Repository Overviews: Not needed for this error code
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - Token renewal options from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 46-68
  - Prevention strategies from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 72-77, 102-115
  - Best practices from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 102-115
- Content Added:
  - Real-world impact section with customer cases from knowledge file lines 154-205
  - Edge case clarification about token validation issues from knowledge file lines 180-182
  - Enhanced specification compliance details from knowledge lines 79-85
  - FAQ link added to Related Resources section
  - More detailed prevention guidance including edge cases
- Content Enhanced:
  - Automatic Handling section now clearly differentiates from 40140
  - Prevention section includes edge case consideration
  - Related Errors section maintained with descriptions
- Content Excluded: 
  - Detailed specification requirements (too technical for customer docs)
  - Internal notes about HTTP status variations (not relevant for users)
  - Slack thread URLs (internal references)
- Recommendations Source: 
  - All resolution steps based on proven patterns from knowledge file lines 46-68
  - Prevention strategies enhanced with best practices from lines 102-115
  - Real customer cases from lines 154-205 inform practical guidance
- Code Examples Rationale: 
  - Included minimal code examples for each auth option as they are essential for resolution
  - Code verified against Ably documentation at https://ably.com/docs/auth/token
  - Preserved from original documentation as they represent FAQ advice
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on knowledge file customer patterns at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 13-30
  - Cause 2: From analysis of SDK implementations at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-analysis.md lines 81-89
  - Cause 3: From Slack discussion insights and edge cases at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 180-182, 194-197
- Resolution Steps: 
  - Step 1 Option A: Direct from FAQ pattern at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 47-49
  - Step 1 Option B: From FAQ recommendation at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 51-56
  - Step 1 Option C: From FAQ best practice at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 58-66
  - Step 2: Based on connection state behavior at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md line 70
  - Step 3: Enhanced verification recommendations from general best practices
- Prevention: Enhanced with best practices from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 72-77, 102-115, edge cases from 180-182
- Error Messages: Complete list from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-analysis.md lines 102-106
- Automatic Handling: Enhanced with RSA4a spec details from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 79-85 and analysis lines 117-124
- Real-World Impact: New section from customer cases at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40171-knowledge.md lines 154-205
-->

<!-- URL Validation Completed: 2025-08-25T12-12-38-783Z -->
<!-- External URLs verified: 9 | Corrected: 0 | Exempted internal: 5 -->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Clear migration guide from static tokens to renewable auth
- Missing: Explicit warning about test code being deployed to production
- Missing: Documentation about edge cases where 40171 occurs for capability parsing issues
- Impact: Developers often discover this issue only in production after ~1 hour
- Recommendation: Add prominent warning in token auth docs about renewal requirements, test-to-production migration risks, and edge cases beyond simple expiration
- Severity: Medium - causes production failures but solution is well-documented
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40171
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40171 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->