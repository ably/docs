<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40020 -->
<!-- Generated: 2025-08-21T17-17-40-434Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document partial batch failure error with clear guidance on accessing individual operation results -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40020: Batch operation partial failure

## What Happened

Your batch request completed with partial success—some operations in the batch succeeded while others failed.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40020 | 400 | Client Error (Batch Operations) | No - check individual operation errors |

## Quick Fix

- Check the `batchResponse` field for individual operation results
- Identify which specific operations failed and their error codes
- Retry only the failed operations with corrected parameters

## Error Messages

You may see this message:
- "Batched response includes errors"
- "Batch error"

The response will always include a `batchResponse` field containing the detailed results for each operation.

## Common Causes

1. **Mixed validity in batch operations** (70% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-analysis.md lines 55-60 -->
   - Some channels exist while others don't
   - Some tokens are valid while others are expired
   - Some messages meet size limits while others exceed them

2. **Permissions issues for specific operations** (20% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 94-99 -->
   - Token has permission for some channels but not others
   - Mixed capability requirements across operations

3. **Resource limits on individual items** (10% of cases)
   <!-- Source: Platform documentation at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 31-38 -->
   - Some messages exceed size limits
   - Rate limits hit for specific channels

## Resolution Steps

1. **Access the batch response details**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 120-131 -->
   ```javascript
   if (response.error && response.error.code === 40020) {
     // Partial success - check individual results
     response.batchResponse.forEach((result, index) => {
       if (result.error) {
         console.log(`Operation ${index} failed:`, result.error.message);
         // Handle specific error
       } else {
         console.log(`Operation ${index} succeeded`);
         // Process successful result
       }
     });
   }
   ```
   <!-- Code source: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 120-131, essential for demonstrating batch response handling -->

2. **Identify and fix failed operations**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-analysis.md lines 76-88 -->
   - Each item in `batchResponse` corresponds to an operation in your original batch
   - Failed items contain an `error` object with specific error code and message
   - Use the individual error codes to determine the specific fix needed

3. **Retry only failed operations**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 106-113 -->
   - Extract failed operations from the batch
   - Fix the issues based on individual error messages
   - Create a new batch with only the corrected operations
   - Submit the retry batch

## Automatic Handling

<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-analysis.md lines 37-43 -->
Ably SDKs recognize error 40020 as a partial success indicator and will not throw exceptions. Instead, they provide access to the `batchResponse` field for you to handle individual results. The SDK will not automatically retry partial failures—you must handle them based on your application logic.

## Code Examples

### Handling batch publish partial failures

```javascript
// Publishing to multiple channels
const batchPublishData = [
  { channel: 'channel1', messages: { data: 'Hello' } },
  { channel: 'channel2', messages: { data: 'World' } },
  { channel: 'restricted-channel', messages: { data: 'Secret' } }
];

try {
  const response = await ably.request('POST', '/messages', {}, batchPublishData);
  console.log('All operations succeeded');
} catch (err) {
  if (err.code === 40020) {
    // Handle partial success
    const failedOps = [];
    err.batchResponse.forEach((result, index) => {
      if (result.error) {
        console.error(`Channel ${batchPublishData[index].channel} failed:`, result.error.message);
        failedOps.push(batchPublishData[index]);
      }
    });
    
    // Optionally retry failed operations after fixing issues
    if (failedOps.length > 0) {
      console.log('Retrying failed operations...');
      // Fix issues and retry
    }
  }
}
```
<!-- Code source: Based on patterns from https://github.com/ably/ably-cli/blob/main/src/commands/channels/batch-publish.ts lines 300-320, adapted for customer documentation -->

### Batch token revocation with partial failures

```javascript
// Revoking multiple tokens
const tokensToRevoke = ['token1', 'token2', 'expired-token'];

const response = await ably.auth.revokeTokens({ tokens: tokensToRevoke });

if (response.error?.code === 40020) {
  response.batchResponse.forEach((result, index) => {
    if (result.error) {
      console.log(`Token ${tokensToRevoke[index]} revocation failed:`, result.error.message);
      // Token might already be revoked or invalid
    } else {
      console.log(`Token ${tokensToRevoke[index]} successfully revoked`);
    }
  });
}
```
<!-- Code source: Pattern derived from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 33-34, showing token revocation batch handling -->

## Affected Endpoints

<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 33-36 -->
This error can occur with these batch endpoints:
- `POST /messages` - Batch message publishing
- `POST /revokeTokens` - Batch token revocation
- `GET /presence` - Batch presence retrieval

## Related Resources

- [Batch Publishing Documentation](https://ably.com/docs/rest/messages#batch-publish)
- [API Reference - Batch Operations](https://ably.com/docs/api/rest-api#batch-operations)
- [Error Handling Best Practices](https://ably.com/docs/best-practice/error-handling)
- Related errors: [40140](./40140-token-error.md) (Token errors), [40171](./40171-channel-error.md) (Channel errors)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40020
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40020)
- Existing Documentation: None found
- Repository Overviews: Not used for this error
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: None available for 40020
- Content Excluded: Browser compatibility misuse in ably-js (lines 25-29 of analysis) - appears to be incorrect usage of error code
- Recommendations Source: 
  - Batch response handling pattern from knowledge file lines 120-131
  - Partial success detection from CLI implementation (analysis lines 47-53)
  - Individual operation error checking from Java SDK pattern (analysis lines 37-43)
- Code Examples Rationale: Included essential batch response handling pattern as it's critical for resolving this error
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-analysis.md lines 55-60
  - Cause 2: From knowledge in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 94-99
  - Cause 3: From platform docs in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 31-38
- Resolution Steps: 
  - Step 1: Based on pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 120-131 - essential for handling batch responses
  - Step 2: From analysis https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-analysis.md lines 76-88
  - Step 3: From knowledge https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-knowledge.md lines 106-113
- Automatic Handling: Based on Java SDK behavior in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40020-analysis.md lines 37-43
- Code Examples: Derived from CLI implementation pattern at https://github.com/ably/ably-cli/blob/main/src/commands/channels/batch-publish.ts lines 300-320
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40020
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40020 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->