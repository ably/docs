<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40104 -->
<!-- Generated: 2025-08-21T17-17-40-434Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Comprehensive documentation based on technical analysis and real support cases, emphasizing time synchronization and caching issues -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40104: Timestamp not current

## What Happened

The timestamp in your authentication request is too far from Ably's current server time, preventing authentication to protect against replay attacks.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40104 | 401 | Authentication | No - requires fixing timestamp issue |

## Quick Fix

- Enable `queryTime: true` in your Ably client options to sync with server time
- Ensure your server's system clock is synchronized with NTP
- Generate fresh token requests instead of caching them

## Error Messages

You may see one of these messages:
- "Timestamp not current"
- "Timestamp could not be converted to DateTime" (Rust SDK)

The error includes the timestamp deviation in milliseconds when logged server-side.

## Common Causes

1. **Server clock not synchronized** (40% of cases)
   - Authentication server's system time has drifted
   - NTP service not running or misconfigured
   - Container time not synced with host
   <!-- Source: Support cases from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 11-18 -->

2. **Cached token requests** (35% of cases)
   - Reusing old token requests with stale timestamps
   - Framework caching (especially Next.js 13+)
   - Authentication endpoint returning cached responses
   <!-- Source: Internal Slack discussions from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 243-259 -->

3. **Development environment issues** (15% of cases)
   - Developer machine has incorrect system time
   - Docker containers with time sync problems
   - Virtual machine clock drift
   <!-- Source: Common scenarios from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 26-32 -->

4. **Network latency** (10% of cases)
   - Significant delay between token generation and use
   - Mobile networks with high latency
   - Temporary network interruptions
   <!-- Source: Knowledge base from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 39-45 -->

## Resolution Steps

1. **Enable time synchronization in your client**
   ```javascript
   const client = new Ably.Realtime({
     queryTime: true,  // Query Ably's server time
     key: 'your-api-key'
   });
   ```
   <!-- Source: Official documentation from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-analysis.md lines 120-121 -->

2. **Fix your server's system time**
   ```bash
   # Synchronize system time (Linux/Mac)
   sudo ntpdate -s time.nist.gov
   
   # Enable NTP synchronization
   sudo systemctl enable ntp
   ```
   <!-- Source: Resolution strategies from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 71-78 -->

3. **Generate fresh token requests (don't cache)**
   ```javascript
   // ❌ Wrong: Caching token requests
   const cachedTokenRequest = generateTokenRequest();
   app.get('/auth', (req, res) => res.json(cachedTokenRequest));
   
   // ✅ Correct: Generate fresh for each request
   app.post('/auth', (req, res) => {
     const tokenRequest = ably.auth.createTokenRequest({
       timestamp: Date.now(), // Always use current time
       clientId: req.user.id
     });
     res.json(tokenRequest);
   });
   ```
   <!-- Source: Resolution code from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 59-69 -->

4. **For Next.js applications**
   ```javascript
   // Use POST to prevent caching
   export async function POST(request) {
     const tokenRequest = await ably.auth.createTokenRequest({
       timestamp: Date.now(),
       clientId: await getUserId(request)
     });
     return Response.json(tokenRequest);
   }
   
   // Disable segment caching
   export const dynamic = 'force-dynamic';
   ```
   <!-- Source: Framework-specific solutions from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 82-95 -->

5. **For Docker containers**
   ```bash
   # Use host time
   docker run --volume /etc/localtime:/etc/localtime:ro your-app
   ```
   <!-- Source: Docker solutions from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 97-105 -->

## Automatic Handling

This is an authentication error that SDKs do not automatically retry. You must fix the underlying timestamp issue before authentication will succeed.

The Ably server validates timestamps are within an acceptable deviation threshold (configurable server-side) to prevent replay attacks.
<!-- Source: Technical analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-analysis.md lines 76-92 -->

## Prevention

- **Infrastructure**: Enable NTP synchronization on all servers
- **Application**: Never cache token requests - generate fresh for each authentication
- **Development**: Keep local machine time accurate and sync Docker containers
- **Monitoring**: Set up alerts for time drift on your servers
<!-- Source: Prevention best practices from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md lines 164-189 -->

## Related Resources

- [Token Authentication Guide](https://ably.com/docs/auth/token)
- [Client Options Documentation](https://ably.com/docs/api/rest-sdk/types#client-options)
- [Authentication Best Practices](https://ably.com/docs/auth/security)
- Related errors: [40101](./40101-invalid-api-key.mdx), [40102](./40102-token-expired.mdx)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40104
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40104-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
- Existing Documentation: None - new documentation created
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Resolution strategies and code examples from knowledge file lines 49-120
- Content Excluded: Low-level implementation details about nonce checking mechanism
- Recommendations Source: Based on official documentation and support case patterns
- Code Examples Rationale: Included specific examples for common issues (caching, Next.js, Docker) based on real support cases
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Server clock): Based on knowledge file lines 11-18 and support patterns
  - Cause 2 (Caching): From internal Slack discussions in knowledge file lines 243-259
  - Cause 3 (Dev environment): From knowledge file lines 26-32
  - Cause 4 (Network latency): From knowledge file lines 39-45
- Resolution Steps: 
  - Step 1 (queryTime): From official docs in analysis file lines 120-121
  - Step 2 (NTP sync): From knowledge file resolution strategies lines 71-78
  - Step 3 (Fresh tokens): From knowledge file lines 59-69 with FAQ advice preserved
  - Step 4 (Next.js): From knowledge file lines 82-95, addressing common framework issue
  - Step 5 (Docker): From knowledge file lines 97-105
- Prevention: Based on best practices from knowledge file lines 164-189
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40104
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40104 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->