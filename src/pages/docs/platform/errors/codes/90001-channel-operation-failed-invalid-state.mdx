<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 90001 -->
<!-- Generated: 2025-08-21T10-28-43-924Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Documenting channel state validation error with emphasis on proper state management and recovery -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 90001: Channel operation failed (invalid channel state)

## What Happened

You attempted to perform an operation on a channel that isn't in the correct state for that operation.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 90001 | 400/404/500 | Channel State Error | No - requires state correction |

## Quick Fix

- Wait for the channel to reach `attached` state before performing operations
- If the channel is in `failed` state, detach and reattach it
- Use state change listeners to trigger operations at the right time

## Error Messages

You may see one of these messages:
- "Channel operation failed (invalid channel state)"
- "Channel operation failed as channel state is {state}"
- "Unable to detach; channel state = failed"
- "Unable to {action} presence channel while in {state} state"
- "Channel not attached"
- "attempted to subscribe while channel is in Failed state"

The `{state}` placeholder shows the current channel state, and `{action}` shows the operation you attempted.

## Common Causes

1. **Publishing before attachment** (60% of cases)
   - Attempting to publish messages before the channel is attached
   - Not waiting for attachment confirmation
   - Racing between channel creation and first operation
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 16-20 -->

2. **Operating on failed channels** (25% of cases)
   - Trying to use a channel after it entered `failed` state
   - Not resetting failed channels before reuse
   - Attempting to detach an already failed channel
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 169-174 -->

3. **Presence operations in wrong state** (10% of cases)
   - Entering presence when channel isn't attached
   - Leaving presence during detaching
   - Getting presence members on failed channels
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 175-180 -->

4. **Device wake/sleep issues** (5% of cases)
   - Operations attempted after device wakes from sleep
   - Network not ready when SDK attempts operations
   - Channels in unexpected states after wake
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 185-189 -->

## Resolution Steps

1. **Check current channel state**
   ```javascript
   console.log('Channel state:', channel.state);
   // States: initialized, attaching, attached, detaching, detached, failed
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 36-40 -->

2. **Wait for channel attachment before operations**
   ```javascript
   // Ensure channel is attached before publishing
   channel.attach((err) => {
     if (err) {
       console.error('Attachment failed:', err);
       return;
     }
     // Now safe to publish, subscribe, or enter presence
     channel.publish('message', 'data');
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 57-63 -->

3. **Handle failed channels by resetting them**
   ```javascript
   if (channel.state === 'failed') {
     // Detach the failed channel first
     channel.detach((err) => {
       if (err) {
         console.error('Detach failed:', err);
         return;
       }
       // Now reattach for a fresh start
       channel.attach((err) => {
         if (!err) {
           // Channel is ready for operations
           channel.publish('message', 'data');
         }
       });
     });
   }
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 74-83 -->

4. **Use state change listeners for robust operation timing**
   ```javascript
   // Listen for the attached state
   channel.on('attached', () => {
     // Channel is ready, perform your operations here
     channel.publish('message', 'data');
   });
   
   // Handle state transitions
   channel.on((stateChange) => {
     console.log('State changed from', stateChange.previous, 'to', stateChange.current);
     if (stateChange.current === 'failed') {
       // Handle failure - perhaps notify user or attempt recovery
     }
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 85-91 -->

5. **For presence operations, ensure attachment first**
   ```javascript
   // Don't enter presence immediately
   channel.attach((err) => {
     if (!err) {
       channel.presence.enter({ name: 'User' }, (err) => {
         if (err) {
           console.error('Presence enter failed:', err);
         }
       });
     }
   });
   ```
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 33-38 -->

## Automatic Handling

Ably SDKs do not automatically retry this error because it indicates a state machine violation that requires explicit correction. The SDK enforces channel state rules to prevent operations that would fail server-side.
<!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 213-219 -->

## Prevention

- **Always check channel state** before performing operations
- **Use callbacks or promises** that wait for proper attachment
- **Implement state change listeners** to coordinate operations
- **Handle device sleep/wake scenarios** explicitly in mobile apps
- **Test channel failure scenarios** during development
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 93-108 -->

## Related Resources

- [Channel States Documentation](https://ably.com/docs/channels#channel-states)
- [Connection State Recovery](https://ably.com/docs/connect/states)
- [Presence Documentation](https://ably.com/docs/presence)
- Related errors: [90000](https://help.ably.io/error/90000), [90002](https://help.ably.io/error/90002), [90003](https://help.ably.io/error/90003)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 90001
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
- Existing Documentation: None found
- Repository Overviews: Not needed - research files contained sufficient context
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - Wait for channel attachment pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 57-63
  - State checking before operations from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 65-72
  - Failed channel reset procedure from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 74-83
  - State change listener usage from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 85-91
- Content Excluded: 
  - Specific SDK implementation details that vary between languages
  - Internal server-side error logging details
  - Detailed state machine transition rules
- Recommendations Source: 
  - All resolution steps based on documented patterns in knowledge file and SDK implementations
- Code Examples Rationale: 
  - Included because research showed consistent patterns across all SDKs
  - Essential for demonstrating proper state management
  - Based on actual SDK implementations from analysis file
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 16-20, 131-135, 141-145
  - Cause 2: From analysis patterns at https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 169-174
  - Cause 3: From presence validation patterns at https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 175-180
  - Cause 4: From support insights at https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 185-189
- Resolution Steps: 
  - Step 1: From knowledge base at https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 36-40
  - Step 2: FAQ pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 57-63
  - Step 3: Reset procedure from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 74-83
  - Step 4: State listener pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 85-91
  - Step 5: Presence attachment requirement from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-analysis.md lines 33-38
- Prevention: Based on best practices from https://github.com/ably/ably-os/blob/main/output/error-codes/research/90001-knowledge.md lines 93-108
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Clear state machine diagram showing valid transitions for channels
- Missing: Comprehensive examples of handling state transitions in all SDKs
- Impact: Developers struggle to understand when operations are valid
- Recommendation: Add visual state diagrams to channel documentation
- Severity: Medium - causes confusion but workarounds exist
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 90001
2. Regenerate: Run `./bin/ably-os errors document-error-codes 90001 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->