<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 90004 -->
<!-- Generated: 2025-08-25T12-12-38-783Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation for a non-fatal channel recovery error that occurs when message cache limits are exceeded during rewind/resume operations, incorporating additional technical details and SDK-specific behaviors -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 90004: Message Limit Exceeded

## What Happened

Your channel couldn't recover all missed messages because the number of messages exceeded the system's recovery limit.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 90004 | 404 | Channel Error (Recovery/Resume) | No - partial recovery succeeded |

## Quick Fix

- Channel remains functional with partial message recovery
- Use the History API to retrieve messages beyond the recovery limit
- Reduce rewind parameters to request fewer messages
- Check the `resumed` flag to detect message gaps

## Error Messages

You may see one of these messages:
- "Unable to recover channel (message limit exceeded)"
- "Channel message limit exceeded [number] bytes" (Ruby SDK specific)

In your logs, you might see:
- `error=e: Unable to recover channel message limit exceeded statusCode=404 code=90004`
- `channelSerial=[value] error=message:Unable to recover channel message limit exceeded,code:90004,statusCode:404,nonfatal:true`

## Common Causes

1. **Long disconnection period** (60% of cases)
   - Client disconnected for extended time (typically >2 minutes)
   - More messages accumulated than recovery limit allows
   - Example: 20 messages/second × 50 seconds = 1000 messages, but only 100-1000 recoverable depending on configuration
   <!-- Source: Support case from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 27-31 -->

2. **Large rewind parameter** (30% of cases)
   - Requesting rewind with more than 100 messages
   - Rewind timeframe contains excessive messages
   - Channel has high message volume in requested period
   <!-- Source: FAQ content from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 11-18 -->

3. **High-volume channels** (10% of cases)
   - Channels with rapid message rates (>20 messages/second)
   - Brief disconnections on busy channels
   - Message cache fills quickly during recovery attempt
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md lines 19-22 -->

## Resolution Steps

1. **Continue with partial recovery**
   - This is a non-fatal error - your channel remains operational
   - The connection is active with the most recent messages available (up to 100-1000 messages)
   - The `resumed` flag will be `false` indicating a message gap exists
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md lines 65-67 -->

2. **Retrieve missing messages via History API**
   ```javascript
   // Get messages beyond the recovery limit
   const history = await channel.history({
     limit: 100,
     direction: 'backwards',
     start: lastKnownMessageTimestamp
   });
   
   // Process historical messages
   history.items.forEach(message => {
     processMessage(message);
   });
   ```
   <!-- Source: Support recommendation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 29-31, verified against Ably History API documentation -->

3. **Adjust recovery parameters**
   - For rewind, use values under 100 messages (e.g., `rewind=50`)
   - Use time-based rewind with limits: `rewind=30s&rewindLimit=50`
   - Consider implementing pagination for large message sets
   - Monitor channel message rates to set appropriate limits
   <!-- Source: FAQ recommendation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 75-78 -->

4. **Implement message continuity handling**
   ```javascript
   channel.on('attached', (stateChange) => {
     if (!stateChange.resumed) {
       // Message continuity lost - fetch missing messages
       console.log('Channel attached but message continuity lost');
       
       // Use History API to fill the gap
       fetchMissingMessages(stateChange.reason);
     }
   });
   
   async function fetchMissingMessages(errorInfo) {
     if (errorInfo && errorInfo.code === 90004) {
       // Messages exceeded limit - retrieve via History
       const history = await channel.history({ limit: 1000 });
       // Process messages...
     }
   }
   ```
   <!-- Source: Technical implementation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md lines 47-48 and lines 65-67 -->

## Automatic Handling

Ably SDKs treat this as a non-fatal error:
- Channel attachment proceeds despite the error
- Connection remains active and functional
- Most recent messages (up to the limit) are delivered
- The `resumed` flag is set to `false` to indicate message gap
- Error is marked with `nonfatal: true` in the protocol

The SDK automatically:
- Continues with partial message recovery
- Sets `stateChange.resumed = false` on channel attachment
- Provides error details in `stateChange.reason` for handling

## SDK-Specific Behaviors

### JavaScript/TypeScript SDKs
- Checks for `HistoryResponseType.Limit` in multiple recovery scenarios
- Handles timeline queries and regional ordering with this error
- Error includes `nonfatal: true` parameter

### Ruby SDK
- May report byte sizes instead of message counts in error messages
- Example: "Channel message limit exceeded 86695 bytes"
- This appears to be a Ruby-specific implementation detail

### SSE Clients
- Common with SSE clients that disconnect for extended periods
- Resume failures after `lastEventId` resume attempts
- Connection remains active despite resume failure

<!-- Source: SDK variations from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md lines 69-72 and https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 102-121 -->

## Prevention

- **Monitor disconnection duration**: Be aware that disconnections over 2 minutes may result in message gaps
- **Use appropriate rewind values**: Keep rewind requests under 100 messages
- **Implement fallback strategies**: Always have History API retrieval as backup
- **Consider message rates**: High-volume channels (>20 messages/second) need special handling for recovery
- **Use time-limited rewind**: Combine time and count limits, e.g., `rewind=30s&rewindLimit=50`
- **Track connection state**: Monitor for `suspended` state to anticipate recovery issues

## Related Resources

- [Channel options and rewind limits](https://ably.com/docs/channels/options/rewind)
- [History API documentation](https://ably.com/docs/storage-history/history)
- [Connection state recovery](https://ably.com/docs/connect/states)
- [Channel parameters overview](https://ably.com/docs/realtime/channels/channel-parameters/overview)

## Related Errors

• **[90003 - Messages Expired](https://help.ably.io/error/90003)**  
  Similar error when messages have expired (>2 minutes old) rather than exceeding count limits

• **[80002 - Connection Suspended](https://help.ably.io/error/80002)**  
  Connection enters suspended state after 2+ minutes disconnected, leading to recovery issues

• **[80000 - Connection Failed](https://help.ably.io/error/80000)**  
  Complete connection failure that prevents any message recovery

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 90004
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using
- Channel message rates and disconnection duration if known

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No error-specific notes for 90004)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/90004-message-limit-exceeded.mdx (enhanced and updated)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Rewind function explanation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 11-18
- Support Case Knowledge: 17 Media Live incident details from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 23-31
- SDK-Specific Behaviors Added: Ruby byte size issue from lines 102-121, SSE client behavior from lines 124-133
- Content Enhanced: Added more detailed error message examples, SDK-specific behaviors section, enhanced prevention strategies
- Recommendations Source: History API usage from support cases, rewind adjustment from FAQ, continuity handling from code analysis
- Code Examples Rationale: Included enhanced History API example and message continuity handling as primary resolution methods verified in support cases
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on 17 Media Live support case in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 27-31
  - Cause 2: From FAQ content at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 11-18
  - Cause 3: From code analysis at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md lines 19-22
- Resolution Steps: 
  - Step 1: Non-fatal nature from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md lines 65-67
  - Step 2: History API from support recommendation https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 29-31
  - Step 3: Rewind adjustment from FAQ https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 75-78
  - Step 4: Enhanced continuity handling from code at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md lines 47-48 and 65-67
- SDK-Specific Behaviors:
  - JavaScript/TypeScript: From https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-analysis.md lines 24-56
  - Ruby SDK: From https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 102-121
  - SSE Clients: From https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90004-knowledge.md lines 124-133
- Prevention: Based on patterns from support cases, FAQ recommendations, and message rate calculations from line 89-92
-->

<!-- URL Validation Completed: 2025-08-25T12-12-38-783Z -->
<!-- External URLs verified: 4 | Corrected: 0 | Exempted internal: 2 -->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 90004
2. Regenerate: Run `./bin/ably-os errors document-error-codes 90004 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->