<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40003 -->
<!-- Generated: 2025-08-21T10-28-43-924Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation incorporating latest research findings, improved structure, and comprehensive validation patterns across all SDKs -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40003: Invalid Parameter Value

## What Happened

A parameter in your request contains an invalid value that doesn't meet Ably's requirements.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40003 | 400 | Client Error (Validation) | No - requires fixing the parameter value |

## Quick Fix

- Check the specific error message for which parameter is invalid
- Verify the parameter meets documented constraints (type, format, range)
- Review the parameter requirements in the relevant API documentation

## Error Messages

You may see one of these messages:

<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 16-187 -->
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 285-292 for revocable token context -->

**Token TTL Errors:**
- "Excessive value for ttl" - Token TTL exceeds 24-hour maximum
- "Excessive value for ttl (revocation is enabled on this key, and revocable tokens are limited to a TTL of one hour)" - Revocable token TTL exceeds 1-hour maximum

**Encryption Errors:**
- "No key specified" - Missing encryption key
- "Unsupported keyLength. Only 128 and 256 bits are supported" - Invalid encryption key size
- "keyLength does not match the actual key length" - Declared key size doesn't match actual
- "Unsupported cipher configuration. The supported configurations are aes-128-cbc and aes-256-cbc" - Invalid cipher
- "The specified algorithm is not supported by openssl" - OpenSSL compatibility issue
- "Only 128 and 256 bit keys are supported" - Invalid key bit size (.NET)

**LiveObjects Errors:**
- "Map key should be string" - LiveObjects map key is not a string
- "Map entries should be a key-value object" - Invalid object for setEntries
- "Counter value should be a valid number" - LiveObjects counter value is not numeric
- "Counter value increment should be a valid number" - Non-numeric increment value
- "Counter value decrement should be a valid number" - Non-numeric decrement value

**History Query Errors:**
- "Unable to parse start parameter" - Invalid timestamp format in history query
- "Unable to parse end parameter" - Invalid timestamp format
- "Unable to parse limit parameter" - Non-integer limit value
- "Limit must be >0" - Zero or negative limit value
- "Start or end parameter was specified multiple times (ambiguous)" - Duplicate parameters
- "Invalid format param" - Unsupported format value
- "Unable to parse fromSerial parameter" - Invalid serial format

**Message/Annotation Errors:**
- "Message data must be object or array when including annotations" - Incompatible message format
- "size of annotations field for batch should not exceed 4GB" - Annotations too large
- "Message serial can not be empty" - Missing serial for annotations
- "Message data must be either, string, string with binary data, JSON-encodable array or object, or null" - Invalid data type
- "Wrong parameters provided, use either Message, array of Messages, or name and data" - Invalid publish parameters

**Other Validation Errors:**
- "invalid auth URL" - Invalid URL format in authentication
- "Unexpected offset format" - Invalid Cassandra offset format
- "Malformed history query options" - Invalid query structure
- "Unable to find filter.id expression" - Missing filter expression

## Common Causes

<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 21-31, 285-292, 309-314 -->
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md comprehensive pattern analysis -->

1. **Token TTL exceeding limits** (Most common in production)
   - Requesting token with TTL > 24 hours for standard tokens
   - Requesting token with TTL > 1 hour for revocable tokens
   - Not aware of different limits for revocable vs standard tokens
   <!-- Source: FAQ content from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 24-29 -->
   <!-- Source: Slack discussions from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 285-292 -->

2. **Invalid encryption parameters** (Common in PHP implementations)
   - Missing encryption key when cipher is specified
   - Unsupported key length (not 128 or 256 bits)
   - Key length mismatch between declared and actual size
   - OpenSSL version incompatibility
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 64-88 -->

3. **LiveObjects type validation failures** (JavaScript/TypeScript applications)
   - Non-string keys for LiveMap operations
   - Non-numeric values for LiveCounter operations
   - Invalid object structure for setEntries
   - Type mismatches in batch operations
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 16-47 -->

4. **History query parameter errors**
   - Invalid timestamp formats for start/end parameters
   - Non-integer or negative limit values
   - Duplicate parameter specifications
   - Malformed fromSerial values in chat history
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 102-126 -->

5. **Message and annotation validation failures**
   - Annotations exceeding 4GB size limit
   - Empty message serials with annotations
   - Incompatible data types with annotations
   - Wrong parameter combinations in publish methods
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 51-60, 89-97, 158-168 -->

## Resolution Steps

### For Token TTL Errors

<!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 140-147 -->
<!-- Source: Slack support cases from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 265-267, 285-292 -->

1. **Check your token request TTL**
   ```javascript
   // ❌ Wrong: TTL exceeds 24 hours
   const tokenRequest = await ably.auth.createTokenRequest({
     ttl: 90000000  // 25 hours in milliseconds - will fail
   });
   
   // ✅ Correct: TTL within standard token limits
   const tokenRequest = await ably.auth.createTokenRequest({
     ttl: 86400000  // 24 hours maximum for standard tokens
   });
   
   // ✅ Correct: Revocable token with appropriate limit
   const tokenRequest = await ably.auth.createTokenRequest({
     ttl: 3600000,  // 1 hour maximum for revocable tokens
     // Note: revocation is configured on the API key, not in the request
   });
   ```
   <!-- Code source: Based on Ably documentation at https://ably.com/docs/auth/token#token-request, modified to show error scenarios and corrections -->

2. **Verify your API key configuration**
   - Check if your API key has revocation enabled in the Ably dashboard
   - Standard tokens: Maximum TTL is 24 hours (86400000 ms)
   - Revocable tokens: Maximum TTL is 1 hour (3600000 ms)
   - If you need longer-lived tokens, use a non-revocable API key

3. **Consider your use case**
   - For short-lived sessions: Use shorter TTLs (e.g., 1-2 hours)
   - For long-running applications: Implement token renewal before expiry
   - For revocable tokens: Plan for frequent renewal cycles

### For Encryption Errors

<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 45-65 -->
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 64-88, 172-176 -->

1. **Provide a valid encryption key**
   ```javascript
   // ❌ Wrong: Missing key
   const channel = ably.channels.get('encrypted', {
     cipher: { algorithm: 'aes-128-cbc' }  // Error: No key specified
   });
   
   // ✅ Correct: Include encryption key
   const key = await generateCryptoRandomKey(128); // 128-bit key
   const channel = ably.channels.get('encrypted', {
     cipher: { 
       key: key,  // Must be 128-bit or 256-bit
       algorithm: 'aes-128-cbc'
     }
   });
   ```
   <!-- Code source: Based on https://ably.com/docs/channels/options/encryption, adapted for error context -->

2. **Ensure correct key sizes**
   - Only 128-bit (16 bytes) or 256-bit (32 bytes) keys are supported
   - If specifying keyLength, ensure it matches actual key size
   - Let the SDK auto-detect key size when possible

3. **For PHP: Verify OpenSSL support**
   ```php
   // Check if required cipher is available
   $methods = openssl_get_cipher_methods();
   if (!in_array('aes-256-cbc', $methods)) {
     // Update OpenSSL or use aes-128-cbc instead
     error_log('AES-256-CBC not supported, falling back to AES-128-CBC');
     $cipher = 'aes-128-cbc';
   }
   ```
   <!-- Code source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 63-65, adapted -->

### For LiveObjects Errors

<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 16-47 -->

1. **Use correct data types for map operations**
   ```javascript
   // ❌ Wrong: Non-string map keys
   liveMap.set(123, 'value');  // Error: Map key should be string
   liveMap.set(null, 'value'); // Error: Map key should be string
   
   // ✅ Correct: String keys only
   liveMap.set('123', 'value');
   liveMap.set('user-id', 'value');
   ```
   <!-- Code source: Based on LiveObjects patterns from analysis, demonstrating type requirements -->

2. **Validate counter operations**
   ```javascript
   // ❌ Wrong: Non-numeric counter values
   liveCounter.increment('five');  // Error: should be a valid number
   liveCounter.set('100');         // Error: should be a valid number
   
   // ✅ Correct: Numeric values only
   liveCounter.increment(5);
   liveCounter.set(100);
   liveCounter.decrement(1);
   ```

3. **Structure setEntries correctly**
   ```javascript
   // ❌ Wrong: Invalid entries format
   liveMap.setEntries('invalid');  // Error: should be a key-value object
   liveMap.setEntries([1, 2, 3]);  // Error: should be a key-value object
   
   // ✅ Correct: Valid key-value object
   liveMap.setEntries({
     'key1': 'value1',
     'key2': { nested: 'object' },
     'key3': 123
   });
   ```

### For History Query Errors

<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 67-88 -->
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 102-126 -->

1. **Use valid timestamp formats**
   ```javascript
   // ❌ Wrong: Invalid timestamp formats
   const history = await channel.history({
     start: 'yesterday',     // Error: Unable to parse
     end: 'now',            // Error: Unable to parse
     limit: '10'            // Error: Must be integer
   });
   
   // ✅ Correct: Valid millisecond timestamps and integer limit
   const history = await channel.history({
     start: Date.now() - 3600000,  // 1 hour ago (milliseconds)
     end: Date.now(),               // Current time
     limit: 100,                    // Positive integer
     direction: 'backwards'
   });
   ```
   <!-- Code source: Based on https://ably.com/docs/storage-history/history#channel-history, adapted for error scenarios -->

2. **Avoid duplicate parameters**
   - Ensure start/end parameters appear only once in the query
   - Use either query string OR options object, not both
   - Check for accidental parameter duplication in HTTP requests

3. **Validate limit values**
   - Must be a positive integer (> 0)
   - Maximum typically 1000 per request
   - Use pagination for larger result sets

### For Message and Annotation Errors

<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 51-60, 89-97, 158-168 -->

1. **Ensure compatible message formats with annotations**
   ```javascript
   // ❌ Wrong: String data with annotations
   channel.publish({
     name: 'message',
     data: 'simple string',  // Error: must be object or array
     annotations: { ... }
   });
   
   // ✅ Correct: Object or array data with annotations
   channel.publish({
     name: 'message',
     data: { text: 'message content' },  // Object format
     annotations: { timestamp: Date.now() }
   });
   ```

2. **Provide message serials when required**
   ```javascript
   // ❌ Wrong: Empty serial with annotations
   const message = {
     serial: '',  // Error: Message serial can not be empty
     annotations: { ... }
   };
   
   // ✅ Correct: Valid serial value
   const message = {
     serial: 'unique-serial-123',
     annotations: { ... }
   };
   ```

3. **Use correct publish parameter patterns**
   ```javascript
   // ✅ Correct patterns for publishing:
   
   // Pattern 1: Name and data
   channel.publish('event-name', { data: 'value' });
   
   // Pattern 2: Single message object
   channel.publish({ name: 'event', data: 'value' });
   
   // Pattern 3: Array of messages
   channel.publish([
     { name: 'event1', data: 'value1' },
     { name: 'event2', data: 'value2' }
   ]);
   ```

## Automatic Handling

This is a client error that will not be automatically retried. You must fix the invalid parameter value before the operation will succeed. The SDKs will not attempt to correct or retry these validation errors.

## Prevention

<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 150-177 -->
<!-- Source: Analysis patterns from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md -->

- **Validate parameters before API calls**: Check data types and ranges match API requirements
- **Use SDK validation methods**: Many SDKs provide built-in validation helpers
- **Test with minimal values first**: Start with known-good parameters during development
- **Check environment compatibility**: Ensure OpenSSL support for encryption operations (PHP)
- **Review API documentation**: Verify parameter constraints for each operation
- **Implement type checking**: Use TypeScript or runtime type validation for JavaScript
- **Monitor error patterns**: Track 40003 errors to identify common issues in your application
- **Use consistent timestamp formats**: Prefer milliseconds for all time-based parameters

## Performance Impact

While this error doesn't directly impact performance, repeated validation failures can:
- Delay application functionality
- Increase unnecessary API calls
- Create poor user experience with failed operations

Consider implementing client-side validation to catch these errors before making API requests.

## Related Resources

- [Token Authentication](https://ably.com/docs/auth/token)
- [Encryption Guide](https://ably.com/docs/channels/options/encryption)
- [LiveObjects Documentation](https://ably.com/docs/products/liveobjects)
- [History API](https://ably.com/docs/storage-history/history)
- [API Limits](https://ably.com/docs/general/limits)
- [Message Formats](https://ably.com/docs/channels/messages)
- Related errors: [40001](./40001-invalid-request-body.mdx), [40004](./40004-invalid-header.mdx), [40005](./40005-invalid-credential.mdx), [40009](./40009-maximum-message-length-exceeded.mdx), [40012](./40012-invalid-client-id.mdx), [40013](./40013-invalid-message-data-or-encoding.mdx)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40003
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40003-invalid-parameter-value.mdx (enhanced and updated)
- Repository Overviews: Not needed for this error code
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - TTL limits from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 21-42
  - Token configuration advice lines 140-147
- Content Enhanced:
  - Added Slack discussion insights about revocable token confusion (lines 265-267, 285-292)
  - Included all error message variations from comprehensive analysis
  - Added performance impact section
  - Expanded prevention best practices
- Content Excluded: 
  - Detailed OpenSSL cipher method listings (too implementation-specific)
  - Internal Cassandra offset details (not customer-facing)
- Recommendations Source: 
  - Token TTL: FAQ content from knowledge file lines 140-147, enhanced with Slack insights
  - Encryption: Knowledge file lines 45-65, analysis lines 64-88
  - LiveObjects: Analysis file lines 16-47 with type validation patterns
  - History: Knowledge file lines 67-88, analysis lines 102-126
  - Messages: Analysis lines 51-60, 89-97, 158-168
- Code Examples Rationale: 
  - Included practical examples showing both incorrect and correct usage
  - Based on actual error scenarios from codebase analysis
  - Focused on most common error patterns from production
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Token TTL): FAQ content https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 21-31, Slack discussions lines 285-292
  - Cause 2 (Encryption): PHP SDK analysis https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 64-88
  - Cause 3 (LiveObjects): JavaScript SDK https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 16-47
  - Cause 4 (History): Server implementation https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 102-126
  - Cause 5 (Messages): Multiple SDKs https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 51-60, 89-97, 158-168
- Resolution Steps: 
  - Token TTL: FAQ advice https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 140-147, Slack cases lines 265-267, 285-292
  - Encryption: Knowledge base https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 45-65, analysis lines 64-88, 172-176
  - LiveObjects: Error patterns https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 16-47
  - History: Solutions https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 67-88, analysis lines 102-126
  - Messages: Patterns https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-analysis.md lines 51-60, 89-97, 158-168
- Prevention: Best practices https://github.com/ably/ably-os/blob/main/output/error-codes/research/40003-knowledge.md lines 150-177, enhanced with SDK patterns
- Performance Impact: New section based on production insights from Slack discussions and support tickets
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Clear documentation on revocable token TTL limits (only 1 hour max) - causes confusion as seen in multiple Slack threads
- Impact: Developers unaware of different TTL limits for revocable vs standard tokens, leading to repeated errors
- Recommendation: Add prominent section on revocable token limitations to auth documentation
- Severity: Medium - causes confusion and support tickets

- Missing: Comprehensive LiveObjects type requirements in main docs
- Impact: Developers encounter type errors without clear guidance
- Recommendation: Add type validation examples to LiveObjects documentation
- Severity: Low - mostly caught during development
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40003
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40003 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->