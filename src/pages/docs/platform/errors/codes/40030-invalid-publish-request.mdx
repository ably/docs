<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40030 -->
<!-- Generated: 2025-08-21T17-17-40-434Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document the most common cause (invalid extras field) while acknowledging the generic nature of this error -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40030: Invalid publish request

## What Happened

Your publish request to Ably was malformed and could not be processed.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40030 | 400 | Client Error (Publishing) | No - requires fixing the request format |

## Quick Fix

- Check if you're sending an `extras` field - it must be a plain object, not a string or array
- Verify your message structure matches the API documentation
- Review the specific error message for details about what's invalid

## Error Messages

You'll see one of these messages:
- "Invalid publish request (unspecified)"
- "extras if present must be an object"

## Common Causes

1. **Invalid extras field format** (90% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-analysis.md lines 15-36 -->
   - Sending `extras` as a string instead of an object
   - Using JSON.stringify on the extras value
   - Sending `extras` as a number, boolean, or array
   - Form-encoded requests with incorrectly structured extras

2. **Malformed message structure** (10% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 27-28 -->
   - General publish request validation failure
   - Invalid parameter combinations

## Resolution Steps

1. **If the error mentions "extras must be an object"**
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-analysis.md lines 21-25 -->
   
   Check your publish code - the `extras` field must be a plain JavaScript object:
   
   ❌ **Wrong: Sending extras as a string**
   ```javascript
   channel.publish({
     name: 'message',
     data: 'Hello',
     extras: JSON.stringify({ ref: 'some-ref' }) // This is a string!
   });
   ```
   
   ✅ **Correct: Sending extras as an object**
   ```javascript
   channel.publish({
     name: 'message', 
     data: 'Hello',
     extras: { ref: 'some-ref' } // Plain object
   });
   ```
   <!-- Code source: Based on customer case from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 41-45 -->

2. **For REST API requests with form encoding**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 41-45 -->
   
   When using `Content-Type: application/x-www-form-urlencoded`, structure your data properly. The `extras` field cannot be sent as a simple form field - use JSON content type instead:
   
   ```bash
   curl -X POST https://rest.ably.io/channels/my-channel/messages \
     -H "Content-Type: application/json" \
     -H "Authorization: Basic YOUR_API_KEY" \
     -d '{"name":"event","data":"hello","extras":{"ref":"123"}}'
   ```

3. **Review your publish request structure**
   <!-- Source: Ably documentation at https://ably.com/docs/api/rest-sdk#publish -->
   
   Ensure your message follows the correct format:
   - `name`: (optional) Event name as a string
   - `data`: Message payload (string, JSON object, or buffer)
   - `extras`: (optional) Must be a plain object or omitted entirely
   - `id`: (optional) Unique message ID for idempotency

4. **Check the full error message**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 75-76 -->
   
   Error 40030 often includes specific details beyond the generic message. Look for additional context in the error response that indicates exactly what's invalid.

## Automatic Handling

This is a client error that indicates a problem with your request format. Ably SDKs will not automatically retry this error as it requires you to fix the request structure.

## Prevention

- Always pass `extras` as a plain JavaScript object, never as a stringified JSON
- Omit the `extras` field entirely if you don't need it
- Use JSON content type for REST API requests when sending complex objects
- Validate message structure before publishing in production code

## Related Resources

- [Publishing messages documentation](https://ably.com/docs/channels#publish)
- [Message structure reference](https://ably.com/docs/api/rest-sdk#message)
- Related errors: [40009](https://ably.com/docs/platform/errors/codes/40009) (message too large), [40032](https://ably.com/docs/platform/errors/codes/40032) (impermissible extras field)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40030
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40030)
- Existing Documentation: None found - this is new documentation
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Customer support case about form-encoded extras from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 41-45
- Content Excluded: None - all relevant information included
- Recommendations Source: 
  - extras validation pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-analysis.md lines 40-45
  - Form encoding solution from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 75-83
- Code Examples Rationale: Included extras object example because it's the primary cause (90% of cases) and essential for resolution
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Invalid extras): Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-analysis.md lines 15-36 and customer case from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 41-45
  - Cause 2 (Malformed structure): From protocol definition https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 5-8
- Resolution Steps:
  - Step 1 (extras object): Source from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-analysis.md lines 21-25 - showing actual validation code
  - Step 2 (REST API): Customer case from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 41-45
  - Step 3 (request structure): Based on Ably docs https://ably.com/docs/api/rest-sdk#publish
  - Step 4 (error details): Guidance from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-knowledge.md lines 75-76
- Prevention: Based on common patterns from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40030-analysis.md lines 40-45
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40030
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40030 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->