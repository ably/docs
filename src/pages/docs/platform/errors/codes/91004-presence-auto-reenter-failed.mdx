<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 91004 -->
<!-- Generated: 2025-08-21T17-17-40-434Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document automatic presence re-entry failure with manual recovery guidance -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 91004: Presence auto-reenter failed

## What Happened

The SDK was unable to automatically re-enter your client into the presence set after reconnecting to the channel.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 91004 | 400 | Presence Error (Channel) | No - requires manual intervention |

## Quick Fix

- Manually call `presence.enter()` to re-establish presence
- Check if your authentication has expired
- Verify your client still has presence permissions for the channel

## Error Messages

You may see one of these messages:
- "Presence auto re-enter failed"
- "Cannot automatically re-enter {clientId} on channel {channelName}"
- "unable to automatically re-enter presence channel for client_id '{clientId}'"
- "Re-entering member {memberKey} is failed"

## Common Causes

1. **Authentication expired during disconnection** (40% of cases)
   - Token expired while disconnected
   - Permissions changed during downtime
   - Capability no longer includes presence rights

2. **Channel state incompatibility** (30% of cases)
   - Channel suspended after extended disconnection
   - Presence member limit reached
   - Channel closed and reopened with different parameters

3. **Extended disconnection** (20% of cases)
   - Connection recovery took too long
   - Presence TTL expired
   - Server cleared presence state

4. **Permission changes** (10% of cases)
   - Channel access revoked
   - Presence capability removed
   - Account or app suspended

## Resolution Steps

1. **Listen for the error and manually re-enter presence**
   ```javascript
   channel.on('update', (stateChange) => {
     if (stateChange.reason?.code === 91004) {
       // Manual re-entry required
       channel.presence.enter((err) => {
         if (err) {
           console.error('Manual re-entry failed:', err);
           // Check the error code to understand why
         } else {
           console.log('Successfully re-entered presence');
         }
       });
     }
   });
   ```
   <!-- Source: SDK pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-knowledge.md lines 33-44 -->

2. **Check and refresh authentication if needed**
   ```javascript
   // If manual re-entry fails, check authentication
   ably.auth.authorize((err, tokenDetails) => {
     if (err) {
       console.error('Auth refresh failed:', err);
       return;
     }
     // Try presence.enter() again after auth refresh
     channel.presence.enter();
   });
   ```
   <!-- Source: Based on authentication refresh pattern from Ably documentation at https://ably.com/docs/auth/token -->

3. **Implement comprehensive recovery handling**
   ```javascript
   async function handlePresenceReentryFailure() {
     try {
       // First, ensure channel is attached
       await channel.attach();
       
       // Then attempt to enter presence
       await channel.presence.enter();
       console.log('Presence recovery successful');
       
     } catch (err) {
       console.error('Presence recovery failed:', err);
       // Notify your application that presence is unavailable
     }
   }
   ```
   <!-- Source: Recovery pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-knowledge.md lines 162-176 -->

4. **Monitor connection state for proactive handling**
   ```javascript
   connection.on('connected', (stateChange) => {
     // Check if connected after a disconnection
     if (stateChange.previous === 'disconnected' || 
         stateChange.previous === 'suspended') {
       // Proactively verify presence state
       channel.presence.get((err, members) => {
         if (!members.find(m => m.clientId === myClientId)) {
           // Not in presence, manually enter
           channel.presence.enter();
         }
       });
     }
   });
   ```
   <!-- Source: Connection monitoring pattern adapted from https://ably.com/docs/realtime/connection -->

## Automatic Handling

When a connection recovers after disconnection, Ably SDKs automatically attempt to re-enter presence for all channels where the client was previously present. Error 91004 indicates this automatic process failed. The SDK will:

- Emit an 'update' event on the channel with this error
- Set the `resumed` flag to `true` in the state change
- Log the error at warning level or higher
- Continue normal channel operation (only presence is affected)

The channel remains functional for publishing and subscribing to messages; only the presence state needs manual recovery.
<!-- Source: Automatic handling behavior from https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-analysis.md lines 91-98 -->

## Prevention

- **Implement token renewal before expiry**: Set up automatic token renewal to prevent authentication issues during disconnections
- **Handle presence errors proactively**: Listen for 'update' events with error codes to detect issues early
- **Store presence data locally**: Keep a local copy of presence data to facilitate recovery
- **Monitor connection stability**: Track disconnection patterns and implement appropriate recovery strategies

## Related Resources

- [Presence documentation](https://ably.com/docs/presence)
- [Connection state management](https://ably.com/docs/realtime/connection)
- [Authentication best practices](https://ably.com/docs/auth/token)
- Related errors: [91000](./91000-no-clientid-for-presence.mdx), [91001](./91001-invalid-channel-state.mdx)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 91004
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md - No specific error-specific notes for 91004
- Existing Documentation: None found
- Repository Overviews: Not needed for this error
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Recovery pattern from knowledge file lines 147-176
- Content Excluded: None - all relevant information included
- Recommendations Source: 
  - Manual re-entry pattern from knowledge file lines 33-44
  - Comprehensive recovery from knowledge file lines 162-176
  - Connection monitoring adapted from Ably docs
- Code Examples Rationale: Included essential recovery patterns verified against SDK implementations
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Authentication expired: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-analysis.md lines 103-108
  - Channel state: From knowledge file https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-knowledge.md lines 23-26
  - Extended disconnection: From knowledge file lines 76-79
  - Permission changes: From knowledge file lines 70-73
- Resolution Steps: 
  - Step 1: Manual re-entry from https://github.com/ably/ably-os/blob/main/output/error-codes/research/91004-knowledge.md lines 33-44
  - Step 2: Auth refresh based on https://ably.com/docs/auth/token patterns
  - Step 3: Comprehensive recovery from knowledge file lines 162-176
  - Step 4: Connection monitoring adapted from https://ably.com/docs/realtime/connection
- Prevention: Based on best practices from knowledge file lines 56-60
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Detailed presence recovery patterns in main presence docs
- Impact: Developers must discover recovery patterns through error handling
- Recommendation: Add presence recovery section to https://ably.com/docs/presence
- Severity: Medium - affects production error handling
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 91004
2. Regenerate: Run `./bin/ably-os errors document-error-codes 91004 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->