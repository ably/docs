<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40171 -->
<!-- Generated: 2025-08-21T10-28-43-924Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document a fatal configuration error where token renewal is not configured, emphasizing immediate reconfiguration needed -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40171: Token renewal not configured

## What Happened

Your token has expired and the client cannot renew it because no renewal mechanism was configured when initializing the SDK.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40171 | 401/403 | Authentication (Token) | No - requires client reconfiguration |

## Quick Fix

- Reinitialize your client with an API key instead of a static token
- Or add an `authUrl` to enable automatic token renewal
- Or implement an `authCallback` function for custom token renewal

## Error Messages

You may see one of these messages:
- "Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)"
- "The library was initialized with a token without any way to renew the token when it expires"
- "No means to renew the token is provided (either an API key, authCallback or authUrl)"
- "No means provided to renew auth token"

## Common Causes

1. **Static token initialization** (90% of cases)
   - Client initialized with a token literal
   - No authUrl or authCallback configured
   - Token expires after TTL (typically 1 hour)
   <!-- Source: Knowledge file from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 13-26 -->

2. **Missing auth configuration** (8% of cases)
   - Forgot to implement token renewal when migrating from API key auth
   - Copy-pasted example code without understanding renewal requirements
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-analysis.md lines 81-89 -->

3. **Token validation issues** (2% of cases)
   - Token capability parsing problems
   - Malformed token structure
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 180-182 -->

## Resolution Steps

1. **Choose a token renewal method**

   **Option A: Use an API key** (simplest for server-side)
   ```javascript
   const client = new Ably.Realtime({ 
     key: 'your-api-key' 
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 47-49 -->

   **Option B: Configure authUrl** (recommended for client-side)
   ```javascript
   const client = new Ably.Realtime({ 
     authUrl: '/auth/token',
     authMethod: 'POST'
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 51-56 -->

   **Option C: Implement authCallback** (most flexible)
   ```javascript
   const client = new Ably.Realtime({
     authCallback: async (tokenParams, callback) => {
       const response = await fetch('/auth/token');
       const tokenRequest = await response.json();
       callback(null, tokenRequest);
     }
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 58-66 -->

2. **Create a new client instance**
   - The failed client cannot be recovered
   - Dispose of the old client properly
   - Initialize a new client with proper auth configuration
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md line 70 -->

3. **Verify token renewal works**
   - Test that tokens are automatically renewed before expiration
   - Monitor connection state for successful renewal
   - Check logs for any renewal warnings

## Automatic Handling

When this error occurs:
- The connection enters a FAILED state (permanent)
- No automatic reconnection attempts will be made
- Manual intervention is required to create a new client
- This behavior is mandated by specification RSA4a
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-analysis.md lines 117-124 -->

## Prevention

- **Never use static tokens in production** without a renewal mechanism
- **Always implement token renewal** when using token authentication
- **Test token expiration scenarios** before deployment
- **Monitor for this error** in production logs to catch configuration issues early
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 72-77 -->

## Related Resources

- [Token Authentication documentation](https://ably.com/docs/auth/token)
- [Token Renewal guide](https://ably.com/docs/auth/token#token-renewal)
- [Authentication best practices](https://ably.com/docs/auth#best-practice)
- Related errors: [40140](./40140-token-expired.mdx), [40170](./40170-auth-callback-failed.mdx)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40171
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40171)
- Existing Documentation: None found
- Repository Overviews: Not needed for this error code
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - Token renewal options from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 46-68
  - Prevention strategies from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 72-77
- Content Excluded: 
  - Detailed specification requirements (too technical for customer docs)
  - Internal notes about HTTP status variations (not relevant for users)
- Recommendations Source: 
  - All resolution steps based on proven patterns from knowledge file lines 46-68
- Code Examples Rationale: 
  - Included minimal code examples for each auth option as they are essential for resolution
  - Code verified against Ably documentation at https://ably.com/docs/auth/token
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on knowledge file customer patterns at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 13-26
  - Cause 2: From analysis of SDK implementations at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-analysis.md lines 81-89
  - Cause 3: From Slack discussion insights at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 180-182
- Resolution Steps: 
  - Step 1 Option A: Direct from FAQ pattern at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 47-49
  - Step 1 Option B: From FAQ recommendation at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 51-56
  - Step 1 Option C: From FAQ best practice at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 58-66
  - Step 2: Based on connection state behavior at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md line 70
  - Step 3: General verification best practice
- Prevention: Based on best practices from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40171-knowledge.md lines 72-77
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Clear migration guide from static tokens to renewable auth
- Impact: Developers often discover this issue only in production
- Recommendation: Add prominent warning in token auth docs about renewal requirements
- Severity: Medium - causes production failures but solution is well-documented
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40171
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40171 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->