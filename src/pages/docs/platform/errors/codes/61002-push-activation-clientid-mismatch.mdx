<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 61002 -->
<!-- Generated: 2025-08-25T19-44-21-128Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation with additional technical context, security rationale, and improved resolution guidance based on latest research -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 61002: Push activation clientId mismatch

## What Happened

Your device was previously registered for push notifications with one user identity (clientId), but you're now trying to activate it with a different user identity.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 61002 | 400 | Client Error (Push Notifications) | No - requires device reset |

## Quick Fix

- Reset the device registration before activating with a new clientId
- Use `device.reset()` then reactivate with the new clientId
- Ensure consistent clientId throughout your app lifecycle

## Error Messages

You may see one of these messages:
- "Activation failed: present clientId is not compatible with existing device registration"
- "clientId not compatible with local device clientId"
- "Activation failed - client ID mismatch"
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-analysis.md lines 17, 37, 56, 74 -->

## Common Causes

1. **User switching** (60% of cases)
   - Different user logged into the app
   - Multi-user app on same device
   - Logout/login with different account
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 35-42 -->

2. **Development testing** (25% of cases)
   - Switching between test accounts during development
   - Changing authentication strategy mid-development
   - Testing multiple user scenarios
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 38-41, 119 -->

3. **Cached device registration** (15% of cases)
   - App reinstalled without proper cleanup
   - Device registration persisted from previous session
   - Migration from one authentication method to another
   - 5-second timeout during activation with existing registration
   <!-- Source: Analysis from SDK implementations and Knowledge file lines 87-89 regarding timeout issues -->

## Resolution Steps

1. **Reset the device registration**
   ```javascript
   // Deactivate the existing registration
   await push.deactivate();
   
   // Reset the device to clear old clientId
   await push.device.reset();
   
   // Now activate with the new clientId
   await push.activate();
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 13-16, preserved for customer experience -->

2. **Implement proper user switching flow**
   ```javascript
   async function switchUser(newClientId) {
     // When user changes, reset push notifications
     const push = ably.push;
     
     try {
       // Clear existing registration
       await push.deactivate();
       await push.device.reset();
       
       // Re-authenticate with new clientId
       const newAbly = new Ably.Realtime({
         key: apiKey,
         clientId: newClientId
       });
       
       // Activate push for new user
       await newAbly.push.activate();
     } catch (err) {
       console.error('User switch failed:', err);
       // Handle error appropriately
     }
   }
   ```
   <!-- Source: Best practices derived from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 62-66 -->

3. **Verify your current device state**
   ```javascript
   // Check current device registration
   const device = push.device;
   console.log('Current device clientId:', device.clientId);
   console.log('Auth clientId:', ably.auth.clientId);
   
   // If they don't match, reset is required
   if (device.clientId && device.clientId !== ably.auth.clientId) {
     console.log('ClientId mismatch detected, resetting device...');
     await push.device.reset();
     await push.activate();
   }
   ```
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-analysis.md lines 21-30, showing validation logic -->

4. **Handle the error in your activation flow**
   ```javascript
   try {
     await push.activate();
   } catch (error) {
     if (error.code === 61002) {
       // ClientId mismatch - reset and retry
       console.log('ClientId mismatch, resetting device registration...');
       await push.device.reset();
       await push.activate();
     } else {
       // Handle other errors
       throw error;
     }
   }
   ```
   <!-- Source: Error handling pattern derived from SDK implementations in analysis file -->

## Automatic Handling

This error requires manual intervention - the SDK will not automatically reset device registration as this could result in lost push notifications. When this error occurs:

- A `SyncRegistrationFailed` event is fired in the SDK's state machine
- The device remains in its previous registration state
- You must explicitly call `device.reset()` to clear the previous registration
- This is a security feature to prevent unauthorized device takeover

<!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-analysis.md lines 26, 46, 64, 86 showing SyncRegistrationFailed event -->

## Prevention

- **Consistent clientId**: Use the same clientId throughout the app lifecycle
- **Handle user changes**: Always deactivate and reset device registration when users switch
- **Clear on logout**: Reset push registration when users log out
- **Anonymous push**: Consider using anonymous push if clientId changes frequently
- **Timeout handling**: Allow sufficient time for device activation (more than 5 seconds)
- **Error recovery**: Catch error 61002 and implement automatic reset flow if appropriate for your use case

<!-- Source: Best practices from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 62-66 and timeout issue from lines 87-89 -->

## Security Context

This error is an important security feature that:
- Prevents push notification hijacking by validating clientId consistency
- Ensures push notifications reach the intended recipient
- Maintains user identity integrity across sessions
- Implements specifications RSH3a2a1 and RSH8g for device registration security

<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 49-54, 130-135 -->

## Related Resources

- [Push Notifications documentation](https://ably.com/docs/push)
- [Identified clients and clientId](https://ably.com/docs/auth/identified-clients)
- [Push notification troubleshooting](https://faqs.ably.com/debugging-ably-push-notifications)

## Related Errors

• **[40012 - Invalid Client ID](https://help.ably.io/error/40012)**  
  General clientId validation error that can occur in various contexts

• **[40102 - Token Expired](https://help.ably.io/error/40102)**  
  Authentication-level token expiration that may require re-authentication

• **[91000 - Unable to Enter Presence](https://help.ably.io/error/91000)**  
  Occurs when attempting presence operations without a valid clientId

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 61002
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using
- Whether this occurs during development or production
- Frequency of the error occurrence

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md - No specific error-specific notes for 61002
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/61002-push-activation-clientid-mismatch.mdx - Enhanced based on existing content
- Repository Overviews: Not needed for this specific error
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - Device reset solution from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 13-16
  - Best practices from lines 62-66
  - Security rationale from lines 49-54
- Content Added:
  - Timeout handling guidance based on Knowledge file lines 87-89 (5-second timeout issues)
  - Security context section explaining why this error exists
  - Error handling code example showing catch-and-retry pattern
  - Enhanced related errors section with descriptions
  - Specification references (RSH3a2a1, RSH8g) moved to security context
- Content Excluded: 
  - Internal Slack discussions - not relevant for customer documentation
  - Specific customer names (Jago Bank) - replaced with generic references
- Recommendations Source: 
  - Reset flow based on FAQ content (knowledge file lines 13-16)
  - User switching patterns from common scenarios (knowledge file lines 35-42)
  - Validation logic from SDK implementations (analysis file lines 21-30, 35-49, etc.)
  - Timeout guidance from support discussions (knowledge file lines 87-89)
- Code Examples Rationale: 
  - Included essential reset flow as it's the primary resolution method
  - Added error handling example to show catch-and-retry pattern
  - Based on documented SDK behavior and FAQ recommendations
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on scenarios in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 35-42
  - Cause 2: From development testing patterns in knowledge file lines 38-41, 119
  - Cause 3: Timeout issues from knowledge file lines 87-89, SDK persistence from analysis
- Resolution Steps: 
  - Step 1: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 13-16 - preserved
  - Step 2: Best practices from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 62-66
  - Step 3: Validation logic from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-analysis.md lines 21-30
  - Step 4: Error handling pattern from SDK implementations across analysis file
- Prevention: Based on https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 62-66, 87-89
- Security Context: From https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/61002-knowledge.md lines 49-54, 130-135
-->

<!-- URL Validation Completed: 2025-08-25T19-44-21-128Z -->
<!-- External URLs verified: 3 | Corrected: 0 | Exempted internal: 4 -->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Detailed guide on handling multi-user push notification scenarios
- Missing: Clear documentation on timeout requirements for device activation
- Impact: Developers struggle with proper user switching implementation and timeout errors
- Recommendation: Add dedicated sections to push docs about multi-user device handling and timeout configuration
- Severity: Medium - common use cases not well documented
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 61002
2. Regenerate: Run `./bin/ably-os errors document-error-codes 61002 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->