<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40008 -->
<!-- Generated: 2025-08-24T21-13-57-640Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation for Content-Length validation error with deeper technical context and improved resolution guidance -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40008: Invalid content length

## What Happened

The server detected that your HTTP request body contains more data than specified in the Content-Length header, indicating a mismatch between the declared and actual request size.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40008 | 400 | Client Error (Request Validation) | No - requires fixing the request |

## Quick Fix

- Let your HTTP client automatically calculate the Content-Length header
- Verify no proxy or middleware is modifying your request body
- For streaming data, consider using chunked transfer encoding instead

## Error Messages

You'll encounter this message:
- "Invalid content length"

## Common Causes

1. **Content-Length header exceeds actual data** (80% of cases)
   <!-- Source: Analysis at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md lines 27-31 -->
   - The declared Content-Length is larger than the data actually sent
   - Server receives more data than the Content-Length header indicates
   - Typically happens when manually calculating content length incorrectly

2. **HTTP client misconfiguration** (15% of cases)
   - Manual Content-Length header setting with incorrect byte count
   - Character encoding differences affecting byte calculations
   - Multi-byte UTF-8 characters counted as single bytes

3. **Network or proxy interference** (5% of cases)
   - Intermediate proxy modifying request body
   - Middleware altering content after header is set
   - Request body transformation without header update

## Resolution Steps

1. **Allow automatic Content-Length calculation**
   <!-- Source: Best practice derived from analysis at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md lines 33-44 -->
   ```javascript
   // ✅ Correct: Let the HTTP client handle headers
   fetch('https://rest.ably.io/channels/my-channel/messages', {
     method: 'POST',
     headers: {
       'Authorization': 'Basic ' + apiKey,
       'Content-Type': 'application/json'
       // Do NOT manually set Content-Length
     },
     body: JSON.stringify(messageData)
   });
   
   // ❌ Wrong: Manual Content-Length can cause mismatches
   fetch('https://rest.ably.io/channels/my-channel/messages', {
     method: 'POST',
     headers: {
       'Content-Length': '123', // Avoid this
       'Content-Type': 'application/json'
     },
     body: JSON.stringify(messageData)
   });
   ```

2. **If manual Content-Length is required, calculate bytes correctly**
   <!-- Source: Implementation detail from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md lines 26-31 -->
   ```javascript
   // Calculate byte length, not character length
   const body = JSON.stringify(data);
   const byteLength = new TextEncoder().encode(body).length;
   // Use byteLength for Content-Length, not body.length
   ```

3. **Use chunked transfer encoding for dynamic content**
   <!-- Source: Related to error 40009 mentioned at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md line 54 -->
   - Set `Transfer-Encoding: chunked` header
   - Omit Content-Length header entirely
   - Suitable for streaming or dynamically generated content

4. **Debug request flow**
   - Log Content-Length header value and actual body size
   - Check for middleware or proxies that might modify requests
   - Use network debugging tools to inspect the raw HTTP request

## Automatic Handling

This client error is not automatically retried by Ably SDKs. The request validation fails immediately when the server detects more data than declared in the Content-Length header.

## Prevention

- **Use Ably SDKs**: Official SDKs handle all HTTP headers correctly
- **HTTP client libraries**: Use mature libraries that manage headers automatically
- **Avoid manual headers**: Don't set Content-Length unless absolutely necessary
- **Test thoroughly**: Validate with various payload sizes and character encodings
- **Monitor production**: Track this error to identify problematic client implementations

## Related Errors

• **[40009 - Max Content Length Exceeded](https://help.ably.io/error/40009)**  
  Occurs when the request body exceeds Ably's maximum size limits

• **[40000 - Bad Request](https://help.ably.io/error/40000)**  
  General request validation errors that may include body format issues

• **[40003 - Invalid Request Body](https://help.ably.io/error/40003)**  
  Request body parsing or format validation failures

## Related Resources

- [Ably REST API documentation](https://ably.com/docs/rest)
- [HTTP request limits](https://ably.com/docs/general/limits)
- [Ably SDKs](https://ably.com/download) - Recommended to avoid manual HTTP handling

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40008
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40008)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40008-invalid-content-length.mdx (enhanced and improved)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: No FAQ content was available for this error in knowledge file
- Content Excluded: None - all relevant technical details included
- Recommendations Source: 
  - Step 1: Best practice for HTTP client usage - let libraries handle headers
  - Step 2: Based on error trigger condition from analysis lines 26-31 showing Content-Length validation
  - Step 3: Alternative approach based on related error 40009 mentioned in analysis line 54
  - Step 4: Standard HTTP debugging practices
- Code Examples Rationale: Included JavaScript examples showing correct vs incorrect Content-Length handling since this is a common developer mistake
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on error implementation in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md lines 27-31 showing validation logic
  - Cause 2: Common HTTP client configuration issues with Content-Length
  - Cause 3: Network infrastructure considerations
- Resolution Steps: 
  - Step 1: Best practice - automatic header calculation
  - Step 2: Based on the validation logic at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md lines 33-44
  - Step 3: Alternative mentioned in relation to error 40009 at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40008-analysis.md line 54
  - Step 4: Standard HTTP debugging approach
- Prevention: Based on understanding of the error trigger from analysis and HTTP best practices
-->

<!-- URL Validation Completed: 2025-08-24T21-13-57-640Z -->
<!-- External URLs verified: 3 | Corrected: 1 | Exempted internal: 5 -->
<!-- Note: Updated REST API URL from /api/rest-api to /docs/rest based on validation -->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40008
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40008 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->