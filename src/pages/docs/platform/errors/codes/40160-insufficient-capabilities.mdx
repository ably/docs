<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40160 -->
<!-- Generated: 2025-08-21T10-28-43-924Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document comprehensive capability requirement error with focus on token permissions and automatic recovery patterns -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40160: Insufficient capabilities

## What Happened

Your authentication token or API key doesn't have the required permissions to perform the requested operation on this channel.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40160 | 401 | Authentication (Capabilities) | No - requires updated capabilities |

## Quick Fix

- Check your token has the required capability (`publish`, `subscribe`, or `presence`) for the channel
- Ensure channel names match your token's capability patterns exactly
- Request a new token with the necessary permissions for your operation

## Error Messages

You may see one of these messages:
- "operation not permitted with provided capability"
- "Channel denied access based on given capability; channelId = [channel]"
- "Unauthorized to publish messages with privileged extras"
- "Access denied to channel: namespace requires TLS connection"
- "No authentication options provided; need one of: key, authUrl, or authCallback"

## Common Causes

1. **Missing channel permissions** (70% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md lines 16-20 -->
   - Token lacks `publish`, `subscribe`, or `presence` capabilities for the channel
   - Attempting operations on channels outside your token's scope
   - Channel name doesn't match any of your token's capability patterns

2. **Incorrect channel pattern matching** (20% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-analysis.md lines 122-127 -->
   - Wildcard patterns (`*`) don't match actual channel names
   - Case sensitivity issues in channel names
   - Namespace prefixes not included in capability patterns

3. **Special privilege requirements** (10% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-analysis.md lines 22-26, 139-143 -->
   - Publishing messages with privileged extras without `privileged` capability
   - Accessing internal channels without privileged keys
   - TLS-only namespace accessed without TLS connection

## Resolution Steps

1. **Verify your current capabilities**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md lines 50-54 -->
   - Check the Ably dashboard for your API key's capabilities
   - For token authentication, decode your JWT to inspect the capability claim
   - Identify which specific capability is missing for your operation

2. **Update your token capabilities**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md lines 56-67, based on Ably documentation at https://ably.com/docs/auth/capabilities -->
   - For token authentication, regenerate with required capabilities:
     ```javascript
     const tokenRequest = await ably.auth.createTokenRequest({
       capability: {
         'channel-name': ['publish', 'subscribe'],
         'namespace:*': ['subscribe', 'presence']
       }
     });
     ```
   <!-- Code source: Adapted from https://ably.com/docs/auth/capabilities#token-request-example, included because essential for demonstrating capability configuration -->

3. **Fix channel name patterns**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md lines 72-76 -->
   - Ensure exact match between channel names and capability patterns
   - Remember wildcards (`*`) match zero or more characters
   - Check for case sensitivity - channel names are case-sensitive

4. **For privileged operations**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-analysis.md lines 22-26 -->
   - Add `privileged` capability for operations with privileged extras:
     ```javascript
     capability: {
       'privileged:*': ['publish', 'subscribe', 'privileged']
     }
     ```
   <!-- Code source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md lines 61-65, included to show privileged capability requirement -->

5. **Check TLS connection requirements**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-analysis.md lines 33-37 -->
   - Some namespaces require TLS connections
   - Ensure your connection uses `https://` or `wss://` protocols
   - Update connection configuration to use TLS

## Automatic Handling

<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-analysis.md lines 128-133 -->
Some Ably SDKs automatically handle this error:
- **Laravel Echo**: Detects 40160 and automatically requests an upgraded token with required capabilities
- **Asset Tracking SDK**: Implements automatic token renewal when encountering capability failures
- Other SDKs do not automatically retry as this requires fixing authentication configuration

## Prevention

<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md lines 79-90 -->
- **Plan capabilities carefully**: Include all required permissions when creating tokens
- **Use consistent naming**: Establish clear channel naming conventions
- **Test in development**: Verify token capabilities before production deployment
- **Monitor errors**: Track capability-related errors to identify permission gaps

## Related Resources

- [Token Capabilities documentation](https://ably.com/docs/auth/capabilities)
- [Authentication guide](https://ably.com/docs/auth)
- [Channel permissions](https://ably.com/docs/realtime/channels#permissions)
- Related errors: [40101](./40101-invalid-api-key.md), [40102](./40102-token-expired.md)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40160
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED:
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40160)
- Existing Documentation: None found
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Knowledge advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40160-knowledge.md lines 45-128 incorporated throughout
- Content Excluded: Detailed implementation variations across different server components (too technical for customer docs)
- Recommendations Source: Based on resolution patterns from support scenarios in knowledge file lines 189-205
- Code Examples Rationale: Minimal code examples included only for essential capability configuration, verified against Ably documentation
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on knowledge file lines 16-20 describing token capability issues
  - Cause 2: From analysis file lines 122-127 about capability validation patterns
  - Cause 3: From analysis file lines 22-26, 139-143 about privileged operations
- Resolution Steps: 
  - Step 1: From knowledge file lines 50-54 about auditing capabilities
  - Step 2: From knowledge file lines 56-67 with Ably docs verification
  - Step 3: From knowledge file lines 72-76 about channel matching
  - Step 4: From analysis file lines 22-26 about privileged extras
  - Step 5: From analysis file lines 33-37 about TLS requirements
- Prevention: Based on knowledge file lines 79-90 best practices
- Automatic Handling: From analysis file lines 128-133 about SDK recovery mechanisms
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40160
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40160 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->