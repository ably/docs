<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40011 -->
<!-- Generated: 2025-08-21T10-28-43-924Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document dual usage of 40011 - both channel enumeration API pagination issues and Python SDK data validation -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40011: Stale ring state or invalid data payload

## What Happened

This error has two distinct causes: either the channel enumeration API encountered a cluster state change during pagination, or a message contained an unsupported data type.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40011 | 400 | Client Error (Validation) | No - requires fixing the request |

## Quick Fix

- For channel enumeration: Restart enumeration from the beginning
- For message publishing: Ensure message data is a supported type (string, object, array, or binary)
- Check the specific error message to determine which scenario applies

## Error Messages

You may see one of these messages:
- "stale ring state" - Channel enumeration pagination became invalid
- "Invalid data payload" - Message data type not supported (Python SDK)

## Common Causes

### 1. Channel Enumeration Pagination Issue (Most Common)
<!-- Source: Knowledge file FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 14-17 -->
When using the [channel enumeration API](https://ably.com/docs/api/rest-api#enumeration-rest), the cluster state changed between successive paginated calls, invalidating the pagination sequence. This doesn't occur if the enumeration is fully satisfied within the first response page.

### 2. Invalid Message Data Type (Python SDK)
<!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-analysis.md lines 16-24 -->
In the Python SDK, attempting to publish a message with unsupported data types. Supported types are: bytes, str, list, dict, bytearray, or None.

## Resolution Steps

### For Channel Enumeration Issues

1. **Restart the enumeration**
   <!-- Source: Knowledge file advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 37-41 -->
   - When you receive this error, start the enumeration again from the beginning
   - The cluster state has changed, making your current pagination cursor invalid

2. **Optimize your enumeration strategy**
   - Request larger page sizes to minimize pagination needs
   - Consider caching enumeration results with an appropriate TTL
   - Implement automatic retry logic that restarts from the beginning

3. **Handle the error gracefully**
   ```javascript
   // Example retry logic for channel enumeration
   async function enumerateChannels() {
     try {
       // Your enumeration logic here
     } catch (error) {
       if (error.code === 40011) {
         // Restart enumeration from beginning
         return enumerateChannels();
       }
       throw error;
     }
   }
   ```
   <!-- Code source: Based on resolution pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 105-108 -->

### For Invalid Data Payload (Python SDK)

1. **Validate your message data type**
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-analysis.md lines 58-60 -->
   - Ensure your data is one of: bytes, str, list, dict, bytearray, or None
   - Primitive numbers and custom objects are not directly supported

2. **Convert unsupported types**
   ```python
   # Convert numbers to strings or include in dict
   # ❌ Wrong: Publishing a raw number
   channel.publish('event', 42)  # Will raise error 40011
   
   # ✅ Correct: Convert to supported type
   channel.publish('event', str(42))  # As string
   channel.publish('event', {'value': 42})  # In dict
   ```
   <!-- Code source: Based on Python SDK validation from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-analysis.md lines 21-24 -->

## Automatic Handling

This is a client error that will not be automatically retried. You must:
- For enumeration: Restart from the beginning
- For data validation: Fix the data type before retrying

## Prevention

### Channel Enumeration
<!-- Source: Knowledge file advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 37-41 -->
- Request larger page sizes to complete enumeration in a single request when possible
- Build retry logic into your enumeration code
- Consider whether you need real-time enumeration or if cached results would suffice

### Message Publishing
- Always validate data types before publishing
- Use SDK-appropriate data structures
- Implement type checking in your application code

## Related Resources

- [Channel Enumeration API](https://ably.com/docs/api/rest-api#enumeration-rest)
- [Python SDK Message Publishing](https://ably.com/docs/realtime/messages#publish)
- [Ably API Error Codes](https://ably.com/docs/platform/errors/codes)
- Related errors: [40000](./40000-bad-request.md) (Bad Request), [40013](./40013-invalid-message-data.md) (Invalid message data)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40011
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md [No specific error-specific notes for 40011]
- Existing Documentation: None found
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - Channel enumeration explanation from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 14-17
  - Resolution advice for enumeration from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 37-41
  - Slack discussion insights from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 48-65
- Content Excluded: Internal Slack permalinks and overly technical cluster topology details
- Recommendations Source: 
  - Enumeration retry: Based on official docs and Slack discussions
  - Data validation: From Python SDK implementation
- Code Examples Rationale: Included minimal examples to demonstrate correct vs incorrect patterns based on SDK implementation
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Enumeration): Based on official docs quoted in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 14-17
  - Cause 2 (Python): From SDK code at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-analysis.md lines 16-24
- Resolution Steps: 
  - Step 1 (Enumeration): Knowledge file advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 37-41
  - Step 2 (Python validation): Based on SDK validation rules from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-analysis.md lines 58-60
- Prevention: Based on resolution patterns from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40011-knowledge.md lines 98-108
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40011
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40011 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->