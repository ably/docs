<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40099 -->
<!-- Generated: 2025-08-25T19-44-21-128Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Documenting an internal testing error reserved for artificial errors, with dual purpose for user claims processing failures -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40099: Internal Testing Error

## What Happened

The system encountered a testing-related error or failed to process message metadata correctly.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40099 | 400 | Client Error (Testing/Development) | No - indicates configuration or testing issue |

## Quick Fix

- Remove any `_forceNack` parameters from your requests
- Check if you're using undocumented testing parameters
- Verify message structure if using advanced message features

## Error Messages

You may see one of these messages:
- "Message rejected by request"
- "Unable to add userClaim to message"

## Common Causes

1. **Testing parameter in production** (Most common)
   - Using `_forceNack=true` parameter in requests
   - This is an internal testing parameter not intended for production use
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 23-29 -->

2. **Message metadata processing failure** (Rare)
   - Internal failure when adding user claims to message extras
   - Related to privileged message handling features
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 16-21 -->

3. **SDK test expectations** (Development only)
   - Expected error when running SDK integration tests
   - Part of test validation for error handling paths
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-knowledge.md lines 102-104 -->

## Resolution Steps

1. **Check for testing parameters**
   - Review your publish requests for any `_forceNack` parameter
   - Remove this parameter as it's intended for internal testing only
   - This parameter forces message rejection for testing purposes
   <!-- Source: Testing pattern identified in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 43-47 -->

2. **Review message structure**
   - If you're using advanced message features, verify your message structure
   - Ensure message extras and metadata are properly formatted
   - Check that any protobuf structures are valid
   <!-- Source: User claims pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 49-53 -->

3. **For SDK testing**
   - If you're intentionally testing error handling, this error is expected
   - The `_forceNack` parameter deliberately triggers this error
   - Used to validate SDK error propagation and handling
   <!-- Source: SDK testing context from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 33-39 -->

## Automatic Handling

This error is not automatically retried by Ably SDKs as it indicates either:
- Intentional testing behavior via the `_forceNack` parameter
- A structural issue with the request that requires correction
- Message metadata processing failure that needs investigation

## Prevention

- Never use undocumented parameters like `_forceNack` in production code
- Ensure message structures conform to Ably's documented format
- Keep testing code separate from production implementations

## Related Resources

- [Ably Channels Documentation](https://ably.com/docs/channels)
- [Message Structure Documentation](https://ably.com/docs/channels#messages)

## Related Errors

• **[40000 - Bad Request](https://faqs.ably.com/error-code-40000-bad-request)**  
  General bad request error that may occur instead of 40099 in some SDK versions

• **[40012 - Invalid Client ID](https://faqs.ably.com/error-code-40012-invalid-client-id)**  
  Related to client identity issues that might affect user claims processing

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40099
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED:
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40099)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40099-internal-testing-error.mdx (enhanced from existing)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: No FAQ content existed for this error
- Content Excluded: 
  - Detailed protobuf implementation details (too technical for customer docs)
  - Slack conversation details about test failures (internal information)
  - Commit history details (not relevant for customers)
- Recommendations Source: 
  - Testing parameter removal: Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 23-29
  - Message structure review: From user claims pattern in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 49-53
- Code Examples Rationale: No code examples included as this is primarily an internal error not meant for customer use, and providing examples might encourage misuse of testing parameters
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Testing parameter): Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 23-29, showing _forceNack parameter usage
  - Cause 2 (Message metadata): From Go implementation analysis in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 16-21
  - Cause 3 (SDK test expectations): From knowledge base in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-knowledge.md lines 102-104
- Resolution Steps: 
  - Step 1: Source from testing pattern analysis in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 43-47
  - Step 2: Based on user claims handling pattern in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 49-53
  - Step 3: From SDK testing context in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40099-analysis.md lines 33-39
- Prevention: Based on analysis of error patterns and best practices
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Documentation of the user claims feature and message extras structure
- Impact: Users encountering the "unable to add userClaim to message" variant have no reference
- Recommendation: Document the message extras and user claims features if they're customer-facing
- Severity: Low (this appears to be an internal feature)
-->

<!-- URL Validation Completed: 2025-08-25T19-44-21-128Z -->
<!-- External URLs verified: 3 | Corrected: 2 | Exempted internal: 5 -->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40099
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40099 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->