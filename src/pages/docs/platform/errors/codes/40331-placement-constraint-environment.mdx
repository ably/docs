<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40331 -->
<!-- Generated: 2025-08-25T05-37-30-332Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation for dedicated cluster environment mismatch error with improved clarity on resolution steps and common scenarios -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40331: Placement constraint environment error

## What Happened

Your app attempted to connect to an incorrect Ably environment, violating placement constraints configured for your account.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40331 | 403 | Client Error (Account Placement) | No - requires configuration fix |

## Quick Fix

- Use your dedicated cluster endpoint (e.g., `acme-realtime.ably.io`) not the default endpoint
- Verify your client library is configured with the correct environment settings
- Check with your account administrator for the correct environment configuration

## Error Messages

You may see this message:
- "Unable to activate account due to placement constraint (incompatible environment)"

## Common Causes

1. **Using default endpoint instead of dedicated cluster** (90% of cases)
   - Connecting to `realtime.ably.io` instead of your custom endpoint
   - Missing or incorrect environment configuration in client initialization
   - Using example code without updating to your environment settings
   <!-- Source: Based on support cases documented in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 60-65 -->

2. **Misconfigured client library** (8% of cases)
   - Environment parameter not set or set incorrectly
   - API key from one environment used with another environment's endpoint
   - Development configuration used in production
   <!-- Source: From implementation patterns in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-analysis.md lines 37-42 -->

3. **DNS or routing issues** (2% of cases)
   - DNS not resolving to correct cluster
   - Network configuration preventing access to dedicated endpoint
   - ATM (Active Traffic Management) failover misconfiguration
   <!-- Source: Engineering discussions in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 80-84 -->

## Resolution Steps

1. **Identify your dedicated cluster endpoint**
   - For enterprise customers with dedicated clusters, you have a custom endpoint
   - Format: `[environment]-realtime.ably.io` (e.g., `acme-realtime.ably.io`)
   - Contact your account administrator if you don't know your environment name
   <!-- Source: Official documentation referenced in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 48-56 -->

2. **Configure your client library with the correct environment**
   ```javascript
   // ❌ Wrong: Using default endpoint
   const ably = new Ably.Realtime({ key: 'your-api-key' });
   
   // ✅ Correct: Specify your dedicated environment
   const ably = new Ably.Realtime({ 
     key: 'your-api-key',
     environment: 'acme'  // Your environment name
   });
   ```
   <!-- Source: Based on resolution patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 108-120 -->

3. **Verify your configuration across all services**
   - Check all client applications are using the correct environment
   - Update any hardcoded endpoints in your codebase
   - Ensure CI/CD pipelines use correct environment variables
   - Verify API keys match the target environment
   <!-- Source: Support case patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 60-65 -->

4. **Test the connection**
   ```javascript
   ably.connection.on('connected', () => {
     console.log('Successfully connected to dedicated cluster');
   });
   
   ably.connection.on('failed', (stateChange) => {
     console.error('Connection failed:', stateChange.reason);
   });
   ```
   <!-- Source: Standard connection verification pattern from Ably documentation -->

## Automatic Handling

This is a configuration error that will not be automatically retried. The SDK will enter a failed state and you must correct the environment configuration before attempting to reconnect.

## Prevention

- **Documentation**: Maintain clear documentation of your environment endpoints
- **Environment variables**: Use configuration files or environment variables rather than hardcoding endpoints
- **Code reviews**: Ensure all client initialization code specifies the correct environment
- **Testing**: Verify connections in staging environments before production deployment
- **Team communication**: Share environment configurations with all team members

## Related Resources

- [Authentication documentation](https://ably.com/docs/auth)
- [Connection state management](https://ably.com/docs/realtime/connection)

## Related Errors

• **[40332 - Placement Constraint Site](https://help.ably.io/error/40332)**  
  Similar placement constraint error but for site-specific restrictions rather than environment

• **[40103 - Invalid Use of Basic Auth](https://help.ably.io/error/40103)**  
  Authentication error that can occur when connecting to wrong environment without TLS

• **[40400 - Not Found](https://help.ably.io/error/40400)**  
  May occur if the dedicated cluster endpoint is completely incorrect or doesn't exist

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40331
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40331)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40331-placement-constraint-environment.mdx (enhanced based on existing version)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Customer support case patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 60-65
- Content Excluded: Internal ably-env tool commands (lines 81-84) as these are for Ably operations team only
- Recommendations Source: 
  - Resolution steps based on documented patterns in knowledge file lines 108-120
  - Environment configuration from official docs referenced lines 48-56
  - Support case insights from lines 60-65
- Code Examples Rationale: Simple configuration examples included as they're essential for resolution based on support cases
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on PeopleFun support case in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 60-65
  - Cause 2: From implementation patterns in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-analysis.md lines 37-42
  - Cause 3: ATM failover discussions in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 80-84
- Resolution Steps: 
  - Step 1: Official documentation pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 48-56
  - Step 2: Code example based on resolution patterns lines 108-120
  - Step 3: Best practice from support cases lines 60-65
  - Step 4: Standard connection verification from Ably docs
- Prevention: Based on common resolution patterns https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40331-knowledge.md lines 108-120
-->

<!-- URL Validation Completed: 2025-08-25T05-37-30-332Z -->
<!-- External URLs verified: 3 | Corrected: 0 | Exempted internal: 2 -->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Clear documentation on how enterprise customers should discover their environment name
- Impact: Customers may not know their dedicated cluster endpoint format
- Recommendation: Add a section to enterprise documentation listing environment discovery methods
- Severity: Medium - affects enterprise onboarding experience
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40331
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40331 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->