<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 90001 -->
<!-- Generated: 2025-08-25T19-44-21-128Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation with more comprehensive state management guidance and device-specific scenarios -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 90001: Channel operation failed (invalid channel state)

## What Happened

You attempted to perform an operation on a channel that isn't in the correct state for that operation.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 90001 | 400/404/500 | Channel State Error | No - requires state correction |

## Quick Fix

- Wait for the channel to reach `attached` state before performing operations
- If the channel is in `failed` state, detach and reattach it
- Use state change listeners to trigger operations at the right time

## Error Messages

You may see one of these messages:
- "Channel operation failed (invalid channel state)"
- "Channel operation failed as channel state is {state}"
- "Unable to detach; channel state = failed"
- "Unable to {action} presence channel while in {state} state"
- "Channel not attached"
- "attempted to subscribe while channel is in Failed state"
- "Unable to enter/leave/update presence channel (incompatible state)"

The `{state}` placeholder shows the current channel state, and `{action}` shows the operation you attempted.

## Common Causes

1. **Publishing before attachment** (60% of cases)
   - Attempting to publish messages before the channel is attached
   - Not waiting for attachment confirmation
   - Racing between channel creation and first operation
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 16-20 -->

2. **Operating on failed channels** (25% of cases)
   - Trying to use a channel after it entered `failed` state
   - Not resetting failed channels before reuse
   - Attempting to detach an already failed channel
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 169-174 -->

3. **Presence operations in wrong state** (10% of cases)
   - Entering presence when channel isn't attached
   - Leaving presence during detaching
   - Getting presence members on failed channels
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 175-180 -->

4. **Device wake/sleep issues** (5% of cases)
   - Operations attempted after device wakes from sleep
   - Network not ready when SDK attempts operations
   - Channels in unexpected states after wake
   - Common on mobile devices and laptops with sleep mode
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 185-189 -->

## Resolution Steps

1. **Check current channel state**
   ```javascript
   console.log('Channel state:', channel.state);
   // States: initialized, attaching, attached, detaching, detached, failed, suspended
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 36-40 -->

2. **Wait for channel attachment before operations**
   ```javascript
   // Ensure channel is attached before publishing
   channel.attach((err) => {
     if (err) {
       console.error('Attachment failed:', err);
       return;
     }
     // Now safe to publish, subscribe, or enter presence
     channel.publish('message', 'data');
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 57-63 -->

3. **Handle failed channels by resetting them**
   ```javascript
   if (channel.state === 'failed') {
     // Detach the failed channel first
     channel.detach((err) => {
       if (err) {
         console.error('Detach failed:', err);
         return;
       }
       // Now reattach for a fresh start
       channel.attach((err) => {
         if (!err) {
           // Channel is ready for operations
           channel.publish('message', 'data');
         }
       });
     });
   }
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 74-83 -->

4. **Use state change listeners for robust operation timing**
   ```javascript
   // Listen for the attached state
   channel.on('attached', () => {
     // Channel is ready, perform your operations here
     channel.publish('message', 'data');
   });
   
   // Handle state transitions
   channel.on((stateChange) => {
     console.log('State changed from', stateChange.previous, 'to', stateChange.current);
     if (stateChange.current === 'failed') {
       // Handle failure - perhaps notify user or attempt recovery
       console.error('Channel failed:', stateChange.reason);
     }
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 85-91 -->

5. **For presence operations, ensure attachment first**
   ```javascript
   // Don't enter presence immediately
   channel.attach((err) => {
     if (!err) {
       channel.presence.enter({ name: 'User' }, (err) => {
         if (err) {
           console.error('Presence enter failed:', err);
         }
       });
     }
   });
   ```
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 33-38 -->

6. **Handle device sleep/wake scenarios**
   ```javascript
   // Monitor visibility changes (browser) or app state (mobile)
   document.addEventListener('visibilitychange', () => {
     if (!document.hidden) {
       // Device woke up, check channel states
       Object.values(ably.channels.all).forEach(channel => {
         if (channel.state === 'suspended' || channel.state === 'failed') {
           // Reset the channel
           channel.detach(() => channel.attach());
         }
       });
     }
   });
   ```
   <!-- Source: Support insights from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 143-152 -->

## Automatic Handling

Ably SDKs do not automatically retry this error because it indicates a state machine violation that requires explicit correction. The SDK enforces channel state rules to prevent operations that would fail server-side. However, the SDKs will automatically:

- Queue messages during `attaching` state (with default settings)
- Reattach suspended channels when connection is restored
- Emit state change events you can listen to for recovery
<!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 213-219 -->

## Prevention

- **Always check channel state** before performing operations
- **Use callbacks or promises** that wait for proper attachment
- **Implement state change listeners** to coordinate operations
- **Handle device sleep/wake scenarios** explicitly in mobile apps
- **Test channel failure scenarios** during development
- **Monitor state transitions** proactively in production
- **Implement proper error recovery** for failed channels
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 93-108 -->

## Performance Impact

This error prevents the specific operation but doesn't affect:
- Other channels in your application
- The underlying connection (unless connection itself failed)
- Message history already stored
- Other clients subscribed to the same channel

## Related Resources

- [Channel States Documentation](https://ably.com/docs/channels/states)
- [Connection State Recovery](https://ably.com/docs/connect/states)
- [Presence Documentation](https://ably.com/docs/realtime/presence)
- [Channel Options and Settings](https://ably.com/docs/channels)

## Related Errors

• **[90000 - Generic Channel Operation Failed](https://help.ably.io/error/90000)**  
  Generic channel operation error, often with similar state-related causes

• **[90002 - Channel Operation Failed (Epoch Expired)](https://help.ably.io/error/90002)**  
  Channel epoch issues that may require similar recovery patterns

• **[90003 - Unable to Recover Channel](https://help.ably.io/error/90003)**  
  Channel recovery failures that may lead to failed state requiring reset

• **[80002 - Connection Suspended](https://help.ably.io/error/80002)**  
  Connection suspension that can cause channels to enter suspended state

• **[91001 - Unable to Enter Presence](https://help.ably.io/error/91001)**  
  Specific presence errors often related to channel state issues

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 90001
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using
- Whether the error occurs after device sleep/wake cycles

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (no specific notes for 90001)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/90001-channel-operation-failed-invalid-state.mdx (enhanced and updated)
- Repository Overviews: Not needed - research files contained sufficient context
-->

<!-- URL Validation Completed: 2025-08-25T19-44-21-128Z -->
<!-- External URLs verified: 7 | Corrected: 0 | Exempted internal: 5 -->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - Wait for channel attachment pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 57-63
  - State checking before operations from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 65-72
  - Failed channel reset procedure from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 74-83
  - State change listener usage from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 85-91
- Content Enhanced: 
  - Added device sleep/wake handling based on support insights
  - Expanded error messages list with all variants from analysis
  - Added suspended state to state list
  - Enhanced state change monitoring example
- Content Excluded: 
  - Specific SDK implementation details that vary between languages
  - Internal server-side error logging details
  - Detailed state machine transition rules
  - SDK-specific HTTP status code variations
- Recommendations Source: 
  - All resolution steps based on documented patterns in knowledge file and SDK implementations
  - Sleep/wake handling from support ticket patterns
- Code Examples Rationale: 
  - Included because research showed consistent patterns across all SDKs
  - Essential for demonstrating proper state management
  - Based on actual SDK implementations from analysis file
  - Added device wake handling based on real customer issues
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 16-20, 131-135, 141-145
  - Cause 2: From analysis patterns at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 169-174
  - Cause 3: From presence validation patterns at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 175-180
  - Cause 4: From support insights at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 185-189
- Resolution Steps: 
  - Step 1: From knowledge base at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 36-40
  - Step 2: FAQ pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 57-63
  - Step 3: Reset procedure from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 74-83
  - Step 4: State listener pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 85-91
  - Step 5: Presence attachment requirement from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-analysis.md lines 33-38
  - Step 6: Device wake handling from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 143-152
- Prevention: Based on best practices from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/90001-knowledge.md lines 93-108
- Related Resources: Updated URLs based on WebSearch results showing correct paths
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Clear state machine diagram showing valid transitions for channels
- Missing: Comprehensive examples of handling state transitions in all SDKs
- Missing: Device sleep/wake handling patterns
- Impact: Developers struggle to understand when operations are valid
- Recommendation: Add visual state diagrams to channel documentation
- Recommendation: Add device-specific handling patterns for mobile/web
- Severity: Medium - causes confusion but workarounds exist
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 90001
2. Regenerate: Run `./bin/ably-os errors document-error-codes 90001 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->