---
title: "Media sharing with Ably Chat"
meta_description: "How to share media such as images, videos, or files with Ably Chat"
meta_keywords: "image, file, media, sharing, Ably Chat, chat SDK, realtime messaging, dependability, cost optimisation"
---

A common requirement for chat applications is the ability to share media such as images, videos, or files. It is very straightforward to add media links to Chat messages via the message metadata.

This guide will show you one way media sharing can be implemented with Ably Chat. We focus on images, but the same principles apply to videos or any type of file.

## Architecture overview

The general approach for implementing image sharing in Ably Chat is:

1. Upload the image to your own storage service. This can be your own servers, or a third-party service like AWS S3.
2. Use the `metadata` field when [sending a message](/docs/chat/rooms/messages#send) to store the relevant information about the image (ie. file ID or URL).
3. On the receiving end, display the image when a message with the relevant metadata is received.

## Implementation guide

We'll build a simple chat room where users can share images with each other.

We assume that `room` is an Ably chat room that is attached. Please refer to our [getting started guide](/docs/chat/getting-started/javascript) for step-by-step instructions on how to set up Ably Chat and get a chat room.

### Upload an image

Write the upload flow and make it available in the chat app context. For example:

```javascript
async function uploadImage() {
  // ask user to pick a picture (or any media or file, depending on your use case)
  // upload the picture to your storage service
  // return the unique identifier for the image

  // mock implementation:
  let imageId = 'abcd123abcd';

  // Some image metadata, useful for displaying the image in the UI
  let title = 'A beautiful image';
  let width = 1024;
  let height = 768;

  // Return the image object
  return { id: imageId, title, width, height };
}
```

Make sure that the identifier returned is unique and can be used to retrieve the image from the storage service.

### Send a message with images

When a user uploads an image, for example by clicking a button called "attach", use the `uploadImage()` flow and save the resulting image object (which contains image ID and other image metadata), like this:

<Code>
```javascript
let imagesToAttach = [];
async function onImageAttach() {
  const imageData = await uploadImage();
  imagesToAttach.push(imageData);
}
```

```react
import { useState } from 'react';

const ChatComponent = () => {
  const [imagesToAttach, setImagesToAttach] = useState([]);

  const onImageAttach = async () => {
    const imageData = await uploadImage();
    setImagesToAttach(prev => [...prev, imageData]);
  };

  return (
    <div>
      <button onClick={onImageAttach}>Attach Image</button>
      {imagesToAttach.map((imageData, index) => (
        <div key={imageData.id}>Image to attach: {imageData.id} ({imageData.title}, {imageData.width}x{imageData.height})</div>
      ))}
    </div>
  );
};
```
</Code>

In your UI, the `imagesToAttach` array should be displayed so that users know which images will be attached to their message. It can allow users to remove or sort the images.

When a user sends a message, check if there are any images to attach, and then send the message with appropriate metadata:

<Code>
```javascript
async function send(text) {
  let metadata = {};
  if (imagesToAttach.length > 0) {
    metadata["images"] = imagesToAttach;
    imagesToAttach = [];
  }
  await room.messages.send({
    text: text,
    metadata: metadata
  });
}
```

```react
import { useState } from 'react';
import { useMessages } from '@ably/chat/react';

const MessageSender = () => {
  const [imagesToAttach, setImagesToAttach] = useState([]);
  const [messageText, setMessageText] = useState('');
  const { send } = useMessages();

  const handleSend = async () => {
    let metadata = {};
    if (imagesToAttach.length > 0) {
      metadata["images"] = imagesToAttach;
    }
    await send({
      text: messageText,
      metadata: metadata
    });
    setImagesToAttach([]);
    setMessageText('');
  };

  const onImageAttach = async () => {
    const imageId = await uploadImage();
    setImagesToAttach(prev => [...prev, imageId]);
  };

  return (
    <div>
      <input
        type="text"
        value={messageText}
        onChange={(e) => setMessageText(e.target.value)}
        placeholder="Type a message..."
      />
      <button onClick={onImageAttach}>Attach Image</button>
      <button onClick={handleSend}>Send</button>
      {imagesToAttach.map((imageId, index) => (
        <div key={index}>Image to attach: {imageId}</div>
      ))}
    </div>
  );
};
```
</Code>

Keep in mind that the message metadata is not validated by the server. Always treat it as untrusted user input. The same applies to the text and headers of a chat message.

### Displaying images

First define a function to get the valid image objects, if any, from a message:

<Code>
```javascript
// assume IDs are 10-15 characters long and alphanumeric
const imageIdRegex = /^[a-z0-9]{10,15}$/;

function getValidImages(message) {
  if (message.metadata.images && message.metadata.images.length > 0) {
    return message.metadata.images.filter(imageData => imageIdRegex.test(imageData.id));
  }
  return [];
}
```

```react
// assume IDs are 10-15 characters long and alphanumeric
const imageIdRegex = /^[a-z0-9]{10,15}$/;

const getValidImages = (message) => {
  if (message.metadata.images && message.metadata.images.length > 0) {
    return message.metadata.images.filter(imageData => imageIdRegex.test(imageData.id));
  }
  return [];
};
```
</Code>

Always validate the metadata before displaying any media to the user. Treat the metadata as untrusted user input. If you are using image IDs, validate they are of the correct format. If you are using URLs, validate the schema, domain, path and query parameters are what you expect. Do not display images or other media directly from the metadata of a message without validation.

Next, make a function or component to display the message and its images. Below is a simple example. Implement this to match the UI of your chat app.

<Code>
```javascript
function createMessageDOM(message) {
  const container = document.createElement("div");
  container.setAttribute('data-message-serial', message.serial)
  container.setAttribute('data-message-version', message.version)

  const text = document.createElement("div");
  text.innerText = message.text;
  container.appendChild(text);
  const validImages = getValidImages(message);
  if (validImages.length > 0) {
    const imagesContainer = document.createElement("div");
    for (let imageData of validImages) {
      const img = document.createElement("img");
      img.src = "https://example.com/images/"+imageData.id;
      img.alt = imageData.title;
      img.width = imageData.width;
      img.height = imageData.height;
      imagesContainer.appendChild(img);
    }
    container.appendChild(imagesContainer);
  }
  return container;
}
```

```react
const imageIdRegex = /^[a-z0-9]{10,15}$/;

const getValidImages = (message) => {
  if (message.metadata.images && message.metadata.images.length > 0) {
    return message.metadata.images.filter(imageId => imageIdRegex.test(imageId));
  }
  return [];
};

const MessageDisplay = ({ message }) => {
  const validImages = getValidImages(message);

  return (
    <div>
      <div>{message.text}</div>
      {validImages.length > 0 && (
        <div>
          {validImages.map((image, index) => (
            <img
              key={image.id}
              src={`https://example.com/images/${image.id}`}
              alt={image.title}
              width={image.width}
              height={image.height}
            />
          ))}
        </div>
      )}
    </div>
  );
};
```
</Code>

Lastly, subscribe to the chat room messages and display the messages. Below are simple examples.
Please refer to our Getting Started guide for [JavaScript](https://ably.com/docs/chat/getting-started/javascript) or [React](https://ably.com/docs/chat/getting-started/react), the [messages docs page](/docs/chat/rooms/messages), or our [in-repo demo chat app](https://github.com/ably/ably-chat-js/tree/main/demo) for more details and complete examples.

<Code>
```javascript
room.messages.subscribe(message => {
  // handle new messages
  if (message.type == ChatMessageEventType.Created) {
    const messageDOM = createMessageDOM(message);
    document.getElementById('messages').appendChild(messageDOM);
    return;
  }

  // this is either an update or a delete, so we need to find the existing message by serial
  const existingMessage = document.querySelector(`[data-message-serial="${message.serial}"]`);
  if (existingMessage) {
    if (message.type == ChatMessageEventType.Updated) {
      // it's an update: update the existing message
      const messageDOM = createMessageDOM(message);
      existingMessage.replaceWith(messageDOM);
    } else {
      // it's a delete: remove the message
      existingMessage.remove();
    }
  }
});
```

```react
export const ChatComponent = () => {
  const [messages, setMessages] = useState([]);

  useEffect(() => {
    room.messages.subscribe(message => {
      if (message.type == ChatMessageEventType.Created) {
        setMessages(prev => [...prev, message]);
      } else if (message.type == ChatMessageEventType.Updated) {
        setMessages(prev => prev.map(m => m.serial === message.serial ? message : m));
      } else {
        setMessages(prev => prev.filter(m => m.serial !== message.serial));
      }
    });
  }, [room]);

  return (
    <>
      {messages.map(message => (
        <MessageDisplay key={message.serial} message={message} />
      ))}
    </>
  )
};
```

</Code>


### Why image ID and not URL?

Image IDs are simpler to validate than full URLs. You can also use URLs, but you must correctly validate them on the receiving end.

### Add an image to an existing message

You can add an image to an existing message by editing its metadata.

<Code>
```javascript
let imageId = 'abcd123abcd'; // assume this is the image we want to add
let message = ...; // assume this is the message we want to edit

const newMetadata = structuredClone(message.metadata);
if (!newMetadata.images) {
  newMetadata.images = [];
}
newMetadata.images.push(imageId);

room.messages.update(message.serial, message.copy({metadata: newMetadata}))
```

```react
import { useMessages } from '@ably/chat/react';

const AddImageToMessage = ({ message }) => {
  const { update } = useMessages();

  const addImageToMessage = async () => {
    const imageId = 'abcd123abcd'; // assume this is the image we want to add
    
    const newMetadata = structuredClone(message.metadata);
    if (!newMetadata.images) {
      newMetadata.images = [];
    }
    newMetadata.images.push(imageId);

    await update(message.serial, message.copy({metadata: newMetadata}));
  };

  return (
    <button onClick={addImageToMessage}>
      Add Image to Message
    </button>
  );
};
```
</Code>

### Remove an image from an existing message

Similarly to adding a new image, an image can be removed from an existing message by updating the message:

<Code>
```javascript
let imageId = 'abcd123abcd'; // assume this is the image we want to remove
let message = ...; // assume this is the message we want to edit

if (!message.metadata.images || message.metadata.images.length === 0) {
  //do nothing if there are no images
  return; 
}
const newMetadata = structuredClone(message.metadata);
newMetadata.images = newMetadata.images.filter(id => imageId !== id);

room.messages.update(message.serial, message.copy({metadata: newMetadata}))
```

```react
import { useMessages } from '@ably/chat/react';

const RemoveImageFromMessage = ({ message }) => {
  const { update } = useMessages();

  const removeImageFromMessage = async () => {
    const imageId = 'abcd123abcd'; // assume this is the image we want to remove
    
    if (!message.metadata.images || message.metadata.images.length === 0) {
      // do nothing if there are no images
      return; 
    }
    
    const newMetadata = structuredClone(message.metadata);
    newMetadata.images = newMetadata.images.filter(id => imageId !== id);

    await update(message.serial, message.copy({metadata: newMetadata}));
  };

  return (
    <button onClick={removeImageFromMessage}>
      Remove Image from Message
    </button>
  );
};
```
</Code>


## Media access control

If the media shared isn't supposed to be public you must add a layer of authentication on the server side to control access to the images.

Do not add signed URLs to the message metadata because everyone who receives the message will have access to the media. Users can share the signed URL which will allow anyone to access the media. Lastly, signed URLs typically have expiration dates and chat messages are probably stored for longer.

Instead, add an authentication layer on the server side to control access to the media. This allows you full control over who can access the files.

If you need to serve the files directly from a service, such as AWS S3, consider saving a file name in the metadata of the message, and have a mechanism for the user to request a signed URL to the file.

## Moderation

Ably Chat's [moderation feature](/docs/chat/moderation) is currently limited to text moderation. To add automatic or human moderation for images (and other attachments) you must implement moderation on the server side. A recommended flow is:

1. Upload the media to your storage service (your own servers, or a third-party service like AWS S3)
2. Asynchronously (server-side) start the moderation process
3. Send a chat message with `metadata` containing information about the shared media (for example: file name or ID)
4. When a user requests the media from your server, you can check the moderation status and serve the media if it is approved or return an error if it is not. You can choose to consider the media "safe" while moderation is ongoing or to block access to the media until moderation is complete.
5. This way, there is no need to update the chat message metadata to reflect the moderation status.
