<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40013 -->
<!-- Generated: 2025-08-21T17-17-40-434Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Comprehensive documentation for message encoding/decoding errors with focus on supported data types and encryption issues -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40013: Invalid message data or encoding

## What Happened

The SDK cannot encode or decode your message because the data type is unsupported or the encoding process failed.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40013 | 400 | Client Error (Message Processing) | No - requires fixing the data format |

## Quick Fix

- Ensure message data is a string, buffer, JSON-serializable object, or array
- For encrypted channels, verify cipher configuration is consistent across clients
- Consider marshalling complex data as JSON before publishing

## Error Messages

You may see one of these messages:
- "Data type is unsupported"
- "Invalid message data or encoding"
- "The single-argument form of publish() expects a message object or an array of message objects"
- "Map value data type is unsupported" (LiveObjects)
- "Invalid data type for 'base64' decoding"
- "Invalid data type for 'json' decoding"
- "decrypt failed"
- "Error processing the {encoding} encoding, decoder returned '{error}'"

## Common Causes

1. **Unsupported data types** (60% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md lines 16-21, 89-92 -->
   - Publishing objects that aren't JSON-serializable
   - Using LiveObjects with unsupported value types
   - Passing wrong argument types to publish()

2. **Encryption/decryption failures** (30% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 73-79, 37-50 -->
   - Cipher configuration mismatch between clients
   - Decryption failures after channel idle periods
   - Race conditions with encryption key handling

3. **Encoding chain failures** (10% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md lines 60-83, 111-114 -->
   - Invalid base64 data
   - Malformed JSON strings
   - UTF-8 encoding of binary data

## Resolution Steps

1. **Validate your message data type**
   <!-- Source: Official docs from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 28-31 -->
   
   Supported types vary by SDK:
   - **JavaScript**: String, Buffer, JSON-serializable objects/arrays
   - **Ruby**: String, Hash, Array, or nil
   - **iOS/macOS**: NSString, NSData, NSArray, NSDictionary
   - **Java**: String, byte[], JsonElement
   
   For complex objects, serialize to JSON first:
   ```javascript
   // ❌ Wrong: Publishing non-serializable object
   channel.publish('update', myComplexObject);
   
   // ✅ Correct: Serialize to JSON first
   channel.publish('update', JSON.stringify(myComplexObject));
   ```
   <!-- Code source: Based on resolution pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 30-31 -->

2. **Fix publish() method arguments** (JavaScript SDKs)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md lines 28-36 -->
   
   ```javascript
   // ❌ Wrong: Invalid single argument
   channel.publish('not-a-message-object');
   
   // ✅ Correct: Use message object
   channel.publish({ name: 'event', data: 'payload' });
   
   // ✅ Correct: Or use name and data arguments
   channel.publish('event', 'payload');
   ```
   <!-- Code source: Based on error patterns from https://github.com/ably/ably-js/blob/main/src/common/lib/client/restchannel.ts#L97 -->

3. **Verify encryption configuration**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 37-50, 118-120 -->
   
   If using encrypted channels, ensure all clients use identical cipher configuration:
   ```javascript
   // All clients must use the same key and options
   const cipherKey = await generateKey();
   const channel = ably.channels.get('encrypted-channel', {
     cipher: { key: cipherKey }
   });
   ```
   <!-- Code source: Based on encryption patterns from Ably documentation -->

4. **Handle LiveObjects data types**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md lines 38-43 -->
   
   For LiveObjects, only use supported types:
   ```javascript
   // ❌ Wrong: Unsupported type
   liveMap.set('key', new Date());
   
   // ✅ Correct: Use supported types
   liveMap.set('key', Date.now()); // number
   liveMap.set('data', { name: 'value' }); // object
   ```
   <!-- Code source: Based on LiveObjects validation from https://github.com/ably/ably-js/blob/main/src/plugins/objects/livemap.ts#L184 -->

## Automatic Handling

This is a client error that will not be automatically retried. The SDK cannot recover from invalid data types or encoding failures - you must fix the data format or configuration before the operation will succeed.

## Prevention

- Always validate data types before publishing
- Use explicit JSON serialization for complex objects
- Maintain consistent cipher configuration across all clients
- Test encoding/decoding with your specific data types in development
- Enable verbose logging to capture full error context during debugging

## Related Resources

- [Message encoding documentation](https://ably.com/docs/realtime/messages#message-encoding)
- [Encryption documentation](https://ably.com/docs/realtime/encryption)
- [LiveObjects documentation](https://ably.com/docs/products/liveobjects)
- Related errors: [40000](./40000-bad-request.md) (general bad request), [92001-92005](./92001-encryption-error.md) (encryption-specific errors)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40013
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED:
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (no specific notes for 40013)
- Existing Documentation: None found
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Resolution strategy from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 28-31 (JSON/MsgPack marshalling)
- Content Excluded: Some internal Slack discussion details excluded as too implementation-specific
- Recommendations Source:
  - Data type validation: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md lines 16-43
  - Encryption issues: From known production issues in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 37-50
  - Publish method fix: From SDK validation patterns in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md lines 28-36
- Code Examples Rationale: Included minimal examples based on actual SDK patterns from research files, essential for demonstrating correct vs incorrect usage
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes:
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md lines 16-21, 38-43, 89-92
  - Cause 2: From production issues documented in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 37-50, 73-79
  - Cause 3: From encoding validation patterns in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-analysis.md lines 60-83, 111-114
- Resolution Steps:
  - Step 1: Source from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 28-31 and analysis of supported types
  - Step 2: From JavaScript SDK validation in https://github.com/ably/ably-js/blob/main/src/common/lib/client/restchannel.ts#L97
  - Step 3: From encryption issues in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 37-50
  - Step 4: From LiveObjects validation in https://github.com/ably/ably-js/blob/main/src/plugins/objects/livemap.ts#L184
- Prevention: Based on resolution strategies from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40013-knowledge.md lines 115-125
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40013
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40013 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->