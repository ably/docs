<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40146 -->
<!-- Generated: 2025-08-21T10-28-43-924Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Documenting a specific limitation error that occurs when developers try to use advanced JWT features (userClaims/limitsClaims) in server-generated tokens. The focus is on clearly explaining the limitation, providing immediate resolution options, and guiding users to appropriate alternatives. -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40146: Unsupported Token Claims

## What Happened

Your token request to Ably's server includes `userClaims` or `limitsClaims`, which are not supported in server-generated tokens.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40146 | 401 | Client Error (Authentication) | No - requires removing unsupported claims or switching to client-side token generation |

## Quick Fix

- Remove `userClaims` and `limitsClaims` from your token request
- Use standard token capabilities instead
- Or switch to client-side token generation if you need these features

## Error Messages

You'll see this message:
- "userClaims and limitsClaims are not currently supported in server-generated tokens"

## Common Causes

1. **Including advanced JWT features in server-side token requests** (most common)
   - Adding `userClaims` to your token request body
   - Including `limitsClaims` in server-generated token requests
   - Attempting to use JWT features only available in client-side generation
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md lines 28-30 -->

2. **Migration from custom token generation**
   - Moving from client-side to server-side token generation without removing unsupported features
   - Copy-pasting token request code that includes these claims
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 18-20 -->

3. **Documentation misunderstanding**
   - Mixing examples meant for client-side and server-side token generation
   - Assuming all JWT features work with server-side generation
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 22-25 -->

## Resolution Steps

### 1. Remove Unsupported Claims

If these claims aren't essential to your application:

1. **Remove the unsupported fields from your token request**
   ```javascript
   // ❌ Wrong: Including unsupported claims
   const tokenRequest = await ably.auth.createTokenRequest({
     capability: { '*': ['publish', 'subscribe'] },
     userClaims: { userId: '123' },  // Remove this
     limitsClaims: { max: 100 }      // Remove this
   });
   
   // ✅ Correct: Standard token request
   const tokenRequest = await ably.auth.createTokenRequest({
     capability: { '*': ['publish', 'subscribe'] }
   });
   ```
   <!-- Source: Resolution approach based on analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md lines 39-40 -->

2. **Use standard token features**
   - Use `clientId` for user identification
   - Use capabilities for access control
   - Store user-specific data in your application
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 77-80 -->

### 2. Switch to Client-Side Token Generation

If you need `userClaims` or `limitsClaims`:

1. **Generate tokens in your application**
   - Use a JWT library in your backend
   - Sign tokens with your Ably API key
   - Include any JWT claims you need
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 42-46 -->

2. **Return signed tokens to clients**
   - Your server generates the complete JWT
   - Clients use the token directly with Ably
   - Full control over all JWT features

See [Ably's token authentication documentation](https://ably.com/docs/auth/token) for implementation details.

### 3. Alternative Approaches

Consider if you actually need these advanced claims:

1. **Use token capabilities** for fine-grained access control
2. **Use clientId** to identify users
3. **Store user metadata** in your own database
4. **Implement custom authorization** in your application layer
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 48-54 -->

## Automatic Handling

This is a validation error that occurs before token generation. Ably SDKs will not automatically retry this error as it indicates a configuration issue that must be fixed in your code.

## Prevention

- **Understand the difference** between server-side and client-side token generation
- **Check feature support** before implementing token generation
- **Test token generation** in development environments
- **Choose the appropriate method** based on your feature requirements
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 56-60 -->

## Token Generation Methods Comparison

### Server-Side Generation (Ably-Managed)
- Simpler implementation
- Standard JWT claims only
- `userClaims` and `limitsClaims` **NOT** supported
- Suitable for basic authentication needs

### Client-Side Generation (Self-Managed)
- Full JWT specification support
- `userClaims` and `limitsClaims` supported
- More complex implementation
- Complete control over token contents
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 62-74 -->

## Related Resources

- [Token Authentication](https://ably.com/docs/auth/token)
- [Token Request API](https://ably.com/docs/api/rest-api#token-request)
- [JWT Token Claims](https://ably.com/docs/auth/token#claims)
- [Authentication Guide](https://ably.com/docs/auth)
- Related errors: [40001](./40001-bad-request.md) (Invalid token request)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40146
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40146)
- Existing Documentation: None found
- Repository Overviews: Not needed for this specific error
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Knowledge file guidance from lines 35-54 incorporated into Resolution Steps
- Content Excluded: None - all relevant information included
- Recommendations Source: 
  - Remove claims approach: Knowledge file lines 35-40
  - Client-side generation: Knowledge file lines 42-46
  - Alternative approaches: Knowledge file lines 48-54
- Code Examples Rationale: Included minimal example showing correct vs incorrect token request structure based on error context
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md lines 28-30
  - Cause 2: From knowledge file at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 18-20
  - Cause 3: From knowledge file at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 22-25
- Resolution Steps: 
  - Step 1: Source from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 35-40 - preserved FAQ advice
  - Step 2: Source from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 42-46 - client-side generation option
  - Step 3: Alternative approaches from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 48-54
- Prevention: Based on https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 56-60
- Token Generation Comparison: From https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 62-74
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40146
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40146 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->