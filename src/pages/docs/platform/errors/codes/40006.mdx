---
title: "Error 40006 - Invalid connectionId"
meta_description: "Information and troubleshooting for Ably error code 40006 - Invalid connectionId or connectionKey"
meta_keywords: "Ably, error, error codes, 40006, invalid connectionId, invalid connectionKey, connection validation"
---

{/* Generated by: ably-os errors document-error-codes */}
{/* Repository: https://github.com/ably/ably-os */}
{/* Command: ./bin/ably-os errors document-error-codes 40006 */}
{/* Generated: 2025-11-07T01-19-51-325Z */}
{/* Sources:
     - Analysis: https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/b819713/src/prompts/errors/editorial-notes.md
*/}
{/* Key Approach: Document multiple causes (connectionKey, connectionId, clientId issues) with specific resolution steps for each scenario */}
{/* Citations: Complete source attribution with line numbers available at bottom of document */}

A message or operation contains an invalid or mismatched `connectionId` or `connectionKey`, preventing the operation from completing.

| Error code | HTTP status code | Category | Retryable |
| ---------- | ---------------- | -------- | --------- |
| 40006 | 400 | Client error (validation) | No |

## Error messages

The following error messages can be returned with error code 40006:

| Message | Description |
| ------- | ----------- |
| Malformed message; invalid connectionKey | The connectionKey format is invalid or doesn't match expected pattern. |
| Malformed message; invalid connectionId | The message contains an invalid connectionId. |
| Malformed message; mismatched connectionId | The connectionId doesn't match the current connection. |
| Malformed state message; invalid connectionId | A state message has an invalid connectionId. |
| Malformed lastEvent | The lastEvent format for connection resume is invalid. |

## Impact

This error prevents the current operation from completing, however it has no impact on:

- Existing active connections (unless occurring during establishment).
- Other channels or operations.
- Messages already delivered.

This is a client error that will not be automatically retried by the SDK. You must correct the invalid connection parameters before the operation will succeed.

## Quick fixes

Try the following quick fixes to resolve the error:

- Remove the `connectionId` from messages - let the SDK handle it automatically.
- When publishing via REST on behalf of a realtime connection, ensure you're using the current `connectionKey`.
- For identified connections, verify the `clientId` matches what was used during authentication.
- After reconnection, obtain fresh connection details before resuming operations.

## Troubleshooting

The following are common causes and how to resolve them for error 40006:

### Invalid connectionKey when publishing via REST

| Error messages |
| -------------- |
| Malformed message; invalid connectionKey |

This occurs when:

- Using REST API to publish on behalf of a realtime connection with an invalid connectionKey.
- The connectionKey format doesn't match the protocol version.
- For identified connections, the clientId is missing or incorrect (though error says "connectionKey").
- Using a connectionKey from a different Ably instance or environment.

To resolve this:

- Obtain the current connectionKey from the active realtime connection.
- Ensure all SDKs are using compatible protocol versions (v2+ for ably-js 1.2.35+).
- For identified connections, include the correct clientId in authentication.

<Code>
```javascript
// Obtain connectionKey from realtime connection
const realtime = new Ably.Realtime({ key: apiKey });
realtime.connection.on('connected', () => {
  const connectionKey = realtime.connection.key;

  // Use this key for REST publishing on behalf
  const rest = new Ably.Rest({ key: apiKey });
  rest.request('post', '/channels/mychannel/messages', {
    connectionKey: connectionKey,
    messages: [{ name: 'event', data: 'message' }]
  });
});
```
</Code>

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-analysis.md lines 44-48 */}
{/* Source: Knowledge from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md lines 117-119 */}

### Mismatched connectionId in messages

| Error messages |
| -------------- |
| Malformed message; invalid connectionId |
| Malformed message; mismatched connectionId |

This occurs when:

- Manually setting a connectionId in messages that doesn't match the current connection.
- Using a connectionId from a previous connection after reconnection.
- Presence messages contain an outdated connectionId.

To resolve this:

- Don't manually set connectionId in messages - the SDK handles this automatically.
- After reconnection events, refresh any stored connection details.
- For presence operations, re-enter presence after connection changes.

<Code>
```javascript
// Wrong: Manually setting connectionId
const message = {
  connectionId: 'some-id', // Don't do this
  name: 'event',
  data: 'payload'
};

// Correct: Let SDK handle connectionId
channel.publish('event', 'payload'); // SDK adds connectionId automatically
```
</Code>

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-analysis.md lines 26-41 */}
{/* Source: Knowledge from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md lines 108-114 */}

### Protocol version incompatibility

| Error messages |
| -------------- |
| Malformed message; invalid connectionKey |

This occurs when:

- Using older SDK versions that don't support Ably protocol v2.
- Cross-SDK communication between incompatible versions (e.g., ably-ruby 1.2.3 with ably-js 1.2.35+).
- ConnectionKey format changed between protocol versions.

To resolve this:

- Update all SDKs to versions supporting protocol v2.
- Ensure consistent SDK versions across your infrastructure.
- See the documentation for your specific SDK for version requirements.

{/* Source: Knowledge from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md lines 75-80 */}

### ClientId validation issues

| Error messages |
| -------------- |
| Malformed message; invalid connectionKey |

This occurs when:

- Publishing on behalf of an identified connection without the correct clientId.
- The error message misleadingly says "connectionKey" when the issue is actually clientId.
- Authentication doesn't include the required clientId.

To resolve this:

- Ensure the clientId used matches what was set during authentication.
- Include the correct clientId when creating tokens for identified connections.
- Verify authentication includes all required identity information.

<Code>
```javascript
// Ensure clientId is consistent
const tokenParams = {
  clientId: 'user-123' // Must match the connection's identity
};

const realtime = new Ably.Realtime({
  authCallback: (tokenParams, callback) => {
    // Generate token with correct clientId
    callback(null, generateToken(tokenParams));
  }
});
```
</Code>

{/* Source: Knowledge from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md lines 91-95 */}

### Invalid lastEvent for connection resume

| Error messages |
| -------------- |
| Malformed lastEvent |

This occurs when:

- Attempting to resume a stateless connection with an invalid lastEvent format.
- The lastEvent doesn't match the expected timeseries prefix format.

To resolve this:

- Ensure lastEvent is in the correct format for your protocol version.
- Don't manually construct lastEvent values.
- Use the lastEvent provided by the SDK from previous connections.

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-analysis.md lines 49-55 */}

## Prevention

To prevent this error:

- Let the SDK manage connectionId and connectionKey automatically.
- Keep all SDKs updated to compatible versions.
- After any connection state change, refresh stored connection details.
- For REST publishing on behalf of realtime connections, always use current connection details.
- Don't manually construct or modify connection-related parameters.

## Related errors

The following errors are related to error code 40006:

| Error code | Description |
| ---------- | ----------- |
| [40012 - Invalid clientId](/docs/platform/errors/codes/40012) | Related to clientId validation which can cause connectionKey validation to fail. |
| [80023 - Connection from different site](/docs/platform/errors/codes/80023) | Occurs when using a connectionKey from a different Ably instance. |
| [80000 - Connection failed](/docs/platform/errors/codes/80000) | General connection failures that may require obtaining new connection details. |

## Need further help?

Contact [Ably support](https://ably.com/support) if you're still experiencing issues after trying the steps listed above.

You'll need to provide:

- Your account ID and app ID.
- The full error message including the error code.
- Steps to reproduce the issue.
- Any relevant code snippets (without any sensitive credentials).
- The SDK and version you're using.

### Resources

The following resources provide further context or assistance with this error:

- [Connection state management](https://ably.com/docs/connect)
- [Publishing messages](https://ably.com/docs/channels)
- [REST API documentation](https://ably.com/docs/api/rest-api)
- [Authentication and identified clients](https://ably.com/docs/auth)

{/* =============================================== */}
{/* INTERNAL DOCUMENTATION (NOT RENDERED) */}
{/* =============================================== */}

{/* SOURCES USED:
- Analysis File: https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/b819713/src/prompts/errors/editorial-notes.md
*/}

{/* CONTENT DECISIONS:
- FAQ Content Preserved: Knowledge about protocol version incompatibility from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md lines 75-80
- FAQ Content Preserved: ClientId validation confusion from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md lines 91-95
- Content Excluded: Specific internal implementation details about HMAC validation
- Recommendations Source: Based on documented patterns from analysis and knowledge files
- Code Examples Rationale: Included minimal examples showing correct vs incorrect usage patterns
*/}

{/* ATTRIBUTION BY SECTION:
- Common Causes:
  - ConnectionKey validation: Based on analysis findings in https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-analysis.md lines 44-48
  - ConnectionId mismatch: From analysis at https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-analysis.md lines 26-41
  - Protocol incompatibility: From knowledge at https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md lines 75-80
  - ClientId issues: From knowledge at https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-knowledge.md lines 91-95
  - LastEvent validation: From analysis at https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40006-analysis.md lines 49-55
- Resolution Steps:
  - REST publishing: Source from https://ably.com/docs/api/rest-api#publish-on-behalf
  - Connection management: Source from https://ably.com/docs/realtime/connection
  - Protocol versions: Based on knowledge from support history
*/}

{/* URL Validation Completed: 2025-11-07T01-19-51-325Z */}
{/* External URLs verified: 5 | Corrected: 0 | Exempted internal: 8 */}

{/* IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40006
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40006 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/b819713/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
*/}