<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 93001 -->
<!-- Generated: 2025-08-21T17-17-40-434Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document annotations feature state requirements based on limited information available -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 93001: Annotations channel state invalid

## What Happened

The channel is not in the correct state to perform annotations operations. The channel must be attached before you can use annotations features.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 93001 | 400 | Client Error (Annotations) | No - requires channel attachment |

## Quick Fix

- Ensure the channel is attached before using annotations
- Wait for the 'attached' event if currently attaching
- Check channel state before annotations operations

## Error Messages

You'll see this message:
- "Annotations channel state invalid for operation"

## Common Causes

1. **Channel not attached** (Most common)
   - Attempting annotations operations immediately after getting channel reference
   - Channel is still in 'initialized' or 'attaching' state
   - Not waiting for attachment to complete

2. **Channel in error state**
   - Channel is in 'suspended', 'failed', or 'detached' state
   - Previous connection error not resolved
   - Channel attachment failed

3. **Premature operation**
   - Race condition between attachment and annotations operation
   - Not using proper event handlers for state transitions

## Resolution Steps

1. **Ensure channel is attached first**
   ```javascript
   // Attach the channel before using annotations
   await channel.attach();
   
   // Now annotations operations are safe
   channel.annotations.subscribe((annotation) => {
     console.log('Annotation received:', annotation);
   });
   ```
   <!-- Source: Resolution approach from https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 25-33 -->

2. **Check channel state before operations**
   ```javascript
   if (channel.state === 'attached') {
     // Safe to use annotations
     channel.annotations.subscribe();
   } else {
     // Wait for attachment
     channel.once('attached', () => {
       channel.annotations.subscribe();
     });
   }
   ```
   <!-- Source: State checking pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 35-44 -->

3. **Handle attachment with callbacks**
   ```javascript
   channel.attach((err) => {
     if (err) {
       console.error('Failed to attach channel:', err);
       return;
     }
     
     // Channel attached successfully, annotations ready
     channel.annotations.subscribe();
   });
   ```
   <!-- Source: Callback pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 25-33 -->

4. **Monitor channel state changes**
   ```javascript
   channel.on('attached', () => {
     console.log('Channel attached - annotations available');
   });
   
   channel.on('detached', () => {
     console.log('Channel detached - annotations unavailable');
   });
   ```

## Automatic Handling

Ably SDKs do not automatically retry annotations operations. You must ensure the channel is attached before attempting annotations operations. The SDK will maintain channel state and emit events when state changes occur.

## Prevention

- Always attach channels before using extended features like annotations
- Implement proper state checking in your initialization code
- Use async/await or callbacks to ensure sequential operations
- Monitor channel state events to handle disconnections gracefully
- Consider implementing a wrapper that ensures attachment before operations

## Code Examples

### Proper Annotations Setup
```javascript
// Initialize Ably client
const ably = new Ably.Realtime({ key: 'your-api-key' });

// Get channel reference
const channel = ably.channels.get('my-channel');

// Ensure channel is attached before using annotations
async function setupAnnotations() {
  try {
    // Wait for channel attachment
    await channel.attach();
    console.log('Channel attached successfully');
    
    // Now safe to use annotations
    channel.annotations.subscribe((annotation) => {
      console.log('Received annotation:', annotation);
    });
    
    // Publish an annotation
    await channel.annotations.publish({
      type: 'comment',
      text: 'This is an annotation'
    });
    
  } catch (error) {
    console.error('Failed to setup annotations:', error);
  }
}

setupAnnotations();
```
<!-- Source: Example pattern combining concepts from https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 25-44 -->

## Related Resources

- [Channel state documentation](https://ably.com/docs/realtime/channels#channel-states)
- [Channel lifecycle events](https://ably.com/docs/realtime/channels#channel-lifecycle)
- Related errors: [91004](https://help.ably.io/error/91004) (Presence state error)

## Need Further Help?

This error code has limited documentation available. If you encounter this error, please contact Ably support at https://ably.com/support with:
- The full error message including error code 93001
- What action triggered the error
- Your account ID and app ID
- The SDK and version you're using
- Any relevant code snippets (without sensitive credentials)

Our support team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 93001)
- Existing Documentation: None found
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: No existing FAQ content was available for this error
- Content Excluded: None - included all available information
- Recommendations Source: 
  - Channel attachment requirement: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-analysis.md lines 22-24
  - State checking patterns: From knowledge file https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 35-44
- Code Examples Rationale: Included state checking and attachment patterns as they are essential for resolving this specific error
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Channel not attached): Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-analysis.md lines 22-23
  - Cause 2 (Channel in error state): From knowledge of channel states in https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 14-20
  - Cause 3 (Premature operation): Inferred from state requirements
- Resolution Steps: 
  - Step 1: Channel attachment pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 25-33
  - Step 2: State checking from https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 35-44
  - Step 3: Callback pattern from https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 25-33
  - Step 4: State monitoring - standard Ably pattern for channel state events
- Prevention: Based on best practices from https://github.com/ably/ably-os/blob/main/output/error-codes/research/93001-knowledge.md lines 46-51
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Comprehensive documentation about the annotations feature
- Impact: Users encountering this error have limited resources to understand annotations
- Recommendation: Add annotations feature documentation to main Ably docs
- Severity: Medium - annotations appears to be an experimental or internal feature
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 93001
2. Regenerate: Run `./bin/ably-os errors document-error-codes 93001 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->