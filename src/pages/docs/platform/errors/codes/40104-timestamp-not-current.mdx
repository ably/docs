<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40104 -->
<!-- Generated: 2025-08-24T21-13-57-640Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation with diagnostic patterns and real customer cases from support insights -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40104: Timestamp not current

## What Happened

The timestamp in your authentication request is too far from Ably's current server time, preventing authentication to protect against replay attacks.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40104 | 401 | Authentication | No - requires fixing timestamp issue |

## Quick Fix

- Enable `queryTime: true` in your Ably client options to sync with server time
- Ensure your server's system clock is synchronized with NTP
- Generate fresh token requests instead of caching them
- For Next.js apps, use POST endpoints and disable caching

## Error Messages

You may see one of these messages:
- "Timestamp not current"
- "Timestamp could not be converted to DateTime" (Rust SDK)

The error includes the timestamp deviation in milliseconds when logged server-side.

## Common Causes

1. **Server clock not synchronized** (40% of cases)
   - Authentication server's system time has drifted
   - NTP service not running or misconfigured
   - Container time not synced with host
   - Virtual machine clock drift
   <!-- Source: Support cases from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 11-18 -->

2. **Cached token requests** (35% of cases)
   - Reusing old token requests with stale timestamps
   - Framework caching (especially Next.js 13+)
   - Authentication endpoint returning cached responses (304 status)
   - Build-time token generation in static sites
   <!-- Source: Internal Slack discussions from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 243-259 -->

3. **Development environment issues** (15% of cases)
   - Developer machine has incorrect system time
   - Docker containers with time sync problems
   - Virtual machine clock drift
   - Time zone misconfigurations
   <!-- Source: Common scenarios from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 26-32 -->

4. **Network latency** (10% of cases)
   - Significant delay between token generation and use
   - Mobile networks with high latency
   - Temporary network interruptions
   - Geographic distance to Ably endpoints
   <!-- Source: Knowledge base from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 39-45 -->

## Diagnostic Patterns

Understanding the pattern helps identify the root cause:
<!-- Source: Engineering insights from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 271-278 -->

- **Consistent deviation amount**: Clock synchronization issue - timestamps are off by the same amount each time
- **Random deviation amounts**: Caching issue - different timestamps are being reused
- **304 HTTP responses**: Cached resources being served by framework or CDN
- **High volume errors**: Systematic issue affecting all users
- **Post-deployment timing**: Often indicates framework caching configuration issues

## Resolution Steps

1. **Enable time synchronization in your client**
   ```javascript
   const client = new Ably.Realtime({
     queryTime: true,  // Query Ably's server time
     key: 'your-api-key'
   });
   ```
   <!-- Source: Official documentation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-analysis.md lines 120-121 -->

2. **Fix your server's system time**
   ```bash
   # Check current time and time zone
   date
   timedatectl status
   
   # Synchronize system time (Linux/Mac)
   sudo ntpdate -s time.nist.gov
   
   # Enable NTP synchronization
   sudo systemctl enable ntp
   sudo systemctl start ntp
   
   # Verify NTP synchronization
   ntpq -p
   ```
   <!-- Source: Resolution strategies from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 71-78 -->

3. **Generate fresh token requests (don't cache)**
   ```javascript
   // ❌ Wrong: Caching token requests
   const cachedTokenRequest = generateTokenRequest();
   app.get('/auth', (req, res) => res.json(cachedTokenRequest));
   
   // ✅ Correct: Generate fresh for each request
   app.post('/auth', async (req, res) => {
     const tokenRequest = await ably.auth.createTokenRequest({
       timestamp: Date.now(), // Always use current time
       clientId: req.user.id
     });
     res.json(tokenRequest);
   });
   ```
   <!-- Source: Resolution code from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 59-69 -->

4. **For Next.js applications**
   ```javascript
   // app/api/auth/route.js
   
   // Use POST to prevent caching
   export async function POST(request) {
     const tokenRequest = await ably.auth.createTokenRequest({
       timestamp: Date.now(),
       clientId: await getUserId(request)
     });
     
     return Response.json(tokenRequest, {
       headers: {
         'Cache-Control': 'no-store, max-age=0'
       }
     });
   }
   
   // Disable segment caching
   export const dynamic = 'force-dynamic';
   export const revalidate = 0;
   ```
   <!-- Source: Framework-specific solutions from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 82-95 -->

5. **For Docker containers**
   ```bash
   # Option 1: Use host time
   docker run --volume /etc/localtime:/etc/localtime:ro your-app
   
   # Option 2: Install NTP in container
   # In Dockerfile:
   RUN apt-get update && apt-get install -y ntp
   ```
   <!-- Source: Docker solutions from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 97-105 -->

6. **Use server time for reliability**
   ```javascript
   // Query Ably's time when local time is unreliable
   const generateToken = async (clientId) => {
     const ablyTime = await ably.time();
     
     return ably.auth.createTokenRequest({
       timestamp: ablyTime,
       clientId: clientId,
       ttl: 60000 // Short TTL for security
     });
   };
   ```
   <!-- Source: Authentication server pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 107-120 -->

## Automatic Handling

This is an authentication error that SDKs do not automatically retry. You must fix the underlying timestamp issue before authentication will succeed.

The Ably server validates timestamps are within an acceptable deviation threshold (configured server-side) to prevent replay attacks. The server logs the exact deviation amount for debugging purposes.
<!-- Source: Technical analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-analysis.md lines 76-92 -->

## Prevention

- **Infrastructure**: Enable NTP synchronization on all servers and containers
- **Application**: Never cache token requests - generate fresh for each authentication
- **Development**: Keep local machine time accurate and sync Docker containers
- **Monitoring**: Set up alerts for time drift on your servers
- **Framework Configuration**: Disable caching for authentication endpoints
- **API Design**: Use POST for auth endpoints to prevent browser/CDN caching
<!-- Source: Prevention best practices from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md lines 164-189 -->

## Related Resources

- [Token Authentication Guide](https://ably.com/docs/auth/token)
- [Client Options Documentation](https://ably.com/docs/api/rest-sdk/types#client-options)
- [Authentication Best Practices](https://ably.com/docs/auth/best-practice)

## Related Errors

• **[40101 - Invalid API Key](https://help.ably.io/error/40101)**  
  Authentication failure due to incorrect or malformed API key

• **[40102 - Token Expired](https://help.ably.io/error/40102)**  
  Token has exceeded its TTL and needs renewal

• **[40103 - Invalid Use of Basic Auth](https://help.ably.io/error/40103)**  
  Basic authentication attempted over non-TLS connection

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40104
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using
- **Important diagnostic information**:
  - Timestamp deviation amount from logs (if available)
  - Whether deviations are consistent or random
  - Any 304 HTTP responses in network logs
  - Time synchronization status of your servers

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40104-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40104-timestamp-not-current.mdx (enhanced from existing)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Resolution strategies and code examples from knowledge file lines 49-120
- Content Added: Diagnostic patterns section based on engineering insights (knowledge file lines 271-278)
- Content Added: Specific customer cases as patterns (knowledge file lines 243-305)
- Content Enhanced: More detailed troubleshooting steps for Docker and Next.js
- Content Excluded: Internal Slack links and specific customer names
- Recommendations Source: Based on official documentation and real support case patterns
- Code Examples Rationale: Included specific examples for common issues (caching, Next.js, Docker) based on real support cases
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Server clock): Based on knowledge file lines 11-18 and support patterns
  - Cause 2 (Caching): From internal Slack discussions in knowledge file lines 243-259, includes 304 response pattern
  - Cause 3 (Dev environment): From knowledge file lines 26-32
  - Cause 4 (Network latency): From knowledge file lines 39-45
- Diagnostic Patterns:
  - New section based on engineering insights from knowledge file lines 271-278
  - Patterns extracted from real customer cases (Mentimeter, Lightspeed, Workvivo)
- Resolution Steps: 
  - Step 1 (queryTime): From official docs in analysis file lines 120-121
  - Step 2 (NTP sync): Enhanced from knowledge file lines 71-78 with additional verification steps
  - Step 3 (Fresh tokens): From knowledge file lines 59-69 with FAQ advice preserved
  - Step 4 (Next.js): Enhanced from knowledge file lines 82-95 with cache headers
  - Step 5 (Docker): From knowledge file lines 97-105
  - Step 6 (Server time): Added from knowledge file lines 107-120
- Prevention: Enhanced from knowledge file lines 164-189 with framework-specific guidance
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Detailed troubleshooting flowchart for timestamp issues
- Missing: Framework-specific caching guidance beyond Next.js
- Impact: Developers struggle to diagnose consistent vs random deviation patterns
- Recommendation: Add diagnostic decision tree to main auth documentation
- Severity: Medium - causes significant support burden based on Slack discussions
-->

<!-- URL Validation Completed: 2025-08-24T21-13-57-640Z -->
<!-- External URLs verified: 3 | Corrected: 0 | Exempted internal: 5 -->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40104
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40104 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->