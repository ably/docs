<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 91001 -->
<!-- Generated: 2025-08-25T19-44-21-128Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation with comprehensive state validation guidance, device wake scenarios, and improved related errors section -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 91001: Presence operation failed due to invalid channel state

## What Happened

The presence operation could not be completed because the channel is not in a valid state to accept presence updates.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 91001 | 400/500 | Channel State (Presence) | Yes - after channel reattachment |

## Quick Fix

- Ensure the channel is attached before entering presence
- Wait for the channel to reach the `attached` state
- Handle channel state transitions in your application

## Error Messages

You may see one of these messages:
- "unable to enter presence channel (invalid channel state)"
- "Unable to enter presence channel in detached or failed state"
- "unable to enter presence channel (incompatible channel state: [state])"
- "Unable to enter presence channel in [state] state"
- "Operation is not allowed when channel is in [state]"
- "Operation failed as channel transitioned to [state]"
- "Enter presence on suspended channel"

## Common Causes

1. **Channel not attached** (60% of cases)
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-analysis.md lines 71-78 -->
   - Attempting presence operations before attaching to channel
   - Channel has become detached due to network issues
   - Channel failed during connection problems

2. **Device wake/sleep cycles** (25% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 91-98 -->
   - Computer resumes after suspension (especially Windows)
   - Mobile app returns from background
   - Network transitions (WiFi to cellular)

3. **Race conditions** (10% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 24-29 -->
   - Channel state changes during presence operation
   - Multiple simultaneous operations on same channel
   - Timing issues during connection recovery

4. **Long-running connections** (5% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 139-141 -->
   - Extended disconnection causing channel suspension
   - Connection state not properly managed
   - Missing error recovery logic

## Resolution Steps

1. **Check channel state before presence operations**
   ```javascript
   // Ensure channel is attached before entering presence
   if (channel.state === 'attached') {
     await channel.presence.enter();
   } else {
     // Wait for attachment
     channel.once('attached', async () => {
       await channel.presence.enter();
     });
   }
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 50-59 -->

2. **Attach to the channel first**
   ```javascript
   // Proper sequencing: attach then enter presence
   await channel.attach();
   await channel.presence.enter({ name: 'User Name' });
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 39-48 -->

3. **Handle channel state transitions**
   ```javascript
   channel.on('detached', () => {
     console.log('Channel detached, presence operations will fail');
     // Attempt to reattach
     channel.attach();
   });
   
   channel.on('attached', () => {
     console.log('Channel attached, presence operations now possible');
     // Re-enter presence if needed
     channel.presence.enter();
   });
   
   channel.on('failed', () => {
     console.log('Channel failed - requires new connection');
     // Handle terminal failure state
   });
   ```
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-analysis.md lines 71-78 -->

4. **Implement recovery for device wake scenarios**
   ```javascript
   // Detect when device wakes from sleep
   document.addEventListener('visibilitychange', () => {
     if (!document.hidden) {
       // Check connection and channel states
       if (ably.connection.state !== 'connected') {
         ably.connect();
       }
       // Reattach channels and re-enter presence
       channel.attach(() => {
         channel.presence.enter();
       });
     }
   });
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 91-98 -->

5. **Implement robust retry logic**
   ```javascript
   async function enterPresenceWithRetry(maxAttempts = 3) {
     for (let attempt = 1; attempt <= maxAttempts; attempt++) {
       try {
         // Ensure channel is attached
         if (channel.state !== 'attached') {
           await channel.attach();
         }
         await channel.presence.enter();
         return; // Success
       } catch (error) {
         if (error.code === 91001 && attempt < maxAttempts) {
           // Wait before retry (exponential backoff not needed)
           await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
         } else {
           throw error; // Give up after max attempts
         }
       }
     }
   }
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 75-80 -->

## Automatic Handling

Ably SDKs do not automatically retry presence operations when this error occurs. Your application must:
- Monitor channel state
- Reattach to the channel when needed
- Retry presence operations after successful attachment

Some SDKs queue presence operations during the `attaching` state, but will fail if the channel is `detached`, `failed`, or `suspended`.
<!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-analysis.md lines 71-83 -->

## Prevention

- Always verify channel state before presence operations
- Implement connection state monitoring
- Handle device sleep/wake events appropriately
- Use channel state event listeners to maintain presence
- Consider implementing automatic re-entry logic after reconnection
- For long-running applications, implement periodic connection health checks
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 61-66 -->

## Channel States Reference

Presence operations are only allowed in the `attached` state:

| State | Presence Allowed | Description |
|-------|------------------|-------------|
| `initialized` | No | Channel created but not connected |
| `attaching` | Queued* | Operations queued until attached |
| `attached` | ✅ Yes | Only state allowing presence |
| `detaching` | No | Channel being removed |
| `detached` | No | Not connected to channel |
| `failed` | No | Channel in error state |
| `suspended` | No | Channel temporarily unavailable (after 2+ minutes disconnected) |

*Some SDKs queue operations during `attaching`, others reject immediately
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 14-21 -->

## Platform-Specific Considerations

### Windows
Windows computers are particularly susceptible to this error after resuming from sleep mode. The channel often enters a detached state during suspension and requires explicit reattachment.

### Mobile (iOS/Android)
Mobile apps transitioning between background and foreground states may encounter this error. Implement lifecycle handlers to manage presence state appropriately.

### Asset Tracking SDK
The Asset Tracking SDK treats error 91001 as non-fatal and automatically retries after 15 seconds when encountering "Enter presence on suspended channel".
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 99-105 -->

## Related Resources

- [Presence documentation](https://ably.com/docs/presence)
- [Channel state lifecycle](https://ably.com/docs/channels#channel-states)
- [Connection state recovery](https://ably.com/docs/connect/states)
- [Handling connection failures](https://ably.com/docs/connect/failures)

## Related Errors

• **[91000 - No Client ID Configured](https://help.ably.io/error/91000)**  
  Presence operations require a client ID to be set during authentication

• **[91004 - Auto Re-enter Failed](https://help.ably.io/error/91004)**  
  Automatic presence re-entry failed after connection recovery

• **[91005 - Presence State Out of Sync](https://help.ably.io/error/91005)**  
  Presence set has become inconsistent and requires resynchronization

• **[80002 - Channel Suspended](https://help.ably.io/error/80002)**  
  Channel enters suspended state after extended disconnection, preventing all operations

• **[80000 - Connection Failed](https://help.ably.io/error/80000)**  
  Connection failure that may cause channels to detach

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 91001
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (presence state guidance lines 118-121)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/91001-presence-channel-invalid-state.mdx (enhanced and improved)
- Repository Overviews: Not needed for this error
-->

<!-- URL Validation Completed: 2025-08-25T19-44-21-128Z -->
<!-- External URLs verified: 8 | Corrected: 0 | Exempted internal: 2 -->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - State checking pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 50-59
  - Proper sequencing from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 39-48
  - Device wake handling from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 91-98
- Content Excluded: None - all relevant information included
- Recommendations Source: 
  - Step 1: Based on knowledge file lines 50-59 (state checking pattern)
  - Step 2: Based on knowledge file lines 39-48 (proper sequencing)
  - Step 3: Based on analysis file lines 71-78 (state transition handling)
  - Step 4: Based on knowledge file lines 91-98 (device wake scenarios)
  - Step 5: Based on knowledge file lines 75-80 (retry logic guidance)
- Code Examples Rationale: Included essential patterns from knowledge file as they demonstrate correct implementation for common scenarios
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-analysis.md lines 71-78
  - Cause 2: From support history in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 91-98
  - Cause 3: From race condition documentation in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 24-29
  - Cause 4: From customer impact patterns in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 139-141
- Resolution Steps: 
  - Step 1: Source from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 50-59 - state checking best practice
  - Step 2: Source from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 39-48 - proper sequencing
  - Step 3: Based on state management from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-analysis.md lines 71-78
  - Step 4: Windows/device wake issues from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 91-98
  - Step 5: Retry logic from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 75-80
- Prevention: Based on https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 61-66
- Channel States Reference: From https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 14-21
- Platform-Specific Considerations: From https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/91001-knowledge.md lines 91-105
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Comprehensive guide on handling device sleep/wake scenarios
- Impact: Developers struggle with presence recovery after computer suspension
- Recommendation: Add device lifecycle management section to presence documentation
- Severity: Medium - affects Windows users particularly
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 91001
2. Regenerate: Run `./bin/ably-os errors document-error-codes 91001 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->