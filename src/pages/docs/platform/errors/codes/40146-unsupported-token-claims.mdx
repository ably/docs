<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40146 -->
<!-- Generated: 2025-08-21T14-38-12-248Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Documenting a specific JWT limitation in Ably's server-generated tokens, providing clear explanation of the constraint and offering practical alternatives including removing claims or switching to client-side generation -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40146: Unsupported token claims

## What happened

Your token request includes `userClaims` or `limitsClaims`, which are not supported in Ably's server-generated tokens.

## Quick reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40146 | 401 | Client Error (Authentication) | No - requires removing unsupported claims or switching to client-side token generation |

## Quick fix

- Remove `userClaims` and `limitsClaims` from your token request
- Use standard token capabilities for access control instead
- Or generate tokens client-side if you need these advanced JWT features

## Error messages

You'll see this message:
- "userClaims and limitsClaims are not currently supported in server-generated tokens"

## Common causes

1. **Including advanced JWT features in server-side token requests** (most common)
   - Adding `userClaims` to your token request body
   - Including `limitsClaims` in server-generated token requests
   - Attempting to use JWT features only available in client-side generation
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md lines 28-30 -->

2. **Migration from custom token generation**
   - Moving from client-side to server-side token generation without removing unsupported features
   - Copy-pasting token request code that includes these claims
   - Assuming all JWT features work with server-side generation
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 18-21 -->

3. **Documentation misunderstanding**
   - Mixing examples meant for client-side and server-side token generation
   - Not realizing the feature limitations of server-side generation
   - Following tutorials that use client-side generation patterns
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 23-25 -->

## Resolution steps

### 1. Remove unsupported claims

If these claims aren't essential to your application:

1. **Remove the unsupported fields from your token request**
   ```javascript
   // ❌ Wrong: Including unsupported claims
   const tokenRequest = await ably.auth.createTokenRequest({
     capability: { '*': ['publish', 'subscribe'] },
     userClaims: { userId: '123' },  // Remove this
     limitsClaims: { max: 100 }      // Remove this
   });
   
   // ✅ Correct: Standard token request
   const tokenRequest = await ably.auth.createTokenRequest({
     capability: { '*': ['publish', 'subscribe'] }
   });
   ```
   <!-- Source: Resolution approach based on analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md lines 39-40 and knowledge from lines 35-40 -->

2. **Use standard token features instead**
   - Use `clientId` for user identification instead of `userClaims`
   - Use capabilities for fine-grained access control
   - Store user-specific metadata in your application
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 77-80 -->

### 2. Switch to client-side token generation

If you need `userClaims` or `limitsClaims`:

1. **Generate tokens in your application backend**
   - Use a JWT library in your server code
   - Sign tokens with your Ably API key secret
   - Include any JWT claims you need
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 42-46 -->

2. **Return signed JWT tokens to clients**
   - Your backend generates the complete JWT
   - Clients use the token directly with Ably
   - Full control over all JWT features and claims

3. **Example approach**
   ```javascript
   // Backend: Generate custom JWT with all claims
   const jwt = require('jsonwebtoken');
   
   const token = jwt.sign({
     'x-ably-capability': JSON.stringify({ '*': ['publish', 'subscribe'] }),
     'x-ably-clientId': 'user-123',
     userClaims: { role: 'admin', department: 'engineering' },
     limitsClaims: { maxChannels: 10 }
   }, apiKeySecret, {
     expiresIn: '1h',
     keyid: apiKeyId
   });
   
   // Return token to client
   ```
   <!-- Code source: Pattern derived from Ably JWT documentation, included to demonstrate client-side generation approach -->

See [Ably's token authentication documentation](https://ably.com/docs/auth/token) for complete implementation details.

### 3. Alternative approaches

Consider whether you actually need these advanced claims:

1. **Use token capabilities** for channel-level access control
2. **Use clientId** to identify and track users
3. **Store user metadata** in your own database and reference via clientId
4. **Implement custom authorization** in your application layer before issuing tokens
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 48-54 -->

## Automatic handling

This is a validation error that occurs before token generation. Ably SDKs will not automatically retry this error as it indicates a configuration issue that must be fixed in your code.

## Prevention

- **Understand the difference** between server-side and client-side token generation capabilities
- **Check feature support** in documentation before implementing token generation
- **Test token generation** in development environments first
- **Choose the appropriate method** based on your feature requirements
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 56-60 -->

## Token generation methods comparison

### Server-side generation (Ably-managed)
- Simpler implementation with less code
- Standard JWT claims only
- `userClaims` and `limitsClaims` **NOT** supported
- Suitable for basic authentication needs

### Client-side generation (self-managed)
- Full JWT specification support
- `userClaims` and `limitsClaims` supported
- More complex implementation required
- Complete control over token contents
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 62-74 -->

## Real-world context

This error has been encountered in production environments, particularly during Project RARE implementation at Ably, where teams attempted to use advanced JWT features with server-generated tokens. The limitation is architectural and intentional, designed to keep server-side token generation simple and secure.
<!-- Source: Slack discussion from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 99-106 -->

## Related resources

- [Token authentication](https://ably.com/docs/auth/token)
- [Token request API](https://ably.com/docs/api/rest-api#token-request)
- [JWT token claims](https://ably.com/docs/auth/token#claims)
- [Authentication guide](https://ably.com/docs/auth)
- Related errors: [40001](./40001-bad-request.md) (Invalid token request)

## Need further help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40146
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40146)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40146-unsupported-token-claims.mdx (enhanced from existing)
- Repository Overviews: Not needed for this specific error
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Knowledge file guidance from lines 35-54 incorporated into Resolution Steps with minimal changes
- Content Excluded: Technical note about future updates (line 84) as it's speculative
- Recommendations Source: 
  - Remove claims approach: Knowledge file lines 35-40
  - Client-side generation: Knowledge file lines 42-46
  - Alternative approaches: Knowledge file lines 48-54
- Code Examples Rationale: Included minimal example showing correct vs incorrect token request structure based on error context from analysis file, and client-side JWT generation pattern to demonstrate the alternative
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-analysis.md lines 28-30
  - Cause 2: From knowledge file at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 18-21
  - Cause 3: From knowledge file at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 23-25
- Resolution Steps: 
  - Step 1: Source from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 35-40 combined with analysis lines 39-40
  - Step 2: Source from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 42-46
  - Step 3: Alternative approaches from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 48-54
- Prevention: Based on https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 56-60
- Token Generation Comparison: From https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 62-74
- Real-world Context: From Slack discussion in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40146-knowledge.md lines 99-106
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40146
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40146 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->