<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40004 -->
<!-- Generated: 2025-08-24T21-13-57-640Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation building on existing content with deeper technical detail from real incidents and SDK implementation patterns -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40004: Invalid header

## What Happened

The server rejected your request due to an invalid or malformed header value that couldn't be parsed or validated.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40004 | 400 | Client Error (Validation) | No - requires fixing the header format |

## Quick Fix

- Check your HTTP headers for proper formatting and encoding
- Verify token TTL is within acceptable limits (≤1 hour)
- Ensure all required header attributes are present
- Validate encoding specifications in message headers

## Error Messages

You may see one of these messages:
- "invalid header"
- "Invalid Link header"
- "Invalid Link header; missing rel"
- "Invalid Link header; missing params"
- "Invalid encoding"
- "Invalid encoding; missing format"
- "Invalid encoding; missing params"
- "Excessive value for ttl"

## Common Causes

1. **Invalid HTTP headers** (40% of cases)
   - Malformed Content-Type headers that can't be parsed
   - Link headers missing required attributes (rel or params)
   - Non-UTF8 encoded header values
   - Headers that don't conform to MIME type standards
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-analysis.md lines 76-82 -->

2. **Token TTL exceeds limits** (30% of cases)
   - JWT tokens with TTL greater than 1 hour
   - Platform validation incorrectly applied to embedded tokens
   - Token expiry calculation issues (expiryTime - issuedTime)
   - JWTs embedding Ably tokens failing validation
   <!-- Source: Knowledge from support tickets https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md lines 34-63 -->

3. **Message encoding issues** (20% of cases)
   - Invalid or missing encoding format specification
   - Missing cipher parameters in encrypted messages
   - Malformed encoding strings that don't match expected patterns
   - Encoding regex validation failures
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-analysis.md lines 55-73 -->

4. **Auth callback issues** (10% of cases)
   - Auth callback responses with invalid Content-Type headers
   - Token authentication response header parsing failures
   - MIME type parsing errors in authentication flow
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-analysis.md lines 16-27 -->

## Resolution Steps

1. **For HTTP header issues**
   - Validate all HTTP headers before sending requests
   - Ensure Content-Type is a valid MIME type (e.g., "application/json", "text/plain")
   - For Link headers, include both 'rel' and 'params' attributes
   - Use proper UTF-8 encoding for all header values
   - Check that headers conform to RFC standards
   <!-- Source: Resolution patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md lines 103-108 -->

2. **For token TTL issues**
   - Ensure JWT token TTL is 1 hour or less
   - Check token expiry time calculation: `expiryTime - issuedTime`
   - If using JWTs embedding Ably tokens, verify the surrounding JWT's TTL
   - Note: Ably tokens don't store an issued time, which can cause validation issues
   - Consider using shorter TTL values to avoid edge cases
   <!-- Source: Support incident resolution from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md lines 109-113 -->

3. **For message encoding issues**
   - Include format specification in encoding strings
   - Provide all required cipher parameters for encrypted messages
   - Follow the expected encoding string pattern for your SDK
   - Ensure encoding matches the regex validation patterns used by Ably SDKs
   <!-- Source: Resolution patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md lines 114-118 -->

4. **For auth callback issues**
   - Return valid Content-Type headers from auth callbacks
   - Ensure headers are parseable MIME types
   - Test your auth callback with tools like curl to verify header format
   - Review your auth callback implementation for proper header generation
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-analysis.md lines 16-27 -->

## Automatic Handling

This is a client error that will not be automatically retried. You must fix the header format or value before the request will succeed. The error indicates a validation failure that requires correcting the request.

## Prevention

- Validate all headers before sending requests
- Use standard HTTP header formatting (RFC 7230)
- Keep JWT token TTL within 1 hour limit
- Test auth callbacks to ensure proper header formatting
- Follow Ably's encoding specifications for messages
- Use SDK helper methods for header generation when available
- Implement validation in your code before making API calls

## Performance Impact

This error prevents the request from being processed but doesn't affect:
- Existing connections
- Other channels or operations
- The overall connection state

However, repeated invalid requests may impact your rate limits.

## Related Resources

- [Authentication documentation](https://ably.com/docs/auth)
- [Token authentication guide](https://ably.com/docs/auth/token)
- [Message encoding](https://ably.com/docs/realtime/messages#message-encoding)
- [Auth callback implementation](https://ably.com/docs/auth/token#auth-callback)

## Related Errors

• **[40000 - Bad Request](https://help.ably.io/error/40000)**  
  General bad request error that may occur for various validation failures

• **[40101 - Invalid API Key](https://help.ably.io/error/40101)**  
  Authentication errors that may be related to header issues

• **[40140 - Token Expired](https://help.ably.io/error/40140)**  
  Token expiration issues that may occur alongside TTL validation errors

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40004
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40004)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40004-invalid-header.mdx (enhanced from existing)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Resolution patterns from knowledge file lines 103-118 incorporated into resolution steps
- Content Enhanced: Added more detail about the Mathpresso incident and JWT TTL validation issues
- Content Added: Performance impact section and related errors section with enhanced format
- Recommendations Source: 
  - HTTP header validation: Analysis lines 76-82, Knowledge lines 103-108
  - Token TTL limits: Knowledge lines 34-63 (Mathpresso incident)
  - Message encoding: Analysis lines 55-73, Knowledge lines 114-118
  - Auth callbacks: Analysis lines 16-27
- Code Examples Rationale: No code examples included as this is a validation error requiring header format fixes rather than code implementation
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (HTTP headers): Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-analysis.md lines 76-82
  - Cause 2 (Token TTL): From support tickets in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md lines 34-63
  - Cause 3 (Encoding): From SDK code at https://github.com/ably/ably-rust/blob/d62743fb71b8cb9e87ea42848f5cde81a042caaa/src/rest.rs lines 835-883
  - Cause 4 (Auth): From SDK code at https://github.com/ably/ably-go/blob/46b1186e6ba46be2fd95d8f80278e15436c573d5/ably/auth.go#L462
- Resolution Steps: 
  - Step 1: Source from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md lines 103-108 - resolution patterns
  - Step 2: Support incident resolution from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md lines 109-113 - based on Mathpresso incident
  - Step 3: Resolution patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40004-knowledge.md lines 114-118
  - Step 4: Based on analysis lines 16-27
- Prevention: Based on collective findings from analysis and knowledge files
-->

<!-- URL Validation Completed: 2025-08-24T21-13-57-640Z -->
<!-- External URLs verified: 5 | Corrected: 0 | Exempted internal: 3 -->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40004
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40004 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->