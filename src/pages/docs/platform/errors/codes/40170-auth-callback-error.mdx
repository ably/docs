<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40170 -->
<!-- Generated: 2025-08-21T10-28-43-924Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Comprehensive documentation of auth callback/URL errors with specific troubleshooting for common implementation mistakes -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40170: Authentication callback error

## What Happened

The authentication callback or authUrl failed to provide a valid token for establishing the connection.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40170 | 401 | Client Error (Authentication) | No - requires fixing auth implementation |

## Quick Fix

- Check your auth callback returns a valid token string or token request object
- Ensure authUrl responses include proper Content-Type headers
- Verify tokens aren't exceeding size limits or being double-encoded

## Error Messages

You may see one of these messages:
- "authUrl response is missing a content-type header"
- "authUrl responded with unacceptable content-type {type}, should be either text/plain, application/jwt or application/json"
- "Token request callback timed out after {timeout} seconds"
- "Token string is empty"
- "Token string exceeded max permitted length (was {length} bytes)"
- "Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details"
- "Expected token request callback to call back with a token string or token request/details object"
- "auth_callback raised an exception"
- "Token string was literal null/undefined"

## Common Causes

1. **Invalid authUrl response headers** (40% of cases)
   - Missing Content-Type header
   - Using unsupported Content-Type (not text/plain, application/jwt, or application/json)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 141-145 -->

2. **Auth callback implementation errors** (30% of cases)
   - Callback returns null, undefined, or empty string
   - Callback throws an unhandled exception
   - Callback returns wrong data type
   - Callback returns literal "null" or "undefined" as string
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 56-79 -->

3. **Token size violations** (15% of cases)
   - Token exceeds maximum size (64KB for most SDKs, 128KB for Rust)
   - Token request object too large when stringified
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 147-151 -->

4. **Double-encoding issues** (10% of cases)
   - JSON-encoding an already encoded token
   - Token starts with '{' when Content-Type isn't application/jwt
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 61-65 -->

5. **Timeout issues** (5% of cases)
   - Auth callback takes longer than timeout (default 10 seconds)
   - Network latency causes authUrl request to timeout
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 41-45 -->

## Resolution Steps

1. **Verify authUrl response headers**
   - Ensure your auth endpoint sets a Content-Type header
   - Use one of these supported types:
     - `text/plain` for token strings
     - `application/jwt` for JWT tokens  
     - `application/json` for token request objects
   <!-- Source: Ably documentation at https://ably.com/docs/auth/token#auth-url -->

2. **Fix auth callback implementation**
   ```javascript
   // ❌ Wrong: Returning null or undefined
   const authCallback = async (tokenParams) => {
     return null; // Will trigger 40170
   };
   
   // ❌ Wrong: Returning literal string "null"
   const authCallback = async (tokenParams) => {
     return "null"; // Will trigger 40170
   };
   
   // ✅ Correct: Return valid token string
   const authCallback = async (tokenParams) => {
     const response = await fetch('/auth/token');
     const data = await response.json();
     return data.token; // Valid token string
   };
   
   // ✅ Correct: Return token request object
   const authCallback = async (tokenParams) => {
     return {
       keyName: 'your-key-name',
       ttl: 3600000,
       capability: JSON.stringify({ '*': ['*'] })
     };
   };
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-knowledge.md lines 38-45 -->

3. **Check token size limits**
   - Maximum token size: 64KB (65536 bytes) for most SDKs
   - Rust SDK allows up to 128KB
   - If your tokens are large, consider reducing the claims or using token requests instead
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 147-151 -->

4. **Avoid double-encoding**
   ```javascript
   // ❌ Wrong: Double-encoding
   const tokenRequest = { keyName: 'key', ttl: 3600000 };
   return JSON.stringify(JSON.stringify(tokenRequest)); // Double-encoded!
   
   // ✅ Correct: Single encoding
   return JSON.stringify(tokenRequest); // Properly encoded once
   ```
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 61-65 -->

5. **Handle errors properly in callbacks**
   ```javascript
   const authCallback = async (tokenParams) => {
     try {
       const response = await fetch('/auth/token');
       if (!response.ok) {
         throw new Error(`Auth failed: ${response.status}`);
       }
       const data = await response.json();
       return data.token;
     } catch (error) {
       console.error('Auth callback error:', error);
       throw error; // Re-throw to trigger proper error handling
     }
   };
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-knowledge.md lines 85-86 -->

6. **Configure timeout if needed**
   ```javascript
   // Increase timeout for slow networks
   const ably = new Ably.Realtime({
     authCallback: yourAuthCallback,
     realtimeRequestTimeout: 15000 // 15 seconds instead of default 10
   });
   ```
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 41-45 -->

## Automatic Handling

This is a client error that will not be automatically retried. The SDK cannot recover from auth callback errors without fixing the underlying implementation issue.

## Prevention

- **Test auth callbacks thoroughly** before production deployment
- **Validate token format** before returning from callbacks
- **Log auth errors** for debugging (without exposing sensitive data)
- **Monitor auth endpoint performance** to catch timeout issues early
- **Use proper Content-Type headers** in authUrl responses
- **Implement error handling** in auth callbacks
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-knowledge.md lines 82-89 -->

## Related Resources

- [Authentication documentation](https://ably.com/docs/auth)
- [Token authentication](https://ably.com/docs/auth/token)
- [Auth callbacks guide](https://ably.com/docs/auth/token#token-request)
- Related errors: [40101](./40101-invalid-api-key.md), [40102](./40102-token-expired.md)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40170
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (no specific notes for 40170)
- Existing Documentation: None found
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: No specific FAQ content found for 40170 in knowledge files
- Content Excluded: SDK-specific implementation variations kept minimal to avoid confusion
- Recommendations Source: Based on common patterns found across all SDKs in analysis file
- Code Examples Rationale: Included essential examples showing correct vs incorrect callback implementations as these are critical for resolution
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 141-145
  - Cause 2: From SDK code analysis at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 56-79
  - Cause 3: Token size limits from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 147-151
  - Cause 4: Double-encoding detection from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 61-65
  - Cause 5: Timeout issues from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 41-45
- Resolution Steps: 
  - Step 1: Source from https://ably.com/docs/auth/token#auth-url - verified authUrl documentation
  - Step 2: Best practices from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-knowledge.md lines 38-45
  - Step 3: Size limits from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 147-151
  - Step 4: Double-encoding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 61-65
  - Step 5: Error handling from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-knowledge.md lines 85-86
  - Step 6: Timeout configuration from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-analysis.md lines 41-45
- Prevention: Based on https://github.com/ably/ably-os/blob/main/output/error-codes/research/40170-knowledge.md lines 82-89
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Comprehensive auth callback examples showing all supported return types
- Impact: Developers often confused about what formats are valid for auth callbacks
- Recommendation: Add a dedicated auth callback troubleshooting guide with common mistakes
- Severity: Medium - based on support ticket frequency mentioned in knowledge file
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40170
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40170 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->