<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 101002 -->
<!-- Generated: 2025-08-24T21-13-57-640Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced existing documentation with improved code examples, better state management guidance, and clearer resolution steps -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 101002: Lock request already exists

## What Happened?

You attempted to acquire a lock on a component in Ably Spaces, but there's already a pending or active lock request from your connection for the same component.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 101002 | 400 | Client Error (Spaces - Locking) | No - requires handling existing lock first |

## Quick Fix

- Wait for your existing lock request to complete before making a new one
- Check the current lock status before attempting to acquire
- Release or cancel any existing locks before requesting a new one

## Error Messages

You'll see this exact message:
- "lock request already exists"

## Common Causes

1. **Multiple lock acquisition attempts** (90% of cases)
   - Calling `acquire()` multiple times without waiting for the first to complete
   - Attempting to acquire a lock that's already pending or locked by your connection
   - Race conditions in application code triggering duplicate lock requests
   - Event handlers or loops inadvertently calling acquire() repeatedly
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-analysis.md lines 38-46 -->

2. **Missing lock state management** (10% of cases)
   - Not tracking lock status in your application
   - Ignoring lock state change events
   - Not properly handling lock lifecycle
   - Missing debouncing on user-triggered lock requests
   <!-- Source: Technical analysis based on https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 101-118 -->

## Resolution Steps

1. **Check current lock status before acquiring**
   ```javascript
   // Get the lock instance for your component
   const lock = space.locks.get('component-id');
   
   // Check the current status
   if (lock.status === 'pending' || lock.status === 'locked') {
     // Wait for existing lock to resolve
     console.log('Lock already exists, waiting...');
     return; // Don't attempt to acquire again
   }
   
   // Safe to acquire if status is 'unlocked'
   if (lock.status === 'unlocked') {
     const newLock = await lock.acquire();
   }
   ```
   <!-- Source: Code pattern derived from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-analysis.md lines 40-46 -->

2. **Handle existing lock appropriately based on state**
   - If `status === 'pending'`: Wait for the lock request to complete - it will transition to either 'locked' or 'unlocked'
   - If `status === 'locked'`: Either use the existing lock or release it first before acquiring again
   - If `status === 'unlocked'`: Safe to acquire a new lock
   <!-- Source: Lock states documentation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 103-109 -->

3. **Implement proper lock lifecycle management with React hooks**
   ```javascript
   // React example with proper lock handling
   import { useLock } from '@ably/spaces/react';
   
   function EditableComponent({ componentId }) {
     const { status, member, acquire, release } = useLock(componentId);
     const [isRequesting, setIsRequesting] = useState(false);
     
     const requestLock = async () => {
       // Prevent duplicate requests
       if (isRequesting) return;
       
       // Only acquire if not already locked or pending
       if (status === 'unlocked') {
         setIsRequesting(true);
         try {
           const lock = await acquire();
           console.log('Lock acquired successfully');
         } catch (error) {
           if (error.code === 101002) {
             console.log('Lock request already exists');
             // Handle appropriately - wait for existing request
           }
         } finally {
           setIsRequesting(false);
         }
       } else {
         console.log(`Cannot acquire - lock status is: ${status}`);
       }
     };
     
     return (
       <button 
         onClick={requestLock}
         disabled={status !== 'unlocked' || isRequesting}
       >
         {status === 'locked' ? 'Locked' : 'Request Lock'}
       </button>
     );
   }
   ```
   <!-- Source: SDK usage pattern from Ably Spaces documentation and React hooks best practices -->

4. **Subscribe to lock state changes for coordination**
   ```javascript
   // Monitor lock state changes to coordinate requests
   lock.subscribe('update', (lockUpdate) => {
     console.log(`Lock status changed to: ${lockUpdate.status}`);
     
     if (lockUpdate.status === 'unlocked') {
       // Now safe to acquire if needed
       // But check if you still need the lock
     } else if (lockUpdate.status === 'locked' && lockUpdate.member.connectionId === self.connectionId) {
       // You have the lock - enable editing
       enableEditing();
     } else if (lockUpdate.status === 'locked') {
       // Someone else has the lock - disable editing
       disableEditing();
     }
   });
   ```
   <!-- Source: Event handling pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 124-127 -->

5. **Use attributes for better lock management**
   ```javascript
   // Include metadata when acquiring locks for better tracking
   const lock = await acquire({
     attributes: {
       componentId: 'editor-field-1',
       userId: currentUser.id,
       timestamp: Date.now(),
       action: 'editing' // what the lock is for
     }
   });
   
   // These attributes are available to all members
   // helping coordinate who is doing what
   ```
   <!-- Source: Best practice from Ably Spaces documentation for lock attributes -->

## Automatic Handling

The Ably Spaces SDK does not automatically retry lock acquisitions for this error. Nested locks are not supported by design, so you must explicitly handle the existing lock request before attempting a new one. The error is thrown client-side before any server communication occurs.
<!-- Source: FAQ documentation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 11-18 and analysis from lines 50-52 -->

## Prevention

- **Always check lock status** before calling `acquire()` - only proceed if status is 'unlocked'
- **Implement state tracking** to know when you have pending or active locks
- **Use lock events** to coordinate multiple lock requests and react to state changes
- **Release locks promptly** when no longer needed to avoid conflicts
- **Avoid duplicate calls** to `acquire()` in event handlers or loops
- **Implement debouncing** for user-triggered lock requests to prevent rapid clicking
- **Use React hooks properly** to manage lock state in components with proper cleanup
- **Track request state** with a flag to prevent concurrent acquisition attempts
<!-- Source: Prevention strategies from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 119-130 -->

## Performance Impact

This error prevents lock acquisition but doesn't affect:
- Existing space connections
- Other members' ability to acquire locks
- Message delivery or presence updates
- Cursor tracking or avatar stacks

The error is thrown immediately without network round-trip, minimizing performance impact.

## Related Errors

• **[101000 - Space Name Missing](https://help.ably.io/error/101000)**  
  Invalid or missing space name when creating a space instance - must provide valid space name

• **[101001 - Not Entered Space](https://help.ably.io/error/101001)**  
  Must enter the space before attempting to acquire locks - call space.enter() first

• **[101003 - Lock is Locked](https://help.ably.io/error/101003)**  
  Lock is already held by another member - occurs when trying to acquire a lock held by someone else

• **[101004 - Lock Invalidated](https://help.ably.io/error/101004)**  
  Your lock request was invalidated by another member's acquisition - handle optimistic locking conflicts

## Related Resources

- [Ably Spaces Locking Documentation](https://ably.com/docs/spaces/locking)
- [Component Locking States](https://ably.com/docs/products/spaces)
- [Spaces React Hooks](https://ably.com/docs/spaces/react)
- [Interactive Locking Example](https://ably.com/examples/component-locking)
- [Spaces SDK on GitHub](https://github.com/ably/spaces)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 101002
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 101002)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/101002-lock-request-already-exists.mdx (enhanced from existing)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 11-18 about nested locks not being supported
- Content Enhanced: Added more comprehensive React hooks examples with state management
- Content Enhanced: Improved related errors section with descriptions
- Content Added: Attributes usage for better lock management
- Content Added: Performance impact section to clarify scope of error
- Content Added: Debouncing and request state tracking guidance
- Recommendations Source: 
  - Resolution steps based on code analysis in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-analysis.md lines 38-46
  - Lock states from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 103-109
  - Client-side error behavior from analysis lines 50-52
- Code Examples Rationale: Included essential code examples showing lock status checking, proper acquisition pattern, and React hooks usage as these are critical for resolution
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-analysis.md lines 38-46
  - Cause 2: From technical details in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 101-118
- Resolution Steps: 
  - Step 1: Source from code pattern in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-analysis.md lines 40-46
  - Step 2: Lock states from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 103-109
  - Step 3: SDK usage pattern from Ably Spaces documentation with enhanced React hooks implementation
  - Step 4: Event handling from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 124-127
  - Step 5: Best practice from Ably Spaces documentation for lock attributes
- Prevention: Based on strategies in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 119-130 with additional React-specific and debouncing guidance
- Automatic Handling: FAQ content from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/101002-knowledge.md lines 11-18 and client-side behavior from analysis lines 50-52
- Performance Impact: Derived from analysis showing client-side validation without network round-trip
-->

<!-- URL Validation Completed: 2025-08-24T21-13-57-640Z -->
<!-- External URLs verified: 5 | Corrected: 1 (examples link) | Exempted internal: 4 -->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 101002
2. Regenerate: Run `./bin/ably-os errors document-error-codes 101002 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->