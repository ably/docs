<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40011 -->
<!-- Generated: 2025-08-24T21-13-57-640Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document dual usage of 40011 - both channel enumeration API pagination issues and Python SDK data validation, with clear differentiation and actionable solutions -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40011: Stale ring state or invalid data payload

## What Happened

This error has two distinct causes: either the channel enumeration API encountered a cluster state change during pagination, or a message contained an unsupported data type.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40011 | 400 | Client Error (Validation) | No - requires fixing the request |

## Quick Fix

- For channel enumeration: Restart enumeration from the beginning
- For message publishing: Ensure message data is a supported type (string, object, array, or binary)
- Check the specific error message to determine which scenario applies

## Error Messages

You may see one of these messages:
- "stale ring state" - Channel enumeration pagination became invalid due to cluster changes
- "Invalid data payload" - Message data type not supported (Python SDK)
- "Unable to continue query stale ring state" - Historical variant of enumeration error

## Common Causes

### 1. Channel Enumeration Pagination Issue (Most Common)
<!-- Source: Knowledge file FAQ advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 14-17 -->
When using the [channel enumeration API](https://ably.com/docs/api/rest-api#enumeration-rest), the cluster state changed between successive paginated calls, invalidating the pagination sequence. This doesn't occur if the enumeration is fully satisfied within the first response page.

**Why this happens**:
- Ably's distributed architecture can change cluster topology for scaling or maintenance
- Pagination cursors become invalid when the underlying cluster state changes
- This is a known limitation of the current enumeration API design

### 2. Invalid Message Data Type (Python SDK)
<!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-analysis.md lines 16-24 -->
In the Python SDK, attempting to publish a message with unsupported data types. Supported types are: bytes, str, list, dict, bytearray, or None.

**Common triggers**:
- Publishing raw numbers (integers or floats)
- Attempting to send custom Python objects
- Using unsupported primitive types

## Resolution Steps

### For Channel Enumeration Issues

1. **Restart the enumeration**
   <!-- Source: Knowledge file advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 37-41 -->
   - When you receive this error, start the enumeration again from the beginning
   - The cluster state has changed, making your current pagination cursor invalid
   - This is the only way to get a complete, consistent result

2. **Optimize your enumeration strategy**
   <!-- Source: Slack discussion from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 48-65 -->
   - Request larger page sizes to minimize pagination needs
   - Use the maximum allowed page size to potentially get all results in one request
   - Consider caching enumeration results with an appropriate TTL
   - Implement automatic retry logic that restarts from the beginning

3. **Handle the error gracefully**
   ```javascript
   // Example retry logic for channel enumeration
   async function enumerateChannelsWithRetry(maxAttempts = 3) {
     for (let attempt = 1; attempt <= maxAttempts; attempt++) {
       try {
         const channels = [];
         let hasMore = true;
         let cursor = null;
         
         while (hasMore) {
           const response = await fetch(`/channels?cursor=${cursor || ''}`);
           if (response.status === 400 && response.error?.code === 40011) {
             throw new Error('Stale ring state');
           }
           
           channels.push(...response.channels);
           cursor = response.cursor;
           hasMore = response.hasMore;
         }
         
         return channels;
       } catch (error) {
         if (error.message === 'Stale ring state' && attempt < maxAttempts) {
           console.log(`Enumeration failed, retrying (attempt ${attempt + 1}/${maxAttempts})`);
           continue;
         }
         throw error;
       }
     }
   }
   ```
   <!-- Code source: Based on resolution pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 105-108, included because essential for demonstrating retry pattern -->

### For Invalid Data Payload (Python SDK)

1. **Validate your message data type**
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-analysis.md lines 58-60 -->
   - Ensure your data is one of: bytes, str, list, dict, bytearray, or None
   - Primitive numbers and custom objects are not directly supported
   - The validation happens before the message is sent to Ably

2. **Convert unsupported types**
   ```python
   # ❌ Wrong: Publishing raw numbers or custom objects
   channel.publish('event', 42)  # Will raise error 40011
   channel.publish('event', 3.14)  # Will raise error 40011
   channel.publish('event', MyCustomClass())  # Will raise error 40011
   
   # ✅ Correct: Convert to supported types
   channel.publish('event', str(42))  # As string
   channel.publish('event', {'value': 42})  # In dict
   channel.publish('event', json.dumps({'pi': 3.14}))  # JSON string
   channel.publish('event', bytes([42]))  # As bytes
   ```
   <!-- Code source: Based on Python SDK validation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-analysis.md lines 21-24, included because essential for demonstrating correct data types -->

3. **Implement type checking before publishing**
   ```python
   def safe_publish(channel, event_name, data):
       """Safely publish data with type validation"""
       # Convert common unsupported types
       if isinstance(data, (int, float, bool)):
           data = {'value': data}  # Wrap in dict
       elif hasattr(data, '__dict__'):  # Custom object
           data = data.__dict__  # Convert to dict
       
       # Now publish
       try:
           channel.publish(event_name, data)
       except AblyException as e:
           if e.code == 40011:
               print(f"Unsupported data type: {type(data)}")
               raise
   ```
   <!-- Code source: Resolution pattern based on SDK requirements, included to show defensive programming approach -->

## Automatic Handling

This is a client error that will not be automatically retried by Ably SDKs. You must:
- For enumeration: Restart from the beginning
- For data validation: Fix the data type before retrying

The SDKs do not implement automatic retry for this error because:
- Enumeration requires a fresh start, not a simple retry
- Data validation errors need code changes to resolve

## Prevention

### Channel Enumeration
<!-- Source: Knowledge file advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 98-108 -->
- **Request maximum page sizes**: Use the largest allowed page size to minimize pagination
- **Build retry logic**: Always implement enumeration restart logic in production code
- **Consider alternatives**: Evaluate if you need real-time enumeration or if cached results would suffice
- **Monitor frequency**: If you frequently encounter this error, consider architectural changes

### Message Publishing (Python)
- **Validate early**: Check data types before attempting to publish
- **Use type hints**: Leverage Python's type system to catch issues during development
- **Standardize serialization**: Always convert complex data to dicts or JSON strings
- **Test edge cases**: Include various data types in your test suite

## Performance Impact

### Channel Enumeration
- Restarting enumeration adds latency to your operation
- Multiple retries can significantly impact response times
- Consider implementing progressive backoff between retry attempts

### Message Publishing
- Type validation errors prevent message sending entirely
- No performance impact beyond the failed operation
- Fixing data types is typically a quick code change

## Related Resources

- [Channel Enumeration API](https://ably.com/docs/api/rest-api#enumeration-rest)
- [Python SDK Message Publishing](https://ably.com/docs/realtime/messages#publish)
- [Message Structure and Types](https://ably.com/docs/realtime/messages#message-structure)
- [Ably API Error Codes](https://ably.com/docs/platform/errors/codes)

## Related Errors

• **[40000 - Bad Request](https://help.ably.io/error/40000)**  
  General validation errors that may include similar data type issues

• **[40003 - Invalid Request](https://help.ably.io/error/40003)**  
  Invalid parameter values in API requests

• **[40013 - Invalid Message Data](https://help.ably.io/error/40013)**  
  Broader message validation errors including encoding issues

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40011
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md [No specific error-specific notes for 40011]
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40011-stale-ring-state.mdx [Enhanced existing documentation]
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: 
  - Channel enumeration explanation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 14-17
  - Resolution advice for enumeration from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 37-41
  - Slack discussion insights from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 48-65
  - Historical context from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 62-65
- Content Excluded: Internal Slack permalinks (replaced with general description of discussions)
- Recommendations Source: 
  - Enumeration retry: Based on official docs and internal team discussions
  - Data validation: From Python SDK implementation at https://github.com/ably/ably-python
  - Prevention strategies: From resolution patterns in knowledge file
- Code Examples Rationale: 
  - Enumeration retry code included because it demonstrates essential pattern for handling this specific error
  - Python type conversion examples included because they directly address the validation error
  - Type checking wrapper included to show defensive programming approach
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Enumeration): Based on official docs quoted in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 14-17
  - Cause 2 (Python): From SDK code at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-analysis.md lines 16-24
- Resolution Steps: 
  - Step 1 (Enumeration): Knowledge file advice from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 37-41
  - Step 2 (Optimization): Based on Slack discussions from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 48-65
  - Step 3 (Python validation): Based on SDK validation rules from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-analysis.md lines 58-60
- Prevention: 
  - Enumeration: Based on resolution patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40011-knowledge.md lines 98-108
  - Python: Derived from SDK implementation patterns
- Performance Impact: Added based on understanding of enumeration retry costs and message validation behavior
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Clear explanation of why enumeration API has this limitation
- Missing: Best practices for handling enumeration in production
- Impact: Developers struggle to understand why pagination fails
- Recommendation: Add architectural explanation and recommended patterns to enumeration API docs
- Severity: Medium - causes confusion but workarounds exist
-->

<!-- URL Validation Completed: 2025-08-24T21-13-57-640Z -->
<!-- External URLs verified: 6 | Corrected: 0 | Exempted internal: 4 -->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40011
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40011 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->