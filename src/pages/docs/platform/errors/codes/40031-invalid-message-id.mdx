<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40031 -->
<!-- Generated: 2025-08-21T17-17-40-434Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document idempotent message ID requirements based on server-side validation logic and support history -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40031: Invalid message ID

## What Happened

The message ID you specified doesn't meet the requirements for idempotent message publishing.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40031 | 400 | Client Error (Publishing) | No - requires fixing message ID format |

## Quick Fix

- Remove custom message IDs to let Ably generate them automatically
- Or ensure all messages in a batch have string IDs (not just some)
- For multi-message publishes, use the format: `baseMsgId:0`, `baseMsgId:1`, etc.

## Error Messages

You may see one of these messages:
- "Client-specified message id missing or not a string in some messages of a multi-message ProtocolMessage"
- "Client-specified message ids do not match the required format for multi-message ProtocolMessages"
- "Invalid publish request (invalid client-specified id)"
- "Invalid request: client-specified message id does not contain fragment part"

## Common Causes

1. **Mixed ID specification** (60% of cases)
   - Some messages in a batch have IDs while others don't
   - All messages must have IDs or none should have IDs
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 44-48 -->

2. **Incorrect multi-message format** (30% of cases)
   - When publishing multiple messages with IDs, they must follow: `baseMsgId:0`, `baseMsgId:1`, etc.
   - Sequential indexing starting at 0 is required
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 57-61 -->

3. **Invalid ID type** (10% of cases)
   - Message IDs must be strings
   - Numbers or other types are not accepted
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 47-48 -->

## Resolution Steps

1. **For single message publishing: Use any string ID or remove ID**
   ```javascript
   // ✅ Correct: Let Ably generate the ID
   channel.publish('event', data);
   
   // ✅ Correct: Custom string ID for idempotency
   channel.publish({ name: 'event', data: payload, id: 'unique-msg-123' });
   
   // ❌ Wrong: Non-string ID
   channel.publish({ name: 'event', data: payload, id: 12345 });
   ```
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 51-53 -->

2. **For multi-message publishing: Follow the required format**
   ```javascript
   // ❌ Wrong: Mixed ID specification
   channel.publish([
     { name: 'event1', data: 'data1', id: 'msg1' },
     { name: 'event2', data: 'data2' } // Missing ID!
   ]);
   
   // ❌ Wrong: Incorrect format for multiple messages
   channel.publish([
     { name: 'event1', data: 'data1', id: 'msg1' },
     { name: 'event2', data: 'data2', id: 'msg2' }
   ]);
   
   // ✅ Correct: Proper format with base ID and sequential indices
   channel.publish([
     { name: 'event1', data: 'data1', id: 'batch123:0' },
     { name: 'event2', data: 'data2', id: 'batch123:1' }
   ]);
   
   // ✅ Correct: No IDs specified (Ably generates them)
   channel.publish([
     { name: 'event1', data: 'data1' },
     { name: 'event2', data: 'data2' }
   ]);
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-knowledge.md lines 66-73, preserved for customer experience -->

3. **Verify your implementation**
   - Check that all IDs are strings
   - Ensure consistent ID usage across all messages
   - For batches, verify the sequential index pattern
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 44-61 -->

## Automatic Handling

This is a client error that will not be automatically retried. You must fix the message ID format before the publish operation will succeed.

## Code Examples

### Idempotent Publishing with Custom IDs

```javascript
// Single message with custom ID for idempotency
const messageId = `order-${orderId}-${timestamp}`;
await channel.publish({
  name: 'order.created',
  data: orderData,
  id: messageId // Prevents duplicate processing
});

// Atomic batch publish with proper ID format
const batchId = `batch-${Date.now()}`;
const messages = orders.map((order, index) => ({
  name: 'order.created',
  data: order,
  id: `${batchId}:${index}` // Required format for batches
}));
await channel.publish(messages);
```
<!-- Source: Ably documentation at https://ably.com/docs/realtime/messages#idempotency -->

## Prevention

- Use Ably's automatic ID generation unless you specifically need idempotent publishing
- When using custom IDs, always use strings
- For batch operations, either specify IDs for all messages or none
- Follow the `baseMsgId:index` pattern for multi-message publishes
- Test your ID generation logic to ensure compliance

## Related Resources

- [Idempotent message publishing](https://ably.com/docs/realtime/messages#idempotency)
- [Message batching](https://ably.com/docs/rest/messages#batch)
- [Publishing messages](https://ably.com/docs/realtime/messages#publish)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40031
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40031)
- Existing Documentation: None found
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: FAQ advice about multi-message ID format from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-knowledge.md lines 35-37, 66-73
- Content Excluded: Internal Slack thread details (preserved essence in common causes)
- Recommendations Source: 
  - Step 1: Based on analysis in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 51-53
  - Step 2: From FAQ content in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-knowledge.md lines 66-73
  - Step 3: From validation logic in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 44-61
- Code Examples Rationale: Based on documented patterns from https://ably.com/docs/realtime/messages#idempotency
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 44-48
  - Cause 2: From SDK code at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 57-61
  - Cause 3: From validation logic at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 47-48
- Resolution Steps: 
  - Step 1: Source from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 51-53 - single message ID validation
  - Step 2: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-knowledge.md lines 66-73 - preserved due to customer experience
  - Step 3: From analysis at https://github.com/ably/ably-os/blob/main/output/error-codes/research/40031-analysis.md lines 44-61 - validation requirements
- Prevention: Based on https://ably.com/docs/realtime/messages#idempotency and analysis findings
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40031
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40031 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->