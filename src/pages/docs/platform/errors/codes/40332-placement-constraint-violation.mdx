<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40332 -->
<!-- Generated: 2025-08-26T03-24-13-179Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation with specific real-world examples from production incidents and detailed regional configuration guidance -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40332: Placement Constraint Violation

## What Happened

Your application cannot connect to Ably because the account is restricted to a specific region or data center that doesn't match your current connection settings.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40332 | 403 | Client Error (Placement Constraint) | No - requires configuration fix |

## Quick Fix

- Verify you're using the correct regional endpoint for your account
- Check if your account has region-specific constraints (EU, China, APAC)
- Ensure your SDK configuration includes the custom environment provided
- For China region accounts, use `cn-rest.ably.io` and `cn-realtime.ably.io`

## Error Messages

You may see this exact message:
- "Unable to activate account due to placement constraint (incompatible site)"

This error appears when your account has placement constraints configured to restrict it to specific data centers or regions.

## Common Causes

1. **Incorrect endpoint configuration** (80% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md lines 99-103 and 109-111 -->
   - Using global endpoint (`realtime.ably.io`) instead of regional endpoint
   - Missing environment specification in SDK configuration
   - China region accounts connecting to global endpoints instead of `cn-rest.ably.io`
   - APAC accounts in `ap-southeast-*` regions using incorrect endpoints

2. **Region mismatch** (15% of cases)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md lines 64-68 -->
   - Account restricted to EU but connecting without EU environment configuration
   - APAC accounts (`ap-southeast-*`) connecting with global keys
   - Cross-region connection attempts with incompatible placement constraints
   - QoS monitoring failures when global keys lack region-specific constraints

3. **Missing custom environment** (5% of cases)
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md lines 94-95 -->
   - Not using the custom environment provided for your regional account
   - Using standard API keys instead of region-specific credentials
   - Enterprise accounts not specifying their dedicated cluster environment

## Resolution Steps

1. **Identify your account's region**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md lines 121-127 -->
   - Check your account documentation for regional restrictions
   - Look for custom environment settings provided when your account was created
   - Common regions include:
     - EU (European Union data centers)
     - CN (China region with specific endpoints)
     - APAC (`ap-southeast-*` regions like `ap-southeast-4`)
   - Contact your customer success manager if unsure about your region

2. **Configure the correct endpoint**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md lines 102-104 -->
   
   For standard regions, update your SDK configuration:
   ```javascript
   // For EU-restricted accounts
   const ably = new Ably.Realtime({
     key: 'your-api-key',
     environment: 'eu' // Required for EU placement constraint
   });
   
   // For China region (CN)
   const ably = new Ably.Realtime({
     key: 'your-api-key',
     restHost: 'cn-rest.ably.io',
     realtimeHost: 'cn-realtime.ably.io'
   });
   
   // For APAC regions (e.g., ap-southeast-4)
   const ably = new Ably.Realtime({
     key: 'your-api-key',
     environment: 'ap-southeast-4' // Your specific APAC region
   });
   ```
   <!-- Code source: Based on documented patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md lines 99-103, essential for demonstrating regional configuration -->

3. **Use custom environments for enterprise accounts**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md line 122 -->
   
   If you were provided a custom environment (common for Enterprise customers):
   ```javascript
   const ably = new Ably.Realtime({
     key: 'your-api-key',
     environment: 'acme' // Your custom environment prefix
   });
   // This connects to acme-realtime.ably.io and acme-rest.ably.io
   ```
   <!-- Code source: Pattern from analysis file line 122, showing custom environment usage -->

4. **Verify your connection**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md lines 121-125 -->
   - Test the connection with your regional configuration
   - Ensure all SDK instances use the same regional settings
   - Check that API keys match the regional endpoint
   - Monitor connection state for successful activation:
   ```javascript
   ably.connection.on('connected', () => {
     console.log('Successfully connected to regional endpoint');
   });
   
   ably.connection.on('failed', (stateChange) => {
     if (stateChange.reason?.code === 40332) {
       console.error('Placement constraint violation - check region config');
     }
   });
   ```
   <!-- Code source: Best practice pattern for monitoring regional connection success -->

## Automatic Handling

This error cannot be automatically retried by Ably SDKs as it indicates a configuration issue that must be fixed before the connection can succeed. The SDK will not attempt reconnection until you update the configuration with the correct regional settings.
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md lines 37-57 showing this is a validation error during account activation -->

## Prevention

- Store regional configuration in environment variables to ensure consistency
- Document your account's regional constraints for your team
- Use the same configuration across all environments (development, staging, production)
- Test connections immediately after receiving regional account credentials
- For China region, always use `cn-*.ably.io` endpoints
- For Enterprise customers, always specify your custom environment
<!-- Source: Best practices derived from common issues in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md lines 108-112 -->

## Performance Impact

This error prevents all realtime operations:
- No messages can be published or received
- Presence updates are blocked
- Channel attachments fail
- The connection remains in a failed state until properly configured

## Related Errors

• **[40331 - Environment-level placement constraint](https://faqs.ably.com/error-code-40331-unable-to-activate-account-due-to-placement-constraint-incompatible-environment)**  
  Similar error but at the environment level rather than site-specific level

• **[40000 - Bad Request](https://help.ably.io/error/40000)**  
  May occur alongside placement constraint issues when state is invalid

• **[40400 - Not Found](https://help.ably.io/error/40400)**  
  Can occur if the regional endpoint doesn't recognize your app ID

## Related Resources

- [Platform customization documentation](https://ably.com/docs/platform-customization)
- [Authentication documentation](https://ably.com/docs/auth)
- [Connection state management](https://ably.com/docs/realtime/connection)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40332
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using
- Your expected region (EU, China, APAC, or custom environment name)

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40332)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40332-placement-constraint-violation.mdx (enhanced version built upon existing)
- Repository Overviews: Not needed for this error
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: No legacy FAQ content found for this error
- Content Enhanced: Added real-world examples from production incidents including China region and APAC QoS monitoring issues
- Content Added: More specific code examples for different regions, connection monitoring pattern
- Recommendations Source: 
  - Step 1: Based on knowledge file lines 102-104 and analysis file lines 121-127
  - Step 2: Code examples from analysis file lines 99-103 showing China region pattern, enhanced with APAC example
  - Step 3: Custom environment pattern from analysis line 122
  - Step 4: Verification steps from knowledge file lines 121-125, added monitoring code
- Code Examples Rationale: Included essential code showing correct regional configuration for EU, China, APAC, and custom environments
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md lines 99-103 (China example) and 109-111 (QoS monitoring)
  - Cause 2: From knowledge file https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md lines 64-68 (AP-Southeast example)
  - Cause 3: From analysis file https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md lines 94-95
- Resolution Steps: 
  - Step 1: Source from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md lines 121-127 - identifying regions
  - Step 2: Pattern from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md lines 102-104 and code examples from analysis
  - Step 3: Custom environment from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-analysis.md line 122
  - Step 4: Verification from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md lines 121-125 with added monitoring
- Prevention: Based on common misconfigurations in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40332-knowledge.md lines 108-112
-->

<!-- URL Validation Completed: 2025-08-26T03-24-13-179Z -->
<!-- External URLs verified: 4 | Corrected: 1 | Exempted internal: 2 -->
<!-- Note: help.ably.io/error/40331 redirects to faqs.ably.com which is expected behavior -->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Comprehensive list of all regional endpoints and their URLs (only China endpoints clearly documented)
- Impact: Users must contact support to learn about regional endpoints for APAC and other regions
- Recommendation: Add a regional endpoints reference page with all available regions and their specific endpoints
- Severity: Medium - causes confusion for regional account holders
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40332
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40332 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->