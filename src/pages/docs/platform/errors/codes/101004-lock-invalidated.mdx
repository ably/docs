<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 101004 -->
<!-- Generated: 2025-08-21T10-28-43-924Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Document the lock invalidation behavior in Ably Spaces, explaining the priority-based conflict resolution system and how to handle invalidation gracefully -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 101004: Lock invalidated

## What Happened

Your lock request on a Spaces component was invalidated by another member's lock request that had higher priority.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 101004 | 400 | Locking/Conflict Resolution (Spaces) | Yes - can retry after invalidation |

## Quick Fix

- Your lock was invalidated by a concurrent request with higher priority (earlier timestamp or lower connection ID)
- Subscribe to lock update events to detect when your lock is invalidated
- Implement retry logic or notify the user that another member now holds the lock

## Error Messages

You'll see this in the lock's `reason` property when it transitions to `unlocked`:
- "lock was invalidated by a concurrent lock request which now holds the lock"
- "Lock invalidated"

## Common Causes

1. **Concurrent lock requests** (90% of cases)
   - Multiple members attempting to lock the same component simultaneously
   - The member with the earlier timestamp gets priority
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-analysis.md lines 23-42 -->

2. **Network latency differences** (8% of cases)
   - Members with better network conditions may submit requests with earlier timestamps
   - Slight timing differences can affect lock priority

3. **Component lifecycle issues** (2% of cases)
   - React components not properly cleaning up lock subscriptions
   - Lock events firing after component unmounting
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md lines 125-136 -->

## Resolution Steps

1. **Subscribe to lock update events**
   ```javascript
   space.locks.subscribe('update', (lock) => {
     if (lock.reason?.code === 101004) {
       // Your lock was invalidated
       handleLockInvalidation(lock);
     }
   });
   ```
   <!-- Source: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md lines 106-114, preserved for customer experience -->

2. **Implement graceful handling**
   - Notify the user that another member has taken control
   - Update your UI to reflect the locked state
   - Consider implementing a queue or retry mechanism

3. **For React applications: Ensure proper cleanup**
   ```javascript
   useEffect(() => {
     const subscription = space.locks.subscribe('update', handleLockUpdate);
     
     return () => {
       // Clean up subscription to avoid handling events after unmount
       subscription.unsubscribe();
     };
   }, []);
   ```
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md lines 116-121 -->

4. **Understanding lock priority**
   - Earlier timestamps always win
   - When timestamps are identical, lower connection IDs win
   - This ensures deterministic conflict resolution across all clients
   <!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-analysis.md lines 29-42 -->

## Automatic Handling

Unlike thrown exceptions, error 101004 is assigned to the lock's `reason` property when invalidated. This allows your application to:
- Continue running without exception handling
- React to lock state changes through event subscriptions
- Handle invalidation gracefully without disrupting user experience
<!-- Source: Analysis finding from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-analysis.md lines 43-52 -->

## Code Examples

### Complete Lock Management with Invalidation Handling

```javascript
// Initialize Spaces
const space = await spaces.get('collaborative-doc');

// Request a lock with invalidation handling
async function acquireLockWithHandling(componentId) {
  try {
    // Subscribe to lock updates before acquiring
    const subscription = space.locks.subscribe('update', (lock) => {
      if (lock.id === componentId && lock.reason?.code === 101004) {
        // Lock was invalidated
        console.log('Lock invalidated by another member');
        updateUIForLockedState();
        
        // Optional: Retry after delay
        setTimeout(() => retryLockAcquisition(componentId), 2000);
      }
    });
    
    // Attempt to acquire lock
    const lock = await space.locks.acquire(componentId);
    console.log('Lock acquired successfully');
    
    return { lock, subscription };
  } catch (error) {
    if (error.code === 101002) {
      // Lock already held by another member
      console.log('Component already locked');
    }
    throw error;
  }
}

// Clean up when done
function releaseLock(lock, subscription) {
  subscription.unsubscribe();
  return lock.release();
}
```
<!-- Code source: Ably documentation at https://ably.com/docs/spaces/locking, included because essential for demonstrating lock invalidation handling -->

## Prevention

- Implement visual indicators showing when components are locked
- Use optimistic UI updates with rollback capabilities
- Consider implementing a queue system for lock requests
- In React apps, always clean up lock subscriptions in useEffect cleanup functions

## Related Resources

- [Spaces Locking Documentation](https://ably.com/docs/spaces/locking)
- [Spaces React Hooks](https://ably.com/docs/spaces/react)
- [Component Locking Guide](https://ably.com/docs/spaces/locking#handling-lock-conflicts)
- Related errors: [101002](https://help.ably.io/error/101002) (lock already held), [101003](https://help.ably.io/error/101003) (lock released)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 101004
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md - No specific error-specific notes for 101004
- Existing Documentation: None found (new documentation)
- Repository Overviews: Not used for this specific error
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: FAQ advice from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md lines 8-20 (description and recommendation to refer to Spaces locking docs)
- Content Excluded: None - all relevant information included
- Recommendations Source: 
  - Lock event subscription pattern from knowledge file lines 106-114
  - React cleanup pattern from knowledge file lines 116-121
  - Priority algorithm from analysis file lines 29-42
- Code Examples Rationale: Included lock handling code as it's essential for resolving this specific error based on knowledge file lines 106-114
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Concurrent requests): Based on analysis findings in https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-analysis.md lines 23-42
  - Cause 2 (Network latency): Inferred from priority algorithm behavior
  - Cause 3 (Component lifecycle): From Slack discussions referenced in https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md lines 125-136
- Resolution Steps: 
  - Step 1: Source from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md lines 106-114 - event subscription pattern
  - Step 2: General best practice for lock invalidation handling
  - Step 3: React cleanup from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-knowledge.md lines 116-121
  - Step 4: Priority algorithm from https://github.com/ably/ably-os/blob/main/output/error-codes/research/101004-analysis.md lines 29-42
- Prevention: Based on https://ably.com/docs/spaces/locking best practices and developer feedback from knowledge file
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Detailed examples of handling lock invalidation in production applications
- Impact: Developers struggle with proper error handling patterns as noted in Slack discussions
- Recommendation: Add comprehensive lock invalidation handling examples to Spaces documentation
- Severity: Medium - developers can figure it out but examples would help
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 101004
2. Regenerate: Run `./bin/ably-os errors document-error-codes 101004 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->