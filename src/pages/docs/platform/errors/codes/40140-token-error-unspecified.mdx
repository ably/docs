<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40140 -->
<!-- Generated: 2025-08-21T14-38-12-248Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation based on existing version, incorporating new research insights about token error range behavior, SDK implementations, and real-world patterns -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40140: Token error (unspecified)

## What Happened

Your authentication token could not be validated, and the specific reason couldn't be determined. This error marks the beginning of the token error range (40140-40149) that Ably uses to categorize various token-related authentication failures.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40140 | 401 | Authentication (Token) | No - requires new valid token |

## Quick Fix

- Request a new authentication token from your server
- Verify your token generation process is working correctly
- Check that your token hasn't expired or been revoked
- Ensure token has required permissions for the operation

## Error Messages

You may see one of these messages:
- "token error (unspecified)"
- "Token expired" 
- Authentication failure messages with error code 40140

## Common Causes

1. **Expired token** (most common)
   - Token has exceeded its TTL (time to live)
   - Token was valid when created but expired during use
   - Default TTL is 60 minutes unless specified differently
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 21-24 -->

2. **Invalid token format**
   - Token structure is corrupted or malformed
   - Token was incorrectly generated or transmitted
   - Missing required fields in token payload
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 21-24 -->

3. **Permission issues**
   - Token lacks required capabilities for the operation
   - Token was created with insufficient permissions
   - Channel requires capabilities not present in token
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 155-159, Slack insights -->

4. **Stale cached token**
   - SDK using outdated token from cache
   - Token was revoked but still cached locally
   - Token refresh failed to update cached credentials
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-analysis.md lines 39-41, Java SDK stale detection -->

5. **Unspecified token problem**
   - Generic token validation failure
   - System couldn't determine the specific token issue
   - Catch-all for uncommon token problems
   <!-- Source: Protocol definition from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-analysis.md line 57 -->

## Resolution Steps

1. **Request a new token immediately**
   - Have your server generate a fresh authentication token
   - Ensure the token includes all required capabilities
   - Replace the expired/invalid token in your client
   - Verify the new token works with a simple API call
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 41-50 -->

2. **Verify token generation**
   - Check your server-side token creation logic
   - Ensure you're using the correct API key for token generation
   - Verify the token request parameters are correct
   - Confirm TTL is appropriate for your use case
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 41-50 -->

3. **Check required capabilities**
   - Verify token has permissions for the channel and operation
   - Add required capabilities when generating tokens:
   ```javascript
   const tokenRequest = await ably.auth.createTokenRequest({
     capability: {
       'channel-name': ['publish', 'subscribe', 'presence']
     }
   });
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 155-159 -->

4. **Implement token refresh**
   - Set up automatic token renewal before expiration
   - Monitor token TTL and refresh proactively
   - Handle token errors gracefully in your application
   - Use auth callbacks for automatic renewal:
   ```javascript
   const ably = new Ably.Realtime({
     authCallback: async (tokenParams, callback) => {
       // Fetch new token from your server
       const tokenRequest = await fetchTokenFromServer();
       callback(null, tokenRequest);
     }
   });
   ```
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 52-56 -->

5. **For SSE connections specifically**
   ```javascript
   eventSource.onerror = msg => {
     const err = JSON.parse(msg.data);
     const isTokenErr = err.code >= 40140 && err.code < 40150;
     if(isTokenErr) {
       eventSource.close();
       // Fetch new token and reconnect
       const newToken = await fetchNewToken();
       const newUrl = `${baseUrl}?access_token=${newToken}`;
       eventSource = new EventSource(newUrl);
     }
   }
   ```
   <!-- Code source: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 120-130, SSE protocol documentation example -->

## Automatic Handling

Ably SDKs automatically detect token errors in the 40140-40149 range and:
- Clear any cached token details to prevent reuse of invalid tokens
- Attempt to obtain a new token if an auth callback is configured
- Will not automatically retry without a valid token
- Trigger token refresh logic when auth callbacks are set up

The SDK's behavior varies slightly by implementation:
- **JavaScript**: Uses `isTokenErr()` function for range detection
- **Java**: Clears token cache and checks for stale tokens specifically
- **Python**: Uses `is_token_error()` helper for classification
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-analysis.md lines 61-73, SDK behavior patterns -->

## Prevention

- **Implement proactive token refresh**: Renew tokens before they expire (e.g., at 75% of TTL)
- **Monitor token lifecycle**: Track token creation and expiration times
- **Use appropriate TTLs**: Balance security with user experience (default 60 minutes)
- **Handle the 40140-40149 range**: Set up specific error handling for all token errors
- **Use auth callbacks**: Let the SDK handle token renewal automatically
- **Clear token cache on errors**: Ensure stale tokens aren't reused
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md lines 52-56, best practices -->

## Understanding the Token Error Range

Error 40140 is the first in a range of token-related errors (40140-40149):
- **40140**: Unspecified token error (this error)
- **40141**: Token has been revoked
- **40142**: Token has expired
- **40143**: Token is unrecognized
- **40144**: Invalid JWT format
- **40145**: Invalid token format
- **40146-40149**: Reserved for future token errors

All errors in this range require obtaining a new, valid token to resolve.
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-analysis.md lines 75-85 -->

## Related Resources

- [Token Authentication Documentation](https://ably.com/docs/auth/token)
- [Authentication Guide](https://ably.com/docs/auth)
- [Token Capabilities](https://ably.com/docs/auth/capabilities)
- [Auth Callbacks](https://ably.com/docs/auth/token#token-refresh)
- Related errors: [40141](./40141-token-revoked.md) through [40149](./40149-token-error.md) (specific token error types)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40140
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED:
- Analysis File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/main/output/error-codes/research/40140-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/main/src/prompts/errors/editorial-notes.md (Lines 78-84 for token expiration range guidance)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40140-token-error-unspecified.mdx (enhanced and improved)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: SSE error handling example from knowledge file lines 120-130
- Content Excluded: Internal SDK implementation details that aren't relevant to end users
- Content Added: Stale token detection based on Java SDK analysis, auth callback examples for proactive token refresh
- Recommendations Source: 
  - Token refresh: Knowledge file lines 41-56
  - Prevention strategies: Knowledge file lines 52-56
  - SSE handling: Knowledge file lines 120-130
  - Capability checking: Knowledge file lines 155-159 (Slack insights)
- Code Examples Rationale: 
  - SSE example included as it's from documentation and essential for EventSource users
  - Auth callback example added as it's the recommended pattern for automatic token renewal
  - Capability example included to show proper permission configuration
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Expired token: Knowledge file lines 21-24
  - Invalid format: Knowledge file lines 21-24  
  - Permissions: Knowledge file lines 155-159 (Slack insights)
  - Stale cached: Analysis file lines 39-41 (Java SDK stale detection)
  - Unspecified: Analysis file line 57 (protocol definition)
- Resolution Steps:
  - Step 1: Knowledge file lines 41-50 - immediate token request
  - Step 2: Knowledge file lines 41-50 - verification process
  - Step 3: Knowledge file lines 155-159 - capability configuration
  - Step 4: Knowledge file lines 52-56 - refresh implementation with auth callbacks
  - Step 5: Knowledge file lines 120-130 - SSE specific handling from docs
- Automatic Handling: Analysis file lines 61-73 - SDK-specific behaviors
- Prevention: Knowledge file lines 52-56 - proactive management strategies
- Token Error Range: Analysis file lines 75-85 - error code hierarchy
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Detailed examples of token refresh timing strategies
- Impact: Developers may not know optimal refresh intervals
- Recommendation: Add section on calculating refresh intervals based on TTL
- Severity: Low (current documentation adequate but could be enhanced)
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40140
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40140 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/main/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->