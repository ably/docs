---
title: "Error 40170 - Auth callback failure"
meta_description: "Information and troubleshooting for Ably error code 40170 - Auth callback or authUrl failure"
meta_keywords: "Ably, error, error codes, 40170, auth callback, authUrl, authentication, token request"
---

{/* Generated by: ably-os errors document-error-codes */}
{/* Repository: https://github.com/ably/ably-os */}
{/* Command: ./bin/ably-os errors document-error-codes 40170 */}
{/* Generated: 2025-11-07T01-37-30-412Z */}
{/* Sources:
     - Analysis: https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/b819713/src/prompts/errors/editorial-notes.md
*/}
{/* Key Approach: Document auth callback and authUrl failures with comprehensive troubleshooting steps for common scenarios */}
{/* Citations: Complete source attribution with line numbers available at bottom of document */}

Authentication using `authUrl` or `authCallback` failed due to issues with the authentication endpoint, response format, or callback implementation.

| Error code | HTTP status code | Category | Retryable |
| ---------- | ---------------- | -------- | --------- |
| 40170 | 401 | Client error (authentication) | No |

## Error messages

The following error messages can be returned with error code 40170:

| Message | Description |
| ------- | ----------- |
| authUrl response is missing a content-type header | The authUrl endpoint didn't include a Content-Type header in its response. |
| authUrl responded with unacceptable content-type | The authUrl endpoint returned an unsupported Content-Type header. |
| authUrl response exceeded max permitted length | The authUrl response body is larger than the maximum allowed size. |
| Unexpected error processing authURL response | Failed to parse the authUrl response, often due to invalid JSON. |
| Token request callback timed out | The auth callback didn't respond within the timeout period. |
| Token string is empty | The auth callback returned an empty string. |
| Token string exceeded max permitted length | The token string is larger than the maximum allowed size. |
| Token string was literal null/undefined | The auth callback returned the string "null" or "undefined". |
| Token was double-encoded | The token was JSON-encoded multiple times. |
| Expected token request callback to call back with a token string or token request/details object | The auth callback returned an invalid type or format. |
| auth_callback raised an exception | The auth callback function threw an error. |

## Impact

This error prevents authentication and connection establishment, affecting:

- New connections cannot be established.
- Token renewal fails, potentially disconnecting existing connections.
- Channel attachments and presence operations fail.
- All operations requiring authentication are blocked.

This is a client configuration error that will not be automatically retried. You must fix the authentication implementation before connections can succeed. The SDK will not attempt to recover as this indicates a problem with your authentication endpoint or callback implementation.

## Quick fixes

Try the following quick fixes to resolve the error:

- Ensure your authUrl endpoint returns a proper Content-Type header (`application/json`, `text/plain`, or `application/jwt`).
- Check that your auth callback returns a valid token string or token request object, not null or undefined.
- Verify your authentication endpoint is accessible and responding within the timeout period.
- Confirm the token response size is within the 64KB limit.
- Make sure you're not JSON-encoding the token response twice.

## Troubleshooting

The following are common causes and how to resolve them for error 40170:

### Missing or invalid Content-Type header

| Error messages |
| -------------- |
| authUrl response is missing a content-type header |
| authUrl responded with unacceptable content-type |

This occurs when:

- Your authUrl endpoint doesn't set a Content-Type header.
- The Content-Type header is not one of the supported types.
- Server configuration strips or modifies headers.

To resolve this:

- Set the Content-Type header to one of: `application/json`, `text/plain`, or `application/jwt`.
- Ensure your server or proxy isn't removing headers.
- Check that middleware isn't modifying the Content-Type.

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-analysis.md lines 22-29, 144-147 */}

<Code>
```javascript
// Node.js/Express example
app.get('/auth', (req, res) => {
  // Wrong: Missing Content-Type
  res.send(tokenString);

  // Correct: Set appropriate Content-Type
  res.setHeader('Content-Type', 'text/plain');
  res.send(tokenString);

  // Or for JSON responses
  res.json({ token: tokenString }); // Sets Content-Type: application/json automatically
});
```
</Code>

{/* Code source: Ably documentation pattern, included to demonstrate correct Content-Type setting */}

### Auth callback timeout

| Error messages |
| -------------- |
| Token request callback timed out after N seconds |

This occurs when:

- Your authentication endpoint is slow to respond.
- Network latency is high.
- The auth service is overloaded.

To resolve this:

- Optimize your authentication endpoint performance.
- Consider increasing the timeout if network conditions require it.
- Implement caching for token generation where appropriate.
- Check your auth server logs for performance issues.

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-analysis.md lines 41-44 */}
{/* Source: Knowledge from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-knowledge.md lines 52-56 */}

<Code>
```javascript
// Increase timeout for slow networks
const ably = new Ably.Realtime({
  authCallback: async (tokenParams, callback) => {
    // Your auth logic
  },
  realtimeRequestTimeout: 30000 // Increase timeout to 30 seconds
});
```
</Code>

### Invalid callback return value

| Error messages |
| -------------- |
| Token string is empty |
| Token string was literal null/undefined |
| Expected token request callback to call back with a token string or token request/details object |

This occurs when:

- Your auth callback returns null, undefined, or an empty string.
- The callback returns the literal string "null" or "undefined".
- The return type doesn't match what Ably expects.

To resolve this:

- Ensure your callback returns a valid token string or token request object.
- Check for error conditions before returning.
- Don't convert null values to strings.

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-analysis.md lines 46-59, 66-79 */}
{/* Source: Knowledge from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-knowledge.md lines 39-45, 171-172 */}

<Code>
```javascript
// Wrong: Returning invalid values
authCallback: async (tokenParams, callback) => {
  const token = await fetchToken();
  callback(null, token || "null"); // Don't convert null to string
}

// Correct: Proper error handling
authCallback: async (tokenParams, callback) => {
  try {
    const token = await fetchToken();
    if (!token) {
      callback(new Error('Failed to get token'));
      return;
    }
    callback(null, token);
  } catch (err) {
    callback(err);
  }
}
```
</Code>

### Token size exceeded

| Error messages |
| -------------- |
| authUrl response exceeded max permitted length |
| Token string exceeded max permitted length |

This occurs when:

- The token or response body exceeds 64KB (128KB in Rust SDK).
- Additional data is included in the response unnecessarily.
- Token contains excessive claims or metadata.

To resolve this:

- Keep token payloads minimal.
- Remove unnecessary data from the response.
- Return only the token, not additional debugging information.

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-analysis.md lines 31-34, 52-54, 147-150 */}

### Double-encoded token

| Error messages |
| -------------- |
| Token was double-encoded |

This occurs when:

- A token request object is JSON-encoded twice.
- The response is wrapped in additional JSON encoding.
- Middleware or frameworks automatically encode already-encoded data.

To resolve this:

- Ensure you're only JSON-encoding once.
- Check that your framework isn't adding extra encoding.
- Return the token request object directly, not stringified.

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-analysis.md lines 61-64 */}
{/* Source: Knowledge from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-knowledge.md line 166 */}

<Code>
```javascript
// Wrong: Double encoding
const tokenRequest = await ably.auth.createTokenRequest();
res.json(JSON.stringify(tokenRequest)); // Double encoded!

// Correct: Single encoding
const tokenRequest = await ably.auth.createTokenRequest();
res.json(tokenRequest); // Framework handles JSON encoding
```
</Code>

### Invalid JSON response

| Error messages |
| -------------- |
| Unexpected error processing authURL response |

This occurs when:

- The response claims to be JSON but contains invalid JSON.
- The response is truncated or corrupted.
- Character encoding issues corrupt the JSON.

To resolve this:

- Validate JSON before sending.
- Ensure proper character encoding (UTF-8).
- Check for truncation in proxy or server logs.
- Use a JSON validator to verify the response.

{/* Source: Analysis from https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-analysis.md lines 36-39 */}

## Related errors

The following errors are related to error code 40170:

| Error code | Description |
| ---------- | ----------- |
| [40101 - Invalid API key](/platform/errors/codes/40101) | Authentication failures when using API keys directly. |
| [40102 - Token expired](/platform/errors/codes/40102) | Token has expired and needs renewal through auth callback. |
| [40140-40149 - Token error range](/platform/errors/codes/40140) | Various token-related errors that may occur during authentication. |
| [80019 - Auth request failure](/platform/errors/codes/80019) | Connection-level authentication failures. |

## Need further help?

Contact [Ably support](https://ably.com/support) if you're still experiencing issues after trying the steps listed above.

You'll need to provide:

- Your account ID and app ID.
- The full error message including the error code.
- Steps to reproduce the issue.
- Any relevant code snippets (without any sensitive credentials).
- The SDK and version you're using.

### Resources

The following resources provide further context or assistance with this error:

- [Token authentication](/auth/token)
- [Auth callbacks](/auth/token#token-request)
- [Authentication guide](/auth)
- [AuthUrl configuration](/auth/token#auth-url)

{/* =============================================== */}
{/* INTERNAL DOCUMENTATION (NOT RENDERED) */}
{/* =============================================== */}

{/* SOURCES USED:
- Analysis File: https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/b819713/output/error-codes/research/40170-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/b819713/src/prompts/errors/editorial-notes.md
- Writing Guide: https://github.com/ably/ably-os/blob/b819713/src/prompts/shared-resources/error-code-doc-writing-guide.md
*/}

{/* CONTENT DECISIONS:
- FAQ Content Preserved: Knowledge file lines 39-89 best practices incorporated into troubleshooting
- Content Excluded: SDK-specific implementation details that would confuse users
- Recommendations Source: Based on analysis of common error scenarios across all SDKs
- Code Examples Rationale: Minimal examples included only where essential for understanding the fix
*/}

{/* ATTRIBUTION BY SECTION:
- Common Causes:
  - Content-Type issues: Analysis lines 22-29, 144-147, Knowledge lines 14-20
  - Timeout: Analysis lines 41-44, Knowledge lines 52-56
  - Invalid returns: Analysis lines 46-79, Knowledge lines 39-45
  - Token size: Analysis lines 31-34, 52-54, 147-150
  - Double encoding: Analysis lines 61-64, Knowledge line 166
  - Invalid JSON: Analysis lines 36-39
- Resolution Steps:
  - Based on SDK error handling patterns from Analysis file
  - Best practices from Knowledge file lines 80-89
  - Ably documentation patterns for auth configuration
*/}

{/* URL Validation Completed: 2025-11-07T01-37-30-412Z */}
{/* External URLs verified: 4 | Corrected: 0 | Exempted internal: 5 */}

{/* IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40170
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40170 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/b819713/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
*/}