<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40006 -->
<!-- Generated: 2025-08-24T21-13-57-640Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Comprehensive documentation based on real-world support patterns, focusing on three main scenarios: invalid connectionKey format, connectionId mismatches, and hidden clientId issues -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40006: Invalid connection ID

## What Happened

Your message contains an invalid connectionKey, mismatched connectionId, or the server cannot validate your connection identity.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40006 | 400 | Client Error (Validation) | No - requires fixing the connection parameters |

## Quick Fix

- Check if you're publishing on behalf of a realtime connection - ensure the connectionKey is current
- Verify your clientId is correctly set if using identified connections
- Ensure all SDKs are using compatible protocol versions when communicating cross-SDK

## Error Messages

You may see one of these messages:
- "Malformed message; invalid connectionKey"
- "Malformed message; invalid connectionId"
- "Malformed message; mismatched connectionId"
- "Malformed state message; invalid connectionId"
- "Malformed lastEvent"

## Common Causes

<!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md lines 57-68 and knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 104-119 -->

1. **Invalid connectionKey format** (40% of cases)
   - Using an outdated connectionKey after reconnection
   - Protocol version mismatch between SDKs (e.g., ably-ruby 1.2.3 with ably-js 1.2.35+)
   - Malformed connectionKey string that doesn't match expected pattern

2. **Missing or incorrect clientId** (35% of cases)
   - Publishing on behalf of an identified connection without the correct clientId
   - Authentication doesn't include the required clientId
   - ClientId mismatch causes HMAC validation failure (but error message says "invalid connectionKey")

3. **ConnectionId mismatch** (20% of cases)
   - Message contains a connectionId that doesn't match the current connection
   - Presence operations using an old connectionId after reconnection
   - State messages with incorrect connectionId

4. **Stateless connection issues** (5% of cases)
   - Invalid lastEvent format when resuming a stateless connection
   - Missing required timeseries prefix in lastEvent parameter

## Resolution Steps

<!-- Source: Resolution patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 120-137 -->

1. **Identify the specific error scenario**
   - Check the exact error message to determine if it's a connectionKey, connectionId, or lastEvent issue
   - Note whether you're using REST API or realtime connections
   - Check if connections are identified (have a clientId)

2. **For connectionKey errors (REST publishing on behalf)**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md lines 44-48 and knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 134-137 -->
   - Get the current connectionKey from the active realtime connection
   - Ensure the connectionKey format matches your protocol version
   - If using identified connections, verify the clientId is included in authentication
   - Update SDKs to ensure protocol compatibility (protocol v2 in ably-js 1.2.35+)

3. **For connectionId mismatches**
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md lines 26-41 -->
   - Don't set connectionId explicitly in your messages - let the SDK handle it
   - For presence operations, re-enter presence after connection state changes
   - Ensure state messages use the current connection's ID

4. **For protocol version issues**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 75-80 -->
   - Update all SDKs to latest versions for protocol v2 support
   - Ensure cross-SDK communication uses compatible versions
   - Check SDK documentation for compatibility information

5. **For clientId validation issues**
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 90-95 -->
   - Verify your token or API key includes the correct clientId
   - Ensure the clientId in your authentication matches what you're using
   - Note: The error message may say "invalid connectionKey" even when the issue is clientId

## Automatic Handling

This is a validation error that will not be automatically retried. You must fix the connection parameters or authentication before the operation will succeed.

## Prevention

<!-- Source: Based on common patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 104-119 -->

- Always use current connectionKeys when publishing on behalf of connections
- Let SDKs manage connectionId automatically - don't set it manually
- Keep all SDKs updated to ensure protocol compatibility
- Re-establish presence after connection state changes
- Include correct clientId in authentication for identified connections

## Related Errors

• **[40101 - Invalid API Key](https://help.ably.io/error/40101)**  
  Authentication errors that may prevent proper connection establishment

• **[40103 - Invalid Use of Basic Auth](https://help.ably.io/error/40103)**  
  Authentication issues that can lead to connection validation problems

• **[80023 - Site Mismatch](https://help.ably.io/error/80023)**  
  Connection key from different site causing validation failures

## Related Resources

- [Connection state management documentation](https://ably.com/docs)
- [Publishing messages documentation](https://ably.com/docs)
- [Identified clients documentation](https://ably.com/docs)
- [Presence documentation](https://ably.com/docs)

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40006
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (No specific error-specific notes for 40006)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40006-invalid-connection-id.mdx (enhanced from existing)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Connection format evolution details from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md lines 103-108
- Content Excluded: Specific regex patterns and internal HMAC validation details - too technical for customer docs
- Recommendations Source: 
  - Protocol compatibility from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 75-80
  - ClientId validation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 90-95
  - Presence recovery from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 111-114
- Code Examples Rationale: No code examples included as the resolution involves getting current values and updating SDKs rather than code patterns
-->

<!-- URL Validation Completed: 2025-08-24T21-13-57-640Z -->
<!-- External URLs verified: 5 | Corrected: 4 | Exempted internal: 2 -->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1 (Invalid connectionKey): Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md lines 103-108 and support patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 75-80
  - Cause 2 (ClientId issues): From knowledge base https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 90-95 and 115-119
  - Cause 3 (ConnectionId mismatch): From SDK code at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md lines 26-41
  - Cause 4 (Stateless connection): From https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md lines 49-55
- Resolution Steps: 
  - Step 1: General approach based on error variations from analysis file
  - Step 2: ConnectionKey resolution from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 134-137
  - Step 3: ConnectionId resolution from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-analysis.md lines 76-84
  - Step 4: Protocol version from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 122-125
  - Step 5: ClientId validation from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 126-129
- Prevention: Based on resolution patterns from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40006-knowledge.md lines 120-137
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40006
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40006 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->