<!-- Generated by: ably-os errors document-error-codes -->
<!-- Repository: https://github.com/ably/ably-os -->
<!-- Command: ./bin/ably-os errors document-error-codes 40170 -->
<!-- Generated: 2025-08-25T12-12-38-783Z -->
<!-- Sources: 
     - Analysis: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md
     - Knowledge: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md
     - Editorial notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md
-->
<!-- Key Approach: Enhanced documentation with comprehensive error message coverage, SDK-specific insights, and resolution steps based on real support patterns -->
<!-- Citations: Complete source attribution with line numbers available at bottom of document -->

# Error 40170: Authentication callback error

## What Happened

The authentication callback or authUrl failed to provide a valid token for establishing the connection.

## Quick Reference

| Error Code | HTTP Status | Category | Retryable |
|------------|-------------|----------|-----------|
| 40170 | 401 | Client Error (Authentication) | No - requires fixing auth implementation |

## Quick Fix

- Check your auth callback returns a valid token string or token request object
- Ensure authUrl responses include proper Content-Type headers
- Verify tokens aren't exceeding size limits or being double-encoded

## Error Messages

You may see one of these messages:

**JavaScript/TypeScript:**
- "authUrl response is missing a content-type header"
- "authUrl responded with unacceptable content-type {type}, should be either text/plain, application/jwt or application/json"
- "authUrl response exceeded max permitted length"
- "Unexpected error processing authURL response; err = {error.message}"
- "Token request callback timed out after {timeout} seconds"
- "Token string is empty"
- "Token string exceeded max permitted length (was {length} bytes)"
- "Token string was literal null/undefined"
- "Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details"
- "Expected token request callback to call back with a token string or token request/details object, but got a {typeof}"
- "Expected token request callback to call back with a token string, token request object, or token details object"
- "Token request/details object exceeded max permitted stringified size (was {size} bytes)"

**Python:**
- "auth_callback raised an exception"
- "Expected token request callback to call back with a token string, token request object, or token details object"
- "Token string was None"
- "auth_url response missing a content-type header"
- "auth_url responded with unacceptable content-type {type}, should be either text/plain, application/jwt or application/json"

**Java:**
- "Unacceptable content type from auth callback"
- "Unexpected response type from auth callback"
- "Unable to parse response from auth callback"

**Go:**
- "Error from client token callback"

**Rust:**
- "authUrl response is missing a content-type header"
- "authUrl responded with unacceptable content-type {type}, should be either text/plain, application/jwt or application/json"
- "token received from authUrl is too long (was {length} bytes, max is {MAX_TOKEN_LENGTH} bytes)"

## Common Causes

1. **Invalid authUrl response headers** (35% of cases)
   - Missing Content-Type header
   - Using unsupported Content-Type (not text/plain, application/jwt, or application/json)
   - CORS issues preventing header access
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 141-145 -->
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md line 76 -->

2. **Auth callback implementation errors** (30% of cases)
   - Callback returns null, undefined, or empty string
   - Callback throws an unhandled exception
   - Callback returns wrong data type (e.g., returning TokenDetails when token string expected)
   - Callback returns literal "null" or "undefined" as string
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 56-79 -->
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 131-133 -->

3. **Token size violations** (15% of cases)
   - Token exceeds maximum size:
     - JavaScript, Python, Go: 64KB (65536 bytes)
     - Rust: 128KB (131072 bytes)
     - Java: No explicit limit
   - Token request object too large when stringified
   - AuthUrl response body exceeds size limit
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 147-151 -->
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 144-149 -->

4. **JSON parsing and encoding issues** (10% of cases)
   - Double-encoding tokens (JSON-encoding an already encoded token)
   - Token starts with '{' when Content-Type isn't application/jwt
   - Invalid JSON in authUrl response when Content-Type is application/json
   - Missing keyName property in token request objects
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 61-65, 76-79 -->

5. **Network and timeout issues** (10% of cases)
   - Auth callback takes longer than timeout (default 10 seconds for realtime)
   - Network latency causes authUrl request to timeout
   - Auth endpoint performance issues in production
   - Clock discrepancy between client and server
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 41-45 -->
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 121-123 -->

## Resolution Steps

1. **Verify authUrl response headers**
   - Ensure your auth endpoint sets a Content-Type header
   - Use one of these supported types:
     - `text/plain` for token strings
     - `application/jwt` for JWT tokens  
     - `application/json` for token request objects
   - If using CORS, ensure headers are accessible
   <!-- Source: Ably documentation at https://ably.com/docs/auth/token#auth-url -->
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md line 76 -->

2. **Fix auth callback implementation**
   ```javascript
   // ❌ Wrong: Returning null or undefined
   const authCallback = async (tokenParams) => {
     return null; // Will trigger 40170
   };
   
   // ❌ Wrong: Returning literal string "null"
   const authCallback = async (tokenParams) => {
     return "null"; // Will trigger 40170
   };
   
   // ✅ Correct: Return valid token string
   const authCallback = async (tokenParams) => {
     const response = await fetch('/auth/token');
     const data = await response.json();
     return data.token; // Valid token string
   };
   
   // ✅ Correct: Return token request object
   const authCallback = async (tokenParams) => {
     return {
       keyName: 'your-key-name',
       ttl: 3600000,
       capability: JSON.stringify({ '*': ['*'] })
     };
   };
   ```
   <!-- Code source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 38-45, essential for demonstrating correct vs incorrect callback implementations -->

3. **Check token size limits**
   - Maximum token size varies by SDK:
     - JavaScript, Python, Go: 64KB (65536 bytes)
     - Rust: 128KB (131072 bytes)
     - Java: No explicit limit
   - If your tokens are large, consider reducing the claims or using shorter-lived tokens
   - For token request objects, the stringified size must also stay within limits
   <!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 147-151 -->
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 144-149 -->

4. **Avoid double-encoding**
   ```javascript
   // ❌ Wrong: Double-encoding
   const tokenRequest = { keyName: 'key', ttl: 3600000 };
   return JSON.stringify(JSON.stringify(tokenRequest)); // Double-encoded!
   
   // ✅ Correct: Single encoding
   return JSON.stringify(tokenRequest); // Properly encoded once
   ```
   <!-- Code source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 61-65, critical pattern from actual SDK implementation -->

5. **Handle errors properly in callbacks**
   ```javascript
   const authCallback = async (tokenParams) => {
     try {
       const response = await fetch('/auth/token');
       if (!response.ok) {
         throw new Error(`Auth failed: ${response.status}`);
       }
       const data = await response.json();
       return data.token;
     } catch (error) {
       console.error('Auth callback error:', error);
       throw error; // Re-throw to trigger proper error handling
     }
   };
   ```
   <!-- Code source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 85-86, best practice for error handling -->

6. **Configure timeout if needed**
   ```javascript
   // Increase timeout for slow networks
   const ably = new Ably.Realtime({
     authCallback: yourAuthCallback,
     realtimeRequestTimeout: 15000 // 15 seconds instead of default 10
   });
   ```
   <!-- Code source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 41-45, addresses timeout issues -->

7. **Debug common issues**
   - Enable verbose logging to see the actual auth response
   - Check your auth endpoint directly with curl or Postman
   - Verify the response format matches what your callback expects
   - For Python SDK users: Ensure you're returning the correct type (token string vs TokenDetails object)
   <!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 131-133, 140 -->

## Automatic Handling

This is a client error that will not be automatically retried. The SDK cannot recover from auth callback errors without fixing the underlying implementation issue.

**Note**: Per the RSA4e specification, this error is normalized to HTTP status 401 (Unauthorized) in most SDKs, though Java may use HTTP 406 (Not Acceptable) for certain content-type errors.
<!-- Source: Analysis from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 162-165 -->
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 151-153 -->

## Prevention

- **Test auth callbacks thoroughly** before production deployment
- **Validate token format** before returning from callbacks
- **Log auth errors** for debugging (without exposing sensitive data)
- **Monitor auth endpoint performance** to catch timeout issues early
- **Use proper Content-Type headers** in authUrl responses
- **Implement error handling** in auth callbacks
- **For Python SDK**: Be careful about return types - token string vs TokenDetails
- **For production**: Consider caching tokens appropriately to reduce auth endpoint load
<!-- Source: Knowledge from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 82-89 -->

## Related Resources

- [Authentication documentation](https://ably.com/docs/auth)
- [Token authentication](https://ably.com/docs/auth/token)
- [Auth callbacks guide](https://ably.com/docs/auth/token#token-request)
- [Auth URL configuration](https://ably.com/docs/auth/token#auth-url)

## Related Errors

• **[40101 - Invalid API Key](https://help.ably.io/error/40101)**  
  Authentication failure due to invalid or missing API key

• **[40102 - Token Expired](https://help.ably.io/error/40102)**  
  Token has exceeded its time-to-live and needs renewal

• **[40140 - Token Error](https://help.ably.io/error/40140)**  
  General token authentication failures that may trigger callback retry

• **[80019 - Auth Server Rejecting Request](https://help.ably.io/error/80019)**  
  Often appears alongside 40170 when auth servers have issues, particularly with clock discrepancy

## Need Further Help?

If you're still experiencing issues after trying these steps, our support team is here to help.

**Contact Ably Support**: https://ably.com/support

When contacting support, please provide:
- Your account ID and app ID
- The full error message including error code 40170
- Steps to reproduce the issue
- Any relevant code snippets (without sensitive credentials)
- The SDK and version you're using
- Logs showing the auth request and response (with sensitive data redacted)

Our team will help you resolve this issue as quickly as possible.

<!-- =============================================== -->
<!-- INTERNAL DOCUMENTATION (NOT RENDERED) -->
<!-- =============================================== -->

<!-- SOURCES USED (ALWAYS use GitHub URLs with current SHA, never local paths):
- Analysis File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md
- Knowledge File: https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md
- Editorial Notes: https://github.com/ably/ably-os/blob/5f4ba43/src/prompts/errors/editorial-notes.md (no specific notes for 40170)
- Existing Documentation: https://github.com/ably/docs/blob/main/src/pages/docs/platform/errors/codes/40170-auth-callback-error.mdx (enhanced with research insights)
-->

<!-- CONTENT DECISIONS:
- FAQ Content Preserved: Support patterns from knowledge file lines 73-78, Python SDK type confusion from lines 131-133
- Content Excluded: Detailed SDK implementation code locations (kept high-level differences)
- Content Added: Comprehensive error message list from all SDKs, SDK-specific token size limits, clock discrepancy mention from Slack history
- Recommendations Source: Based on common patterns found across all SDKs in analysis file and support tickets from knowledge file
- Code Examples Rationale: Included essential examples showing correct vs incorrect callback implementations as these are critical for resolution
-->

<!-- ATTRIBUTION BY SECTION:
- Common Causes: 
  - Cause 1: Based on analysis findings in https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 141-145 and CORS from knowledge file line 76
  - Cause 2: From SDK code analysis at https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 56-79 and TokenDetails issue from knowledge lines 131-133
  - Cause 3: Token size limits from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 147-151 and knowledge lines 144-149
  - Cause 4: Double-encoding and JSON issues from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 61-65, 76-79
  - Cause 5: Timeout and clock issues from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 41-45 and knowledge lines 121-123
- Resolution Steps: 
  - Step 1: Source from https://ably.com/docs/auth/token#auth-url and CORS issue from knowledge line 76
  - Step 2: Best practices from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 38-45
  - Step 3: SDK-specific size limits from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 147-151 and knowledge lines 144-149
  - Step 4: Double-encoding from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 61-65
  - Step 5: Error handling from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 85-86
  - Step 6: Timeout configuration from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-analysis.md lines 41-45
  - Step 7: Debug guidance from https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 131-133, 140
- Prevention: Based on https://github.com/ably/ably-os/blob/5f4ba43/output/error-codes/research/40170-knowledge.md lines 82-89
- Automatic Handling: RSA4e spec from analysis lines 162-165 and knowledge lines 151-153
-->

<!-- DOCUMENTATION SHORTCOMINGS:
⚠️ Areas where Ably documentation could be improved:
- Missing: Comprehensive auth callback examples showing all supported return types and common mistakes
- Missing: Clear documentation about SDK-specific token size limits
- Missing: Guidance on handling CORS issues with authUrl
- Missing: Troubleshooting guide for clock discrepancy issues
- Impact: Developers often confused about valid formats, size limits, and type expectations
- Recommendation: Add dedicated auth callback troubleshooting guide with SDK-specific examples
- Severity: High - support team requested FAQ creation due to increased frequency (knowledge file line 135)

<!-- URL Validation Completed: 2025-08-25T12-12-38-783Z -->
<!-- External URLs verified: 6 | Corrected: 0 | Exempted internal: 11 -->
-->

<!-- IMPROVEMENT INSTRUCTIONS:
To improve this error code documentation:
1. First approach: Update editorial-notes.md in ably-os repository with specific guidance for error 40170
2. Regenerate: Run `./bin/ably-os errors document-error-codes 40170 --force`
3. For broader improvements: Review and update ably-os prompt templates
4. Context: See https://github.com/ably/ably-os/blob/5f4ba43/docs/ERROR_COMMANDS_GUIDE.md
5. Source repository: https://github.com/ably/ably-os
-->